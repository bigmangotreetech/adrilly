{% extends "base.html" %}

{% block title %}{{ user.name }} - Dashboard - botle Sports Coaching{% endblock %}

{% block content %}
<div class="user-dashboard-page">
    <!-- Page Header -->
    <div class="page-header-modern">
        <div class="page-header-content">
            <div class="page-title-section">
                <h1 class="page-title-modern">{{ user.name }}'s Dashboard</h1>
                <p class="page-subtitle-modern">Manage your classes, payments, and family profiles</p>
            </div>
            <div class="page-actions">
                {% if session.role in ['super_admin', 'org_admin', 'center_admin', 'coach'] and user._id != session.user_id %}
                <a href="{{ url_for('web.users') }}" class="btn btn-secondary">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Users
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- User Info Card -->
    <div class="content-card-modern mb-4">
        <div class="user-info-header">
            <div class="user-avatar-section">
                {% if user.profile_picture_url %}
                <img src="{{ user.profile_picture_url }}" alt="{{ user.name }}" class="user-avatar-large">
                {% else %}
                <div class="user-avatar-large user-avatar-placeholder">
                    {{ user.name[0].upper() }}
                </div>
                {% endif %}
                <div class="user-basic-info">
                    <h2 class="user-name">{{ user.name }}</h2>
                    <p class="user-role-badge">
                        <span class="badge bg-primary">{{ user.role|replace('_', ' ')|title }}</span>
                    </p>
                </div>
            </div>
            <div class="user-contact-info">
                {% if user.email %}
                <div class="info-item">
                    <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <span>{{ user.email }}</span>
                </div>
                {% endif %}
                {% if user.phone_number %}
                <div class="info-item">
                    <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    <span>{{ user.phone_number }}</span>
                </div>
                {% endif %}
                {% if user.age %}
                <div class="info-item">
                    <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span>{{ user.age }} years old</span>
                </div>
                {% endif %}
                {% if user.gender %}
                <div class="info-item">
                    <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span>{{ user.gender|title }}</span>
                </div>
                {% endif %}
                {% if organization %}
                <div class="info-item">
                    <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <span>{{ organization.name }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Dashboard Tabs -->
    <div class="content-card-modern">
        <ul class="nav nav-tabs nav-tabs-modern" id="dashboardTabs" role="tablist">
            <li class=" " role="presentation">
                <button class="nav-link active" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming" type="button" role="tab" aria-controls="upcoming" aria-selected="true">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Upcoming Classes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="attended-tab" data-bs-toggle="tab" data-bs-target="#attended" type="button" role="tab" aria-controls="attended" aria-selected="false">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Attended Classes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="billing-tab" data-bs-toggle="tab" data-bs-target="#billing" type="button" role="tab" aria-controls="billing" aria-selected="false">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    Billing History
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="children-tab" data-bs-toggle="tab" data-bs-target="#children" type="button" role="tab" aria-controls="children" aria-selected="false">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    Child Profiles
                </button>
            </li>
        </ul>

        <div class="tab-content pt-4" id="dashboardTabContent">
            <!-- Upcoming Classes Tab -->
            <div class="tab-pane fade show active" id="upcoming" role="tabpanel" aria-labelledby="upcoming-tab">
                <div class="tab-section-header">
                    <h3>Upcoming Classes</h3>
                    <p class="text-muted">Your scheduled classes</p>
                </div>
                <div id="upcomingClassesContainer" class="loading-state">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading classes...</p>
                    </div>
                </div>
            </div>

            <!-- Attended Classes Tab -->
            <div class="tab-pane fade" id="attended" role="tabpanel" aria-labelledby="attended-tab">
                <div class="tab-section-header">
                    <h3>Attended Classes</h3>
                    <p class="text-muted">Your class attendance history</p>
                </div>
                <div id="attendedClassesContainer" class="loading-state">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading attendance...</p>
                    </div>
                </div>
            </div>

            <!-- Billing History Tab -->
            <div class="tab-pane fade" id="billing" role="tabpanel" aria-labelledby="billing-tab">
                <div class="tab-section-header">
                    <h3>Billing History</h3>
                    <p class="text-muted">Your payment records</p>
                </div>
                <div id="billingHistoryContainer" class="loading-state">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading payments...</p>
                    </div>
                </div>
            </div>

            <!-- Child Profiles Tab -->
            <div class="tab-pane fade" id="children" role="tabpanel" aria-labelledby="children-tab">
                <div class="tab-section-header">
                    <h3>Child Profiles</h3>
                    <p class="text-muted">Manage your children's profiles</p>
                    <button class="btn btn-primary" onclick="openAddChildModal()">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add Child Profile
                    </button>
                </div>
                <div id="childrenContainer" class="loading-state">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading children...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Child Modal -->
<div class="modal fade" id="addChildModal" tabindex="-1" aria-labelledby="addChildModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addChildModalLabel">Add Child Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addChildForm">
                    <div class="mb-3">
                        <label for="childName" class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="childName" required>
                    </div>
                    <div class="mb-3">
                        <label for="childAge" class="form-label">Age</label>
                        <input type="number" class="form-control" id="childAge" min="1" max="100">
                    </div>
                    <div class="mb-3">
                        <label for="childGender" class="form-label">Gender</label>
                        <select class="form-select" id="childGender">
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddChild()">Add Child</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Child Modal -->
<div class="modal fade" id="editChildModal" tabindex="-1" aria-labelledby="editChildModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editChildModalLabel">Edit Child Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editChildForm">
                    <input type="hidden" id="editChildId">
                    <div class="mb-3">
                        <label for="editChildName" class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editChildName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editChildAge" class="form-label">Age</label>
                        <input type="number" class="form-control" id="editChildAge" min="1" max="100">
                    </div>
                    <div class="mb-3">
                        <label for="editChildGender" class="form-label">Gender</label>
                        <select class="form-select" id="editChildGender">
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditChild()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<style>
.user-dashboard-page {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

/* Page Header Spacing */
.page-header-modern {
    margin-bottom: 2rem;
}

.page-header-content {
    padding: 1.5rem 0;
}

/* User Info Card Spacing */
.content-card-modern {
    margin-bottom: 2rem;
}

.user-info-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 2.5rem;
    padding: 2rem;
}

.user-avatar-section {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.user-avatar-large {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--accent-primary);
}

.user-avatar-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--accent-primary);
    color: white;
    font-size: 4rem;
    font-weight: 600;
}

.user-basic-info h2 {
    margin: 0 0 0.75rem 0;
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--text-primary);
}

.user-role-badge {
    margin: 0;
}

.user-contact-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.25rem;
    padding: 0.5rem 0;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--text-secondary);
    padding: 0.5rem 0;
}

.info-icon {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
}

/* Tabs Spacing */

.nav-tabs-modern .nav-link:hover {
    color: var(--accent-primary);
    border-bottom-color: var(--accent-primary);
    background: var(--accent-bg);
}

.nav-tabs-modern .nav-link.active {
    color: var(--accent-primary);
    border-bottom-color: var(--accent-primary);
    background: transparent;
}

.tab-icon {
    width: 1.25rem;
    height: 1.25rem;
}

/* Tab Content Spacing */
.tab-content {
    padding: 2rem 1.5rem !important;
}

.tab-section-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.tab-section-header h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
}

.tab-section-header p {
    margin: 0.5rem 0 0 0;
}

/* Cards Spacing */
.class-card, .payment-card, .child-card {
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    transition: all 0.2s;
}

.class-card:last-child, .payment-card:last-child, .child-card:last-child {
    margin-bottom: 0;
}

.class-card:hover, .payment-card:hover, .child-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.class-header, .payment-header, .child-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.25rem;
    gap: 1rem;
}

.class-title, .child-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 0.75rem 0;
}

.payment-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 0.5rem 0;
}

.payment-amount {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--accent-primary);
    margin-top: 0.5rem;
}

.class-meta, .payment-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
    padding-top: 0.5rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    font-weight: 500;
    white-space: nowrap;
}

.status-present {
    background: #d4edda;
    color: #155724;
}

.status-late {
    background: #fff3cd;
    color: #856404;
}

.status-absent {
    background: #f8d7da;
    color: #721c24;
}

.status-paid {
    background: #d4edda;
    color: #155724;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-overdue {
    background: #f8d7da;
    color: #721c24;
}

/* Empty State Spacing */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-secondary);
}

.empty-state svg {
    width: 4rem;
    height: 4rem;
    margin-bottom: 1.5rem;
    opacity: 0.5;
}

.empty-state h4 {
    margin: 1rem 0 0.75rem 0;
    font-size: 1.25rem;
    color: var(--text-primary);
}

.empty-state p {
    margin: 0;
    font-size: 0.95rem;
}

/* Loading State */
.loading-state {
    padding: 2rem;
}

/* Badge Spacing */
.badge {
    padding: 0.35rem 0.75rem;
    margin-right: 0.5rem;
}

.badge:last-child {
    margin-right: 0;
}

/* Button Group Spacing */
.btn-group {
    gap: 0.5rem;
}

.btn-group .btn {
    margin-left: 0;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .user-dashboard-page {
        padding: 1rem;
    }
    
    .page-header-content {
        padding: 1rem 0;
    }
    
    .user-info-header {
        flex-direction: column;
        padding: 1.5rem;
        gap: 1.5rem;
    }
    
    .user-contact-info {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .nav-tabs-modern {
        padding: 0 0.5rem;
    }
    
    .nav-tabs-modern .nav-link {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
    }
    
    .tab-content {
        padding: 1.5rem 0.75rem !important;
    }
    
    .tab-section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .class-card, .payment-card, .child-card {
        padding: 1.25rem;
        margin-bottom: 1rem;
    }
    
    .empty-state {
        padding: 3rem 1rem;
    }
}
</style>

<script>
const userId = '{{ user._id }}';
let addChildModal, editChildModal;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals
    addChildModal = new bootstrap.Modal(document.getElementById('addChildModal'));
    editChildModal = new bootstrap.Modal(document.getElementById('editChildModal'));
    
    // Load all data immediately on page load
    loadUpcomingClasses();
    loadAttendedClasses();
    loadBillingHistory();
    loadChildren();
});

function loadUpcomingClasses() {
    fetch(`/api/users/${userId}/upcoming-classes`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('upcomingClassesContainer');
            if (data.classes && data.classes.length > 0) {
                container.innerHTML = data.classes.map(cls => `
                    <div class="class-card">
                        <div class="class-header">
                            <div>
                                <h4 class="class-title">${cls.title}</h4>
                                <span class="badge bg-secondary">${cls.sport}</span>
                                ${cls.level ? `<span class="badge bg-info">${cls.level}</span>` : ''}
                            </div>
                            <span class="status-badge" style="background: #e7f3ff; color: #0066cc;">Scheduled</span>
                        </div>
                        <div class="class-meta">
                            <div class="meta-item">
                                <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                ${new Date(cls.scheduled_at).toLocaleDateString()}
                            </div>
                            <div class="meta-item">
                                <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                ${new Date(cls.scheduled_at).toLocaleTimeString()}
                            </div>
                            ${cls.duration_minutes ? `
                                <div class="meta-item">
                                    ${cls.duration_minutes} minutes
                                </div>
                            ` : ''}
                            ${cls.coach_name ? `
                                <div class="meta-item">
                                    <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    ${cls.coach_name}
                                </div>
                            ` : ''}
                            ${cls.location && cls.location.name ? `
                                <div class="meta-item">
                                    <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    ${cls.location.name}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <h4>No Upcoming Classes</h4>
                        <p>You don't have any scheduled classes yet.</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading classes:', error);
            document.getElementById('upcomingClassesContainer').innerHTML = `
                <div class="alert alert-danger">Failed to load upcoming classes. Please try again.</div>
            `;
        });
}

function loadAttendedClasses() {
    fetch(`/api/users/${userId}/attended-classes`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('attendedClassesContainer');
            if (data.classes && data.classes.length > 0) {
                container.innerHTML = data.classes.map(cls => `
                    <div class="class-card">
                        <div class="class-header">
                            <div>
                                <h4 class="class-title">${cls.title}</h4>
                                <span class="badge bg-secondary">${cls.sport}</span>
                                ${cls.level ? `<span class="badge bg-info">${cls.level}</span>` : ''}
                            </div>
                            <span class="status-badge status-${cls.attendance_status.toLowerCase()}">${cls.attendance_status}</span>
                        </div>
                        <div class="class-meta">
                            <div class="meta-item">
                                <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                ${new Date(cls.scheduled_at).toLocaleDateString()}
                            </div>
                            ${cls.coach_name ? `
                                <div class="meta-item">
                                    <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    ${cls.coach_name}
                                </div>
                            ` : ''}
                        </div>
                        ${cls.notes ? `<p class="mt-2 mb-0 text-muted"><small>Notes: ${cls.notes}</small></p>` : ''}
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h4>No Attendance Records</h4>
                        <p>Your class attendance history will appear here.</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading attended classes:', error);
            document.getElementById('attendedClassesContainer').innerHTML = `
                <div class="alert alert-danger">Failed to load attendance records. Please try again.</div>
            `;
        });
}

function loadBillingHistory() {
    fetch(`/api/users/${userId}/payments`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('billingHistoryContainer');
            if (data.payments && data.payments.length > 0) {
                container.innerHTML = data.payments.map(payment => {
                    const dueDate = payment.due_date ? new Date(payment.due_date).toLocaleDateString() : 'N/A';
                    const paidDate = payment.paid_date ? new Date(payment.paid_date).toLocaleDateString() : null;
                    const amount = payment.amount ? `₹${payment.amount.toLocaleString()}` : '₹0';
                    const status = payment.status || 'pending';
                    
                    return `
                        <div class="payment-card">
                            <div class="payment-header">
                                <div>
                                    <h4 class="payment-title">${payment.description || 'Payment'}</h4>
                                    <div class="payment-amount">${amount}</div>
                                </div>
                                <span class="status-badge status-${status.toLowerCase()}">${status}</span>
                            </div>
                            <div class="payment-meta">
                                <div class="meta-item">
                                    <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    Due: ${dueDate}
                                </div>
                                ${paidDate ? `
                                    <div class="meta-item">
                                        <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Paid: ${paidDate}
                                    </div>
                                ` : ''}
                                ${payment.payment_method ? `
                                    <div class="meta-item">
                                        Method: ${payment.payment_method}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <h4>No Payment Records</h4>
                        <p>Your billing history will appear here.</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading billing history:', error);
            document.getElementById('billingHistoryContainer').innerHTML = `
                <div class="alert alert-danger">Failed to load billing history. Please try again.</div>
            `;
        });
}

function loadChildren() {
    fetch(`/api/users/${userId}/children`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('childrenContainer');
            if (data.children && data.children.length > 0) {
                container.innerHTML = data.children.map(child => `
                    <div class="child-card">
                        <div class="child-header">
                            <div>
                                <h4 class="child-name">${child.name}</h4>
                                <div class="d-flex gap-2 mt-2">
                                    ${child.age ? `<span class="badge bg-info">${child.age} years old</span>` : ''}
                                    ${child.gender ? `<span class="badge bg-secondary">${child.gender}</span>` : ''}
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="editChild('${child._id}', '${child.name}', ${child.age || 'null'}, '${child.gender || ''}')">
                                    <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteChild('${child._id}', '${child.name.replace(/'/g, "\\'")}')">
                                    <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <h4>No Child Profiles</h4>
                        <p>Add your children's profiles to manage their classes and activities.</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading children:', error);
            document.getElementById('childrenContainer').innerHTML = `
                <div class="alert alert-danger">Failed to load child profiles. Please try again.</div>
            `;
        });
}

function openAddChildModal() {
    document.getElementById('addChildForm').reset();
    addChildModal.show();
}

function submitAddChild() {
    const name = document.getElementById('childName').value.trim();
    const age = document.getElementById('childAge').value;
    const gender = document.getElementById('childGender').value;
    
    if (!name) {
        alert('Please enter a name');
        return;
    }
    
    const data = { name };
    if (age) data.age = age;
    if (gender) data.gender = gender;
    
    fetch(`/api/users/${userId}/children`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            addChildModal.hide();
            loadChildren();
            alert('Child profile added successfully!');
        }
    })
    .catch(error => {
        console.error('Error adding child:', error);
        alert('Failed to add child profile. Please try again.');
    });
}

function editChild(id, name, age, gender) {
    document.getElementById('editChildId').value = id;
    document.getElementById('editChildName').value = name;
    document.getElementById('editChildAge').value = age || '';
    document.getElementById('editChildGender').value = gender || '';
    editChildModal.show();
}

function submitEditChild() {
    const childId = document.getElementById('editChildId').value;
    const name = document.getElementById('editChildName').value.trim();
    const age = document.getElementById('editChildAge').value;
    const gender = document.getElementById('editChildGender').value;
    
    if (!name) {
        alert('Please enter a name');
        return;
    }
    
    const data = { name };
    if (age) data.age = age;
    if (gender) data.gender = gender;
    
    fetch(`/api/users/${userId}/children/${childId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            editChildModal.hide();
            loadChildren();
            alert('Child profile updated successfully!');
        }
    })
    .catch(error => {
        console.error('Error updating child:', error);
        alert('Failed to update child profile. Please try again.');
    });
}

function deleteChild(id, name) {
    if (!confirm(`Are you sure you want to delete ${name}'s profile?`)) {
        return;
    }
    
    fetch(`/api/users/${userId}/children/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            loadChildren();
            alert('Child profile deleted successfully!');
        }
    })
    .catch(error => {
        console.error('Error deleting child:', error);
        alert('Failed to delete child profile. Please try again.');
    });
}
</script>
{% endblock %}

