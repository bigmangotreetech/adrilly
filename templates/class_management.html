{% extends "base.html" %}

{% block title %}Class Management{% endblock %}

{% block content %}

<!-- View Class Modal -->
<div class="modal fade" id="viewClassModal" tabindex="-1" aria-labelledby="viewClassModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewClassModalLabel">Class Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="classDetailsContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading class details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Student Management Modal -->
<div class="modal fade" id="studentManagementModal" tabindex="-1" aria-labelledby="studentManagementModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentManagementModalLabel">Manage Students</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Note:</strong> Changes here are one-time additions/removals for this specific class only.
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <strong>Class:</strong> <span id="studentMgmtClassName"></span>
                    </div>
                </div>

                <!-- Student Search Section -->
                <div class="mb-3">
                    <label class="form-label">
                        Add Students
                    </label>

                    <div class="students-search-section">
                        <input type="text" class="form-control" id="student_search"
                            placeholder="Search students by name, phone, or email..." autocomplete="off">
                        <div class="students-dropdown" id="studentsDropdown" style="display: none;">
                            <!-- Students will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Currently Enrolled Students -->
                <div class="mb-3">
                    <label class="form-label">
                        Students in class:
                    </label>

                    <div class="assigned-students-list mb-3" id="assignedStudentsList">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-muted" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="text-muted mt-2">Loading enrolled students...</div>
                        </div>
                    </div>
                    <div class="students-summary d-flex justify-content-between align-items-center">
                        <span class="badge bg-secondary" id="studentsCount">0 students assigned</span>
                        <span id="capacityIndicator"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStudentChanges()">
                    <i class="bi bi-check"></i>
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Class Modal -->
<div class="modal fade" id="cancelClassModal" tabindex="-1" aria-labelledby="cancelClassModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelClassModalLabel">Cancel Class</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="cancelClassForm">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Warning:</strong> This will cancel the class and notify all enrolled students.
                    </div>

                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="mb-2"><strong>Class:</strong> <span id="cancelClassName"></span></div>
                            <div><strong>Scheduled:</strong> <span id="cancelClassTime"></span></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="cancel_reason" class="form-label">
                            Cancellation Reason <span class="text-danger">*</span>
                        </label>
                        <textarea name="reason" id="cancel_reason" class="form-control" rows="3" required
                            placeholder="Enter reason for cancellation"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="cancel_type" class="form-label">Cancellation Type</label>
                        <select name="cancellation_type" id="cancel_type" class="form-select">
                            <option value="manual">Manual</option>
                            <option value="weather">Weather</option>
                            <option value="facility">Facility Issue</option>
                            <option value="emergency">Emergency</option>
                            <option value="holiday">Holiday</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" name="refund_required" class="form-check-input" id="refund_required">
                            <label class="form-check-label" for="refund_required">Refund Required</label>
                        </div>
                        <div class="form-text">Check if students should receive a refund for this class.</div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" name="send_notifications" class="form-check-input"
                                id="send_notifications" checked>
                            <label class="form-check-label" for="send_notifications">Send Notifications</label>
                        </div>
                        <div class="form-text">Uncheck to cancel without sending WhatsApp notifications.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-x-circle"></i>
                        Cancel Class
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrCodeModalLabel">
                    <i class="bi bi-qr-code me-2"></i>
                    QR Code for Attendance
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <h6 class="fw-bold">Class: <span id="qrClassName" class="text-primary"></span></h6>
                    <small class="text-muted">Valid until: <span id="qrValidUntil"></span></small>
                </div>
                
                <div class="qr-code-container mb-3">
                    <div id="qrCodeDisplay" class="d-flex justify-content-center">
                        <!-- QR code will be generated here -->
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <small>
                        <strong>Instructions:</strong> Students can scan this QR code with the mobile app to mark their attendance.
                        The QR code is valid for 15 minutes from generation.
                    </small>
                </div>
                
                <div class="mt-3 d-none">
                    <h6>QR Code String:</h6>
                    <div class="bg-light p-2 rounded">
                        <small id="qrStringDisplay" class="font-monospace text-break"></small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="printQRCode()">
                    <i class="bi bi-printer me-1"></i>
                    Print
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="downloadQRCode()">
                    <i class="bi bi-download me-1"></i>
                    Download
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Cancel Confirmation Panel -->
<div id="bulkCancelPanel" class="bulk-cancel-panel">
    <div class="bulk-cancel-content">
        <div class="bulk-cancel-header">
            <div class="bulk-cancel-info">
                <div class="bulk-cancel-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <div class="bulk-cancel-text">
                    <h5 class="bulk-cancel-title">Cancel Selected Classes</h5>
                    <div class="bulk-cancel-subtitle">
                        <span class="selected-count-badge" id="selectedClassCount">0</span>
                        classes selected for cancellation
                    </div>
                </div>
            </div>
            <button type="button" class="bulk-cancel-close" onclick="closeBulkCancelPanel()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="bulkCancelForm" class="bulk-cancel-form">
            <div class="bulk-cancel-form-row">
                <div class="bulk-cancel-input-group">
                    <label for="bulk_reason" class="bulk-cancel-label">Cancellation Reason</label>
                    <input type="text" name="reason" id="bulk_reason" class="bulk-cancel-input" 
                           placeholder="Enter reason for cancellation..." required>
                </div>
                
                <div class="bulk-cancel-options">
                    <div class="bulk-cancel-checkbox">
                        <input type="checkbox" name="send_notifications" class="bulk-cancel-checkbox-input" 
                               id="bulk_send_notifications" checked>
                        <label class="bulk-cancel-checkbox-label" for="bulk_send_notifications">
                            <span class="bulk-cancel-checkbox-text">Send Notifications</span>
                            <small class="bulk-cancel-checkbox-desc">WhatsApp alerts to students</small>
                        </label>
                    </div>
                    
                    <div class="bulk-cancel-checkbox">
                        <input type="checkbox" name="refund_required" class="bulk-cancel-checkbox-input" 
                               id="bulk_refund_required">
                        <label class="bulk-cancel-checkbox-label" for="bulk_refund_required">
                            <span class="bulk-cancel-checkbox-text">Refund Required</span>
                            <small class="bulk-cancel-checkbox-desc">Process refunds</small>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="bulk-cancel-actions">
                <button type="button" class="bulk-cancel-btn bulk-cancel-btn-secondary" onclick="closeBulkCancelPanel()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    Cancel
                </button>
                <button type="submit" class="bulk-cancel-btn bulk-cancel-btn-danger">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Cancel <span id="footerSelectedCount">0</span> Classes
                </button>
            </div>
        </form>
    </div>
</div>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
        </div>
        <div class="btn-group" role="group">
            <button class="btn btn-outline-secondary" onclick="refreshClasses()">
                <i class="bi bi-arrow-clockwise"></i>
                Refresh
            </button>
            <button id="bulkSelectToggle" class="btn btn-primary" onclick="toggleBulkSelectMode()">
                <i class="bi bi-check2-square"></i>
                <span id="bulkSelectText">Select Classes</span>
            </button>
            <button id="cancelSelectedButton" class="btn btn-danger" onclick="showBulkCancelPanel()"
                style="display: none;">
                <i class="bi bi-x-circle"></i>
                Cancel <span id="headerSelectedCount">0</span> Selected
            </button>
        </div>


    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show"
        role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="">
        <div class="card-header d-flex mb-5">
            <h5 class="card-title">
                <i class="bi bi-clock me-2"></i>
                Upcoming Classes
            </h5>
            <!-- Create div for date range -->
            <div class="ms-auto">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-calendar-range"></i>
                    </span>
                    <input type="date" id="startDate" class="form-control" value="{{ start_date }}" onchange="applyDateFilter()">
                    <span class="input-group-text">to</span>
                    <input type="date" id="endDate" class="form-control" value="{{ end_date }}" onchange="applyDateFilter()">
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if classes %}
            <div class="table-container-modern">
                <table class="table-modern" id="classesTable">
                    <thead class="table-header-sticky">
                        <tr>
                            <th class="bulk-select-column" style="display: none; width: 40px;">
                                <div class="th-content">
                                    <input type="checkbox" id="selectAllClasses" class="form-check-input"
                                        onchange="toggleSelectAll()">
                                </div>
                            </th>
                            <th class="sortable" data-sort="title">
                                <div class="th-content">
                                    <span>Class</span>
                                    <svg class="sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                    </svg>
                                </div>
                            </th>
                            <th class="sortable" data-sort="scheduled_at">
                                <div class="th-content">
                                    <span>Date & Time</span>
                                    <svg class="sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                    </svg>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <span>Students</span>
                                </div>
                            </th>
                            <th class="sortable" data-sort="status">
                                <div class="th-content">
                                    <span>Status</span>
                                    <svg class="sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                    </svg>
                                </div>
                            </th>
                            <th class="actions-column">
                                <div class="th-content">
                                    <svg class="actions-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z">
                                        </path>
                                    </svg>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for class in classes %}
                        <tr class="table-row-modern" id="class-{{ class._id }}">
                            <td class="bulk-select-column" style="display: none;">
                                {% if class.status in ['scheduled', 'ongoing'] %}
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input class-select-checkbox"
                                        data-class-id="{{ class._id }}" data-class-title="{{ class.title }}"
                                        onchange="updateBulkSelectCount()">
                                </div>
                                {% endif %}
                            </td>
                            <td class="class-cell">
                                <div class="class-info-modern">
                                    <div class="class-avatar">
                                        {{ class.title[0].upper() }}
                                    </div>
                                    <div class="class-details">
                                        <div class="class-name">{{ class.title }}</div>
                                        {% if class.sport %}
                                        <div class="class-meta">{{ class.sport }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="date-info">
                                    <div class="date-primary">{{ class.scheduled_at.strftime('%A, %b %d, %Y') }}</div>
                                    <div class="date-secondary">{{ class.scheduled_at.strftime('%I:%M %p') }}</div>
                                </div>
                            </td>
                            <td>
                                <span class="student-count">
                                    {{ class.student_ids|length + class.group_ids|length }} students
                                </span>
                            </td>
                            <td>
                                <span class="status-pill status-{{ class.status }}">
                                    {{ class.status.title() }}
                                </span>
                            </td>
                            <td class="actions-cell">
                                <div class="actions-dropdown">
                                    <!-- bootstrap dropdown -->
                                    <div class="dropdown">
                                        <button class="action-item dropdown-toggle" type="button"
                                            id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                            <svg class="actions-dots" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z">
                                                </path>
                                            </svg>
                                        </button>
                                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                            <li>
                                                {% if class.status in ['scheduled', 'ongoing'] %}
                                                <button class="action-item"
                                                    onclick="showStudentManagementModal('{{ class._id }}', '{{ class.title }}')">
                                                    <svg class="action-icon" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                                        </path>
                                                    </svg>
                                                    Manage Students
                                                </button>
                                                {% endif %}
                                            </li>
                                            <li>
                                                <div class="action-divider"></div>
                                            </li>
                                            <li>
                                                {% if class.status in ['scheduled', 'ongoing', 'cancelled'] %}
                                                <button class="action-item"
                                                    onclick="showStudentManagementModal('{{ class._id }}', '{{ class.title }}')">
                                                    <svg class="action-icon" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 616 0z">
                                                        </path>
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                                                        </path>
                                                    </svg>
                                                    View Details
                                                </button>
                                                {% endif %}
                                            </li>
                                            <li>
                                                {% if class.status in ['scheduled', 'ongoing'] %}
                                                <button class="action-item"
                                                    onclick="generateQRCode('{{ class._id }}', '{{ class.title }}')">
                                                    <svg class="action-icon" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M3 4a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 13a1 1 0 011-1h3a1 1 0 011 1v7a1 1 0 01-1 1H4a1 1 0 01-1-1v-7zM12 4a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1V4zM9 9h1v1H9V9zM12 12h1v1h-1v-1zM15 12h1v1h-1v-1zM18 12h1v1h-1v-1zM9 15h1v1H9v-1zM12 15h1v1h-1v-1zM15 15h1v1h-1v-1zM18 15h1v1h-1v-1zM9 18h1v1H9v-1zM12 18h1v1h-1v-1zM15 18h1v1h-1v-1zM18 18h1v1h-1v-1z">
                                                        </path>
                                                    </svg>
                                                    Generate QR Code
                                                </button>
                                                {% endif %}
                                            </li>
                                            <li>
                                                {% if class.status in ['scheduled', 'ongoing'] %}
                                                <button class="action-item danger" data-class-id="{{ class._id }}"
                                                    data-class-title="{{ class.title }}"
                                                    data-class-time="{{ class.scheduled_at.strftime('%b %d, %Y at %I:%M %p') }}"
                                                    onclick="showCancelModal(this.dataset.classId, this.dataset.classTitle, this.dataset.classTime)">
                                                    <svg class="action-icon" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z">
                                                        </path>
                                                    </svg>
                                                    Cancel Class
                                                </button>
                                                {% endif %}
                                            </li>
                                        </div>
                                    </div>

                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-calendar-x display-1 text-muted"></i>
                <h4 class="mt-3">No Upcoming Classes</h4>
                <p class="text-muted">No classes are scheduled for the next 7 days.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Cancellations -->
    {% if cancelled_classes %}
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Recent Cancellations (Last 30 Days)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Class</th>
                            <th>Date</th>
                            <th>Cancelled</th>
                            <th>Reason</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for class in cancelled_classes %}
                        <tr>
                            <td>{{ class.title }}</td>
                            <td>{{ class.scheduled_at }}</td>
                            <td>{{ class.cancelled_at if class.cancelled_at else 'N/A' }}</td>
                            <td>{{ class.cancellation_reason or 'No reason provided' }}</td>
                            <td>
                                <span class="text-muted">
                                    {{ class.cancellation_type or 'manual' }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
    /* Custom Actions Dropdown (matching users.html) */
    .actions-cell {
        width: 60px;
        padding: var(--spacing-sm);
    }

    .actions-dropdown {
        position: relative;
        display: inline-block;
        z-index: 1;
    }
    
    .actions-dropdown:hover,
    .actions-dropdown.show {
        z-index: 10000;
    }

    .actions-button {
        background: none;
        border: none;
        padding: var(--spacing-xs);
        border-radius: var(--radius-md);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        transition: all var(--transition-fast);
        color: var(--text-muted);
    }

    .actions-button:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .actions-dots {
        width: 16px;
        height: 16px;
    }

    .actions-menu {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: var(--spacing-xs);
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        z-index: 9999;
        min-width: 180px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: all var(--transition-fast);
        overflow: visible;
    }

    .actions-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .action-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-md);
        background: none;
        border: none !important;
        text-align: left;
        font-size: 0.875rem;
        color: var(--text-primary);
        cursor: pointer;
        transition: all var(--transition-fast);
        border-bottom: 1px solid var(--border-secondary);
    }

    .action-item:last-child {
        border-bottom: none;
    }

    .action-item:hover {
        background: var(--bg-hover);
    }

    .action-item.danger {
        color: var(--error);
    }

    .action-item.danger:hover {
        background: var(--error-50);
        color: var(--error);
    }

    .action-icon {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
    }

    .action-divider {
        height: 1px;
        background: var(--border-primary);
        margin: var(--spacing-xs) 0;
    }

    /* Student Search Styles */
    .students-search-section {
        position: relative;
        margin-bottom: 1rem;
    }

    .students-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
    }

    .student-search-item {
        padding: 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid var(--border-primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .student-search-item:last-child {
        border-bottom: none;
    }

    .student-search-item:hover {
        background: var(--bg-hover);
    }

    .student-search-name {
        font-weight: 500;
        color: var(--text-primary);
    }

    .student-search-meta {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    .assigned-students-list {
        min-height: 60px;
        margin-bottom: 1rem;
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        padding: 1rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .assigned-student-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: var(--bg-tertiary);
        border-radius: 4px;
        border: 1px solid var(--border-secondary);
    }

    .assigned-student-item:last-child {
        margin-bottom: 0;
    }

    .assigned-student-name {
        font-weight: 500;
        color: var(--text-primary);
    }

    .remove-student-btn {
        background: var(--error);
        color: white;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .remove-student-btn:hover {
        background: var(--error);
        opacity: 0.8;
    }

    /* Class Table Specific Styles (matching users.html) */
    .class-cell {
        padding: var(--spacing-md) var(--spacing-sm);
    }

    .class-info-modern {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .class-avatar {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-full);
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .class-details {
        min-width: 0;
        flex: 1;
    }

    .class-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.875rem;
        line-height: 1.25;
        margin-bottom: 0.125rem;
    }

    .class-meta {
        font-size: 0.75rem;
        color: var(--text-muted);
        line-height: 1.25;
    }

    .date-info {
        display: flex;
        flex-direction: column;
        gap: 0.125rem;
    }

    .date-primary {
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.875rem;
        line-height: 1.25;
    }

    .date-secondary {
        font-size: 0.75rem;
        color: var(--text-muted);
        line-height: 1.25;
    }

    .student-count {
        font-size: 0.875rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    .status-pill {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-full);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .status-pill.status-scheduled {
        background: var(--success-100);
        color: var(--success-700);
        border: 1px solid var(--success-200);
    }

    .status-pill.status-ongoing {
        background: var(--primary-100);
        color: var(--primary-700);
        border: 1px solid var(--primary-200);
    }

    .status-pill.status-cancelled {
        background: var(--error-100);
        color: var(--error-700);
        border: 1px solid var(--error-200);
    }

    .status-pill.status-completed {
        background: var(--secondary-100);
        color: var(--secondary-700);
        border: 1px solid var(--secondary-200);
    }
    
    /* Bulk Cancel Panel Styles */
    .bulk-cancel-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-card);
        border-top: 1px solid var(--border-primary);
        box-shadow: var(--shadow-xl);
        z-index: 1050;
        display: none;
        transform: translateY(100%);
        transition: transform 0.3s ease;
    }

    .bulk-cancel-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--spacing-lg);
    }

    .bulk-cancel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-lg);
    }

    .bulk-cancel-info {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .bulk-cancel-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-full);
        background: var(--warning-100);
        color: var(--warning-700);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .bulk-cancel-icon svg {
        width: 24px;
        height: 24px;
    }

    .bulk-cancel-text {
        min-width: 0;
    }

    .bulk-cancel-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 var(--spacing-xs) 0;
    }

    .bulk-cancel-subtitle {
        font-size: 0.875rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .selected-count-badge {
        background: var(--primary);
        color: white;
        padding: 0.125rem 0.5rem;
        border-radius: var(--radius-full);
        font-size: 0.75rem;
        font-weight: 600;
    }

    .bulk-cancel-close {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-md);
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all var(--transition-fast);
    }

    .bulk-cancel-close:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .bulk-cancel-close svg {
        width: 20px;
        height: 20px;
    }

    .bulk-cancel-form {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
    }

    .bulk-cancel-form-row {
        display: flex;
        gap: var(--spacing-xl);
        align-items: flex-start;
    }

    .bulk-cancel-input-group {
        flex: 1;
        min-width: 300px;
    }

    .bulk-cancel-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
    }

    .bulk-cancel-input {
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid var(--border-input);
        border-radius: var(--radius-md);
        background: var(--bg-input);
        color: var(--text-primary);
        font-size: 0.875rem;
        transition: all var(--transition-fast);
    }

    .bulk-cancel-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-100);
    }

    .bulk-cancel-options {
        display: flex;
        gap: var(--spacing-lg);
        align-items: flex-start;
    }

    .bulk-cancel-checkbox {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-sm);
    }

    .bulk-cancel-checkbox-input {
        margin-top: 0.125rem;
        accent-color: var(--primary);
    }

    .bulk-cancel-checkbox-label {
        display: flex;
        flex-direction: column;
        cursor: pointer;
    }

    .bulk-cancel-checkbox-text {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-primary);
        line-height: 1.25;
    }

    .bulk-cancel-checkbox-desc {
        font-size: 0.75rem;
        color: var(--text-muted);
        line-height: 1.25;
        margin-top: 0.125rem;
    }

    .bulk-cancel-actions {
        display: flex;
        gap: var(--spacing-md);
        justify-content: flex-end;
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--border-secondary);
    }

    .bulk-cancel-btn {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm) var(--spacing-lg);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-fast);
        border: 1px solid transparent;
    }

    .bulk-cancel-btn svg {
        width: 16px;
        height: 16px;
    }

    .bulk-cancel-btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border-color: var(--border-primary);
    }

    .bulk-cancel-btn-secondary:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .bulk-cancel-btn-danger {
        background: var(--error);
        color: white;
        border-color: var(--error);
    }

    .bulk-cancel-btn-danger:hover {
        background: var(--error-600);
        border-color: var(--error-600);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .bulk-cancel-content {
            padding: var(--spacing-md);
        }

        .bulk-cancel-form-row {
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .bulk-cancel-input-group {
            min-width: auto;
        }

        .bulk-cancel-options {
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .bulk-cancel-actions {
            flex-direction: column-reverse;
        }

        .bulk-cancel-btn {
            width: 100%;
            justify-content: center;
        }
    }
    
    /* Fix dropdown visibility in table */
    .table-container-modern {
        overflow: visible !important;
    }
    
    .table-container-modern .table-modern {
        overflow: visible !important;
    }
    
    /* Ensure dropdown appears above table */
    .actions-dropdown .dropdown-menu {
        z-index: 10000 !important;
        position: absolute !important;
    }
</style>

<script>
    let currentClassId = null;
    let currentClassData = null;
    let bulkSelectMode = false;
    let selectedClasses = [];

    // Student management variables (matching schedule page pattern)
    window.availableStudents = [];
    window.assignedStudents = [];
    window.originalAssignedStudents = [];

    // Bootstrap Modal Functions
    function openViewClassModal(classId) {
        currentClassId = classId;
        const modalElement = document.getElementById('viewClassModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            loadClassDetails(classId);
        } else {
            console.error('Modal element not found');
        }
    }

    function loadClassDetails(classId) {
        fetch(`/api/classes/${classId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('classDetailsContent').innerHTML =
                        `<div class="alert alert-danger">Error: ${data.error}</div>`;
                } else {
                    currentClassData = data.class;
                    displayClassDetails(data.class);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('classDetailsContent').innerHTML =
                    `<div class="alert alert-danger">Error loading class details</div>`;
            });
    }

    function displayClassDetails(classData) {
        const scheduledDate = new Date(classData.scheduled_at);
        const content = `
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Class Title</h6>
                        <p class="card-text">${classData.title}</p>
            </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Status</h6>
                        <span class="badge bg-${classData.status === 'scheduled' ? 'success' : classData.status === 'ongoing' ? 'info' : 'danger'}">
                    ${classData.status.charAt(0).toUpperCase() + classData.status.slice(1)}
                </span>
            </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Date & Time</h6>
                        <p class="card-text">${scheduledDate.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        })}</p>
                        <small class="text-muted">${scheduledDate.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        })}</small>
                </div>
            </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Duration</h6>
                        <p class="card-text">${classData.duration_minutes || 60} minutes</p>
            </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Coach</h6>
                        <p class="card-text">${classData.coach ? classData.coach.name : 'Not assigned'}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Student Count</h6>
                        <p class="card-text">${classData.student_count || 0} students</p>
                    </div>
                </div>
            </div>
            ${classData.sport ? `
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Sport</h6>
                        <p class="card-text">${classData.sport}</p>
                    </div>
                </div>
            </div>
            ` : ''}
            ${classData.level ? `
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Level</h6>
                        <p class="card-text">${classData.level}</p>
                    </div>
                </div>
            </div>
            ` : ''}
        </div>
        ${classData.notes ? `
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Notes</h6>
                        <p class="card-text">${classData.notes}</p>
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
        ${classData.location && Object.keys(classData.location).length > 0 ? `
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Location</h6>
                        <p class="card-text">${classData.location.name || classData.location.address || 'Location details available'}</p>
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
    `;

        document.getElementById('classDetailsContent').innerHTML = content;
    }

    // Student Management Functions (matching schedule page pattern)
    function showStudentManagementModal(classId, className) {
        currentClassId = classId;
        document.getElementById('studentMgmtClassName').textContent = className;

        // Reset student assignments
        window.assignedStudents = [];
        window.originalAssignedStudents = [];

        const modalElement = document.getElementById('studentManagementModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            loadStudentData(classId);
        } else {
            console.error('Student management modal element not found');
        }
    }

    function loadStudentData(classId) {
        fetch(`/api/classes/${classId}/students`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading students:', data.error);
                } else {
                    console.log(data);
                    // Convert to the expected format and store
                    const students = (data.students || []).map(student => ({
                        _id: student._id,
                        name: student.name,
                        phone_number: student.phone_number || '',
                        email: student.email || ''
                    }));

                    console.log(students);

                    window.assignedStudents = [...students];
                    window.originalAssignedStudents = [...students];
                    updateAssignedStudentsList();
                    updateStudentsCount();
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // Student search functions (matching schedule page)
    function handleStudentSearch(e) {
        const searchTerm = e.target.value.toLowerCase().trim();

        if (searchTerm.length === 0) {
            hideStudentDropdown();
            return;
        }

        // Filter from window.availableStudents which is loaded from the template
        const filteredStudents = window.availableStudents.filter(student =>
            student.name.toLowerCase().includes(searchTerm) ||
            (student.phone_number && student.phone_number.toLowerCase().includes(searchTerm)) ||
            (student.email && student.email.toLowerCase().includes(searchTerm))
        ).filter(student =>
            !window.assignedStudents.find(assigned => assigned._id === student._id)
        );

        populateStudentDropdown(filteredStudents);
        showStudentDropdown();
    }

    function populateStudentDropdown(students) {
        const dropdown = document.getElementById('studentsDropdown');
        dropdown.innerHTML = '';

        if (students.length === 0) {
            dropdown.innerHTML = '<div class="student-search-item"><div class="student-search-name">No students found</div></div>';
            return;
        }

        students.forEach(student => {
            const item = document.createElement('div');
            item.className = 'student-search-item';
            item.innerHTML = `
                <div>
                    <div class="student-search-name">${student.name}</div>
                    <div class="student-search-meta">${student.phone_number || ''} ${student.email ? '• ' + student.email : ''}</div>
                </div>
            `;
            item.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Prevent blur event
                addStudentToAssignment(student);
            });
            dropdown.appendChild(item);
        });
    }

    function showStudentDropdown() {
        document.getElementById('studentsDropdown').style.display = 'block';
    }

    function hideStudentDropdown() {
        document.getElementById('studentsDropdown').style.display = 'none';
    }

    function hideStudentDropdownDelayed() {
        setTimeout(hideStudentDropdown, 150); // Delay to allow click events
    }

    function addStudentToAssignment(student) {
        // Check if already assigned
        if (window.assignedStudents.find(assigned => assigned._id === student.id)) {
            return;
        }

        // Convert student format to match expected structure
        const assignedStudent = {
            _id: student._id,
            name: student.name,
            phone_number: student.phone_number || '',
            email: student.email || ''
        };

        window.assignedStudents.push(assignedStudent);
        updateAssignedStudentsList();
        updateStudentsCount();

        // Clear search
        document.getElementById('student_search').value = '';
        hideStudentDropdown();
    }

    function removeStudentFromAssignment(studentId) {
        window.assignedStudents = window.assignedStudents.filter(student => student._id !== studentId);
        updateAssignedStudentsList();
        updateStudentsCount();
    }

    function updateAssignedStudentsList() {
        const container = document.getElementById('assignedStudentsList');
        container.innerHTML = '';

        if (window.assignedStudents.length === 0) {
            container.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-muted); font-style: italic;">No students assigned</div>';
            return;
        }

        window.assignedStudents.forEach(student => {
            const item = document.createElement('div');
            item.className = 'assigned-student-item';
            item.innerHTML = `
                <div class="assigned-student-name" data-student-id="${student._id}">${student.name}</div>
                <button class="remove-student-btn" onclick="removeStudentFromAssignment('${student._id}')">Remove</button>
            `;
            container.appendChild(item);
        });
    }

    function updateStudentsCount() {
        const countElement = document.getElementById('studentsCount');
        const count = window.assignedStudents.length;
        countElement.textContent = `${count} student${count !== 1 ? 's' : ''} assigned`;
    }

    function saveStudentChanges() {
        const currentStudentIds = window.assignedStudents.map(s => s._id);
        const originalStudentIds = window.originalAssignedStudents.map(s => s._id);

        // Check if there are any changes
        const added = currentStudentIds.filter(id => !originalStudentIds.includes(id));
        const removed = originalStudentIds.filter(id => !currentStudentIds.includes(id));

        if (added.length === 0 && removed.length === 0) {
            alert('No changes to save');
            return;
        }

        const data = {
            student_ids: currentStudentIds
        };

        fetch(`/api/classes/${currentClassId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Student changes saved successfully!');
                    const modalElement = document.getElementById('studentManagementModal');
                    if (modalElement) {
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }
                    }
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving changes. Please try again.');
            });
    }

    // Cancel Modal Functions
    function showCancelModal(classId, className, classTime) {
        currentClassId = classId;
        document.getElementById('cancelClassName').textContent = className;
        document.getElementById('cancelClassTime').textContent = classTime;

        const modalElement = document.getElementById('cancelClassModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        } else {
            console.error('Cancel modal element not found');
        }
    }

    // Bulk Selection Functions
    function toggleBulkSelectMode() {
        bulkSelectMode = !bulkSelectMode;

        const toggleButton = document.getElementById('bulkSelectToggle');
        const toggleText = document.getElementById('bulkSelectText');
        const bulkColumns = document.querySelectorAll('.bulk-select-column');

        if (bulkSelectMode) {
            bulkColumns.forEach(col => col.style.display = 'table-cell');
            toggleButton.classList.add('btn-success');
            toggleText.textContent = 'Cancel Selection';
        } else {
            bulkColumns.forEach(col => col.style.display = 'none');
            toggleButton.classList.remove('btn-success');
            toggleText.textContent = 'Select Classes';
            selectedClasses = [];
            document.querySelectorAll('.class-select-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllClasses').checked = false;
            const cancelButton = document.getElementById('cancelSelectedButton');
            cancelButton.style.display = 'none';
            closeBulkCancelPanel();
        }
    }

    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllClasses');
        const classCheckboxes = document.querySelectorAll('.class-select-checkbox');

        classCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });

        updateBulkSelectCount();
    }

    function updateBulkSelectCount() {
        const checkedBoxes = document.querySelectorAll('.class-select-checkbox:checked');
        selectedClasses = Array.from(checkedBoxes).map(cb => ({
            id: cb.dataset.classId,
            title: cb.dataset.classTitle
        }));

        const count = selectedClasses.length;
        const headerCount = document.getElementById('headerSelectedCount');
        const cancelButton = document.getElementById('cancelSelectedButton');

        if (headerCount) headerCount.textContent = count;

        if (count > 0) {
            cancelButton.style.display = 'inline-block';
        } else {
            cancelButton.style.display = 'none';
            closeBulkCancelPanel();
        }

        const panelCount = document.getElementById('selectedClassCount');
        const footerCount = document.getElementById('footerSelectedCount');
        if (panelCount) panelCount.textContent = count;
        if (footerCount) footerCount.textContent = count;
    }

    function showBulkCancelPanel() {
        const panel = document.getElementById('bulkCancelPanel');
        panel.style.display = 'block';
        setTimeout(() => {
            panel.style.transform = 'translateY(0)';
        }, 10);
    }

    function closeBulkCancelPanel() {
        const panel = document.getElementById('bulkCancelPanel');
        panel.style.transform = 'translateY(100%)';
        setTimeout(() => {
            panel.style.display = 'none';
            document.getElementById('bulkCancelForm').reset();
        }, 300);
    }

    function applyDateFilter() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!startDate || !endDate) {
            return;
        }

        // Reload the page with the date filters as GET params
        const url = new URL(window.location.href);
        url.searchParams.set('start_date', startDate);
        url.searchParams.set('end_date', endDate);
        window.location.href = url.toString();
    }

    function refreshClasses() {
        // Reload the page without any filter params
        const url = new URL(window.location.href);
        url.searchParams.delete('start_date');
        url.searchParams.delete('end_date');
        window.location.href = url.toString();
    }

    // Action dropdown functions (matching users.html)
    function toggleActionDropdown(button) {
        const dropdown = button.closest('.actions-dropdown');
        const menu = dropdown.querySelector('.actions-menu');
        const isOpen = menu.classList.contains('show');

        // Close all other dropdowns
        document.querySelectorAll('.actions-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });

        // Toggle current dropdown
        if (!isOpen) {
            menu.classList.add('show');
        }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function (e) {
        if (!e.target.closest('.actions-dropdown')) {
            document.querySelectorAll('.actions-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
        }
    });

    // Form Event Listeners
    document.addEventListener('DOMContentLoaded', function () {
        // Custom dropdowns are handled by toggleActionDropdown function
        console.log('Class management page initialized');

        // Initialize student data from template
        const studentsData = document.getElementById('studentsData');
        if (studentsData) {
            window.availableStudents = JSON.parse(studentsData.textContent);
        }

        // Initialize student search functionality
        const studentSearchInput = document.getElementById('student_search');
        if (studentSearchInput) {
            studentSearchInput.addEventListener('input', handleStudentSearch);
            studentSearchInput.addEventListener('focus', showStudentDropdown);
            studentSearchInput.addEventListener('blur', hideStudentDropdownDelayed);
        }

        // Cancel Class Form
        const cancelClassForm = document.getElementById('cancelClassForm');
        if (cancelClassForm) {
            cancelClassForm.addEventListener('submit', function (e) {
                e.preventDefault();
                if (!currentClassId) return;

                const formData = new FormData(this);
                const data = {
                    reason: formData.get('reason'),
                    cancellation_type: formData.get('cancellation_type'),
                    refund_required: formData.has('refund_required'),
                    send_notifications: formData.has('send_notifications')
                };

                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Cancelling...';
                submitBtn.disabled = true;

                fetch(`/api/classes/${currentClassId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                        } else {
                            alert('Class cancelled successfully!');
                            const modalElement = document.getElementById('cancelClassModal');
                            if (modalElement) {
                                const modal = bootstrap.Modal.getInstance(modalElement);
                                if (modal) {
                                    modal.hide();
                                }
                            }
                            location.reload();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error cancelling class. Please try again.');
                    })
                    .finally(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    });
            });
        }

        // Bulk Cancel Form
        const bulkCancelForm = document.getElementById('bulkCancelForm');
        if (bulkCancelForm) {
            bulkCancelForm.addEventListener('submit', function (e) {
                e.preventDefault();

                if (selectedClasses.length === 0) {
                    alert('Please select at least one class to cancel.');
                    return;
                }

                const formData = new FormData(this);
                const data = {
                    class_ids: selectedClasses.map(cls => cls.id),
                    reason: formData.get('reason'),
                    refund_required: formData.has('refund_required'),
                    send_notifications: formData.has('send_notifications')
                };

                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Cancelling...';
                submitBtn.disabled = true;

                fetch('/api/classes/bulk-cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                        } else {
                            const results = data.results;
                            alert(`Cancelled ${results.successful.length} classes successfully. ${results.failed.length} failed.`);
                            closeBulkCancelPanel();
                            selectedClasses = [];
                            document.querySelectorAll('.class-select-checkbox').forEach(cb => cb.checked = false);
                            document.getElementById('selectAllClasses').checked = false;
                            updateBulkSelectCount();
                            setTimeout(() => location.reload(), 1000);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error with bulk cancellation. Please try again.');
                    })
                    .finally(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    });
            });
        }
    });

    // QR Code Generation Function
    function generateQRCode(classId, className) {
        fetch(`/generate-qr/${classId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showQRCodeModal(data, className);
            } else {
                alert(`Error: ${data.error || 'Failed to generate QR code'}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating QR code. Please try again.');
        });
    }

    function showQRCodeModal(qrData, className) {
        const modal = document.getElementById('qrCodeModal');
        const classNameElement = document.getElementById('qrClassName');
        const validUntilElement = document.getElementById('qrValidUntil');
        const qrCodeDisplay = document.getElementById('qrCodeDisplay');
        const qrStringDisplay = document.getElementById('qrStringDisplay');
        
        // Set class name
        classNameElement.textContent = className;
        
        // Set validity information
        const validUntil = new Date(qrData.validUntil);
        validUntilElement.textContent = validUntil.toLocaleString();
        
        // Clear previous QR code
        qrCodeDisplay.innerHTML = '';
        qrStringDisplay.textContent = qrData.qrString;
        
        // Display QR code image from backend
        if (qrData.qrImageBase64) {
            const qrImg = document.createElement('img');
            qrImg.src = qrData.qrImageBase64;
            qrImg.alt = 'QR Code for ' + className;
            qrImg.style.maxWidth = '256px';
            qrImg.style.height = 'auto';
            qrImg.className = 'border rounded';
            qrCodeDisplay.appendChild(qrImg);
        } else {
            // Fallback to showing just the string if image generation failed
            qrCodeDisplay.innerHTML = `
                <div class="alert alert-warning">
                    <strong>QR Code Image Unavailable</strong><br>
                    <small>Use the QR code string below:</small><br>
                    <code style="word-break: break-all;">${qrData.qrString}</code>
                </div>
            `;
        }
        
        // Show the modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }

    function downloadQRCode() {
        const qrImg = document.querySelector('#qrCodeDisplay img');
        if (qrImg && qrImg.src) {
            const link = document.createElement('a');
            link.download = `qr-code-${new Date().getTime()}.png`;
            link.href = qrImg.src;
            link.click();
        } else {
            alert('QR code image not available for download');
        }
    }

    function printQRCode() {
        const qrContent = document.getElementById('qrCodeModal').querySelector('.modal-body').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>QR Code</title>
                    <style>
                        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
                        .qr-code { margin: 20px 0; }
                        .alert { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; }
                    </style>
                </head>
                <body>
                    ${qrContent}
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }
</script>

<!-- Students data for JavaScript -->
<script id="studentsData" type="application/json">{{ students|tojson|safe }}</script>
{% endblock %}

{% block scripts %}
<!-- No additional scripts needed - QR code is generated server-side -->
{% endblock %}