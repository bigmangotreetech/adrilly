{% extends "base.html" %}

{% block title %}Schedule Management - {{ center.name }} - botle Sports Coaching{% endblock %}

{% block content %}
<div class="schedule-page">
    <div class="page-header-modern">
        <div class="page-header-content">
            <div class="page-title-section">
                <div class="page-title-with-back">
                    <button class="back-button" onclick="window.location.href='/centers'" title="Back to Centers">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                            </path>
                        </svg>
                    </button>
                    <div class="page-title-content">
                        <h1 class="page-title-modern">{{ center.name }} - Schedule</h1>
                    </div>
                </div>
            </div>
            <div class="page-actions d-flex flex-wrap">


                <button class="btn btn-secondary-modern" onclick="openDayTimeSlotsModal()">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Create Time Slots
                </button>
                <button class="btn btn-secondary-modern" onclick="openActivityModal()">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Create Activity
                </button>
                <button class="btn btn-accent-modern" id="signupLinkBtn" onclick="startScheduleSelection()">
                    <i class="bi bi-link-45deg"></i> Create Sign Up Link
                </button>
                <a href="{{ url_for('web.view_signup_links') }}" class="btn btn-outline-modern">
                    <i class="bi bi-list-ul"></i> View All Links
                </a>
                <!-- <button class="btn btn-primary-modern" onclick="saveSchedule()">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Save Changes
                </button> -->
            </div>
        </div>
    </div>

    <div class="sign-up-link-instruction ms-5 d-flex">
        <div>
            <div class="instruction-title text-warning pb-1">
                <p>Click on one or more classes to create a sign up link</p>
            </div>
            <div class="selected-classes-summary mb-3">
                Selected Classes: <span id="selectedClassCount">0</span>
            </div>
        </div>
        <button class="btn btn-primary ms-auto my-auto" id="" onclick="confirmScheduleSelection()">
            <i class="bi bi-link-45deg"></i> Confirm and create
        </button>

    </div>



    <div class="schedule-container">
        <!-- Activities Sidebar -->
        <div class="activities-sidebar" id="activitiesSidebar">
            <div class="sidebar-header">
                <div class="sidebar-title-section">
                    <h3>Available Activities</h3>
                    <button class="btn-collapse" onclick="toggleActivitiesSidebar()" id="collapseBtn"
                        title="Collapse sidebar">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                        </svg>
                    </button>
                </div>
                <button class="btn btn-sm btn-outline" onclick="openActivityModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                </button>
            </div>
            <div class="activities-list" id="activitiesList">
                {% for activity in activities %}
                <div class="activity-card" draggable="true" data-activity-id="{{ activity._id }}"
                    data-activity-name="{{ activity.name }}" data-activity-type="{{ activity.type }}"
                    data-activity-color="{{ activity.color }}" style="border-left: 4px solid {{ activity.color }};">
                    <div class="activity-header">
                        <span class="activity-name">{{ activity.name }}</span>
                        <div class="activity-actions">

                            <button class="activity-edit-btn" onclick="openEditActivityModal('{{ activity._id }}')"
                                title="Edit activity">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="12" height="12">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                    </path>
                                </svg>
                            </button>
                            <button class="activity-delete-btn"
                                onclick="deleteActivity('{{ activity._id }}', '{{ activity.name }}')"
                                title="Delete activity">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="12" height="12">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="activity-meta">
                        <span class="activity-type">{{ activity.type }}</span>
                        {% if activity.max_participants %}
                        <span class="activity-capacity">Max: {{ activity.max_participants }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Main Schedule Grid -->
        <div class="schedule-main">
            <div class="d-flex border-bottom">
                <h5 class="text-muted p-3">Schedule (Day vs Slot time)</h5>
                <div class="view-toggle-container ms-auto my-auto">
                    <div class="view-toggle">
                        <button class="toggle-btn active" id="weeklyViewBtn" onclick="switchToWeeklyView()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2">
                                </path>
                            </svg>
                            Weekly
                        </button>
                        <button class="toggle-btn" id="monthlyViewBtn" onclick="switchToMonthlyView()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                </path>
                            </svg>
                            Monthly
                        </button>
                    </div>
                </div>
            </div>
            <div class="schedule-grid-container">
                <!-- Time Slots Header -->
                <div class="time-slots-header">
                    <div class="day-header-cell"></div>
                    {% for slot in time_slots %}
                    <div class="time-slot-header" data-slot-id="{{ slot._id }}"
                        data-slot-duration="{{ slot.duration_minutes }}">
                        <div class="slot-time">{{ slot.start_time }}</div>
                        <div class="slot-duration"></div>
                        <button class="slot-delete-btn" onclick="deleteTimeSlot('{{ slot._id }}')"
                            title="Delete time slot">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="12" height="12">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    {% endfor %}
                </div>

                <!-- Schedule Grid -->
                <div class="schedule-grid" id="scheduleGrid">
                    {% set days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                    {% for day in days %}
                    {% set day_index = loop.index0 %}
                    <div class="schedule-row" data-day="{{ day_index }}">
                        <div class="day-cell clickable-day"
                            onclick="openDayTimeSlotsModal({{ day_index }}, '{{ day }}')">
                            <span class="day-name">{{ day }}</span>
                            <span class="day-hint">Click to add time slots</span>
                        </div>
                        {% for slot in time_slots %}
                        <div class="schedule-cell" data-day="{{ day_index }}" data-slot-id="{{ slot._id }}"
                            ondrop="handleDrop(event)" ondragover="handleDragOver(event)"
                            ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
                            <!-- Schedule items will be dynamically inserted here -->
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Day Time Slots Modal -->
<div id="dayTimeSlotsModal" class="modal fade" tabindex="-1" aria-labelledby="dayTimeSlotsTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="dayTimeSlotsTitle">Add Time Slots for Monday</h5>
                    <p class="text-muted mb-0">Select start and end time for time slots</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="dayTimeSlotsForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="day_start_time" class="form-label">
                                Start Time <span class="text-danger">*</span>
                            </label>
                            <input type="time" class="form-control" id="day_start_time" name="start_time" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="day_end_time" class="form-label">
                                End Time <span class="text-danger">*</span>
                            </label>
                            <input type="time" class="form-control" id="day_end_time" name="end_time" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="slot_duration_minutes" class="form-label">
                                Slot Duration (minutes) <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="slot_duration_minutes" name="duration_minutes" required>
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60" selected>60 minutes</option>
                                <option value="90">90 minutes</option>
                                <option value="120">120 minutes</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="slot_break_minutes" class="form-label">
                                Break Between Slots (minutes)
                            </label>
                            <select class="form-select" id="slot_break_minutes" name="break_minutes">
                                <option value="0">No break</option>
                                <option value="5">5 minutes</option>
                                <option value="10" selected>10 minutes</option>
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes</option>
                            </select>
                        </div>
                    </div>

                    <div class="time-slots-preview mb-3" id="timeSlotsPreview">
                        <h6>Preview of Time Slots:</h6>
                        <div class="preview-slots" id="previewSlots">
                            <!-- Generated slots will appear here -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-secondary" onclick="generateTimeSlotPreview()">
                            <i class="bi bi-eye"></i> Preview Time Slots
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="createTimeSlotsBtn">
                        <i class="bi bi-plus-lg"></i> Create Time Slots
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Activity Modal -->
<div id="activityModal" class="modal fade" tabindex="-1" aria-labelledby="activityModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="activityModalTitle">Add Activity</h5>
                    <p class="text-muted mb-0" id="activityModalSubtitle">Create a new activity for scheduling</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="activityForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="activity_name" class="form-label">
                                Activity Name <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="activity_name" name="name" required
                                placeholder="e.g., Yoga, Football, Tennis">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="default_coach_id" class="form-label">
                                Coach <span class="text-danger">*</span>
                            </label>

                            <select class="form-select" id="default_coach_id" name="default_coach_id" required>
                                <option value="">Select coach</option>
                                {% for coach in coaches %}
                                <option value="{{ coach._id }}">{{ coach.name }}</option>
                                {% endfor %}
                            </select>


                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="activity_price" class="form-label">Price for one time booking (in INR)</label>
                            <input type="number" class="form-control" id="activity_price" name="price" value="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="activity_description" class="form-label">Description</label>
                        <textarea class="form-control" id="activity_description" name="description" rows="3"
                            placeholder="Brief description of the activity"></textarea>
                    </div>
                    <div class="row">

                        <div class="col-md-6 mb-3">
                            <label for="activity_capacity" class="form-label">Max Participants</label>
                            <input type="number" class="form-control" id="activity_capacity" name="max_participants"
                                min="1" max="100" value="20">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="activity_level" class="form-label">Skill Level</label>
                            <select class="form-select" id="activity_level" name="skill_level">
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                                <option value="all">All Levels</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="activity_color" class="form-label">Color</label>
                            <div class="color-picker-container">
                                <input type="color" class="form-control color-input" id="activity_color" name="color"
                                    value="#3B82F6">
                                <div class="color-presets mt-2">
                                    <button type="button" class="btn btn-sm color-preset me-1" data-color="#3B82F6"
                                        style="background: #3B82F6; width: 30px; height: 30px;"></button>
                                    <button type="button" class="btn btn-sm color-preset me-1" data-color="#10B981"
                                        style="background: #10B981; width: 30px; height: 30px;"></button>
                                    <button type="button" class="btn btn-sm color-preset me-1" data-color="#F59E0B"
                                        style="background: #F59E0B; width: 30px; height: 30px;"></button>
                                    <button type="button" class="btn btn-sm color-preset me-1" data-color="#EF4444"
                                        style="background: #EF4444; width: 30px; height: 30px;"></button>
                                    <button type="button" class="btn btn-sm color-preset me-1" data-color="#8B5CF6"
                                        style="background: #8B5CF6; width: 30px; height: 30px;"></button>
                                    <button type="button" class="btn btn-sm color-preset" data-color="#EC4899"
                                        style="background: #EC4899; width: 30px; height: 30px;"></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Is Bookable Toggle -->
                    <div class="mb-3">
                        <label class="form-label d-flex align-items-center justify-content-between">
                            <span>
                                Bookable
                                <small class="text-muted d-block">Allow users to book classes for this activity</small>
                            </span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="activity_is_bookable" name="is_bookable" checked style="width: 3rem; height: 1.5rem; cursor: pointer;">
                            </div>
                        </label>
                    </div>

                    <!-- Custom Feedback Metrics Section -->
                    <div class="mb-3">
                        <label class="form-label">
                            Custom Feedback Metrics
                            <small class="text-muted d-block">Add metrics that coaches will use to evaluate students in
                                this activity</small>
                        </label>
                        <div id="feedbackMetricsList" class="mb-2">
                            <!-- Feedback metrics will be dynamically added here -->
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newFeedbackMetric"
                                placeholder="e.g., Technique, Teamwork, Endurance" maxlength="50">
                            <button type="button" class="btn btn-outline-primary" onclick="addFeedbackMetric()">
                                <i class="bi bi-plus-lg"></i> Add Metric
                            </button>
                        </div>
                        <small class="text-muted">Examples: Technique, Stamina, Teamwork, Accuracy, Speed,
                            Flexibility</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="activitySubmitBtn">
                        <i class="bi bi-plus-lg"></i> <span id="activitySubmitBtnText">Add Activity</span>
                    </button>

                </div>
            </form>
        </div>
    </div>
</div>

<!-- Schedule Item Detail Modal -->
<div id="scheduleItemModal" class="modal fade" tabindex="-1" aria-labelledby="scheduleItemTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="scheduleItemTitle">Edit Schedule Item</h5>
                    <p class="text-muted mb-0">Update activity assignment details</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="scheduleItemForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="schedule_coach" class="form-label">Assigned Coach</label>
                        <select class="form-select" id="schedule_coach" name="coach_id">
                            <option value="">Select coach</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="schedule_capacity" class="form-label">Max Participants</label>
                        <input type="number" class="form-control" id="schedule_capacity" name="max_participants" min="1"
                            max="100">
                    </div>
                    

                    <!-- Students Assignment Section -->
                    <div class="mb-3">
                        <label class="form-label">
                            Assigned Students
                        </label>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <small id="assignmentTypeDesc">Student assigned from this page will be assigned to all
                                recurring sessions of this activity and time slot. To add or remove a student one time,
                                please visit class management page.</small>
                        </div>

                        <div class="students-assignment-container">
                            <div class="students-search-section mb-3">
                                <input type="text" class="form-control" id="student_search"
                                    placeholder="Search students by name..." autocomplete="off">
                                <div class="students-dropdown" id="studentsDropdown" style="display: none;">
                                    <!-- Students will be populated here -->
                                </div>
                            </div>
                            <div class="assigned-students-list mb-3" id="assignedStudentsList">
                                <!-- Assigned students will appear here -->
                            </div>
                            <div class="students-summary d-flex justify-content-between align-items-center">
                                <span class="badge bg-secondary" id="studentsCount">0 students assigned</span>
                                <span id="capacityIndicator"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="schedule_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="schedule_notes" name="notes" rows="3"
                            placeholder="Additional notes or instructions"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-danger" onclick="removeScheduleItem()" id="removeItemBtn">
                        <i class="bi bi-trash"></i> Remove
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> Update
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Monthly View Container (Initially Hidden) -->
<div class="monthly-view-container" id="monthlyViewContainer" style="display: none;">
    <div class="monthly-calendar">
        <div class="d-flex border-bottom mb-3">
            <h5 class="text-muted p-3">Monthly View</h5>
            <div class="view-toggle-container ms-auto my-auto">
                <div class="view-toggle">
                    <button class="toggle-btn " id="weeklyViewBtn" onclick="switchToWeeklyView()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2">
                            </path>
                        </svg>
                        Weekly
                    </button>
                    <button class="toggle-btn active" id="monthlyViewBtn" onclick="switchToMonthlyView()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                        Monthly
                    </button>
                </div>
            </div>
        </div>
        <div class="calendar-header">
            <button class="month-nav-btn" id="prevMonthBtn" onclick="navigateMonth(-1)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <h3 class="current-month" id="currentMonthLabel">January 2024</h3>
            <button class="month-nav-btn" id="nextMonthBtn" onclick="navigateMonth(1)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        </div>

        <div class="calendar-grid" id="calendarGrid">
            <!-- Calendar dates will be generated by JavaScript -->
        </div>
    </div>

    <!-- Day Details Tooltip -->
    <div class="day-tooltip" id="dayTooltip" style="display: none;">
        <div class="tooltip-header"></div>
        <div class="tooltip-content"></div>
    </div>
</div>

<!-- Activity Selection Modal -->
<div id="activitySelectionModal" class="modal fade" tabindex="-1" aria-labelledby="activitySelectionTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="activitySelectionTitle">Select Activity</h5>
                    <p class="text-muted mb-0" id="activitySelectionSubtitle">Choose an activity to schedule</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="activity-selection-grid" id="activitySelectionGrid">
                    <!-- Activities will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block head %}
<style>
    .instruction-title p {
        color: var(--text-warning) !important;
    }

    .sign-up-link-instruction {
        position: fixed;
        bottom: -100px;
        right: 0;
        background: var(--bg-card);
        padding: 1rem;
        border: 1px solid var(--border-primary);
        z-index: 1000;
        width: calc(100% - 220px);
        transition: all 0.3s ease;
    }

    .sign-up-link-instruction.show {
        bottom: 0;
    }

    /* Schedule page styles */
    .schedule-page {
        padding: 0;
        min-height: 100vh;
        background: var(--bg-secondary);
    }

    .page-header-modern {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border-primary);
        padding: 1.5rem;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .page-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 0 auto;
    }

    .page-title-section {
        flex: 1;
    }

    .page-title-modern {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 0.25rem 0;
    }

    .page-subtitle-modern {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin: 0;
    }

    .page-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    /* View toggle styles */
    .view-toggle-container {
        padding-right: 1rem;
        margin-right: 0.5rem;
    }

    .view-toggle {
        display: flex;
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 0.25rem;
        border: 1px solid var(--border-primary);
    }

    .toggle-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .toggle-btn svg {
        width: 1rem;
        height: 1rem;
    }

    .toggle-btn:hover {
        color: var(--text-primary);
        background: var(--bg-hover);
    }

    .toggle-btn.active {
        background: var(--accent-primary);
        color: white;
    }

    .toggle-btn.active:hover {
        background: var(--accent-hover);
    }

    .btn-primary-modern,
    .btn-secondary-modern {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.875rem;
    }

    .btn-primary-modern {
        background: var(--accent-primary);
        color: var(--text-inverse);
    }

    .btn-primary-modern:hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
    }

    .btn-secondary-modern {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-primary);
    }

    .btn-secondary-modern:hover {
        background: var(--bg-hover);
    }

    .btn-icon {
        width: 16px;
        height: 16px;
    }

    /* Schedule container */
    .schedule-container {
        display: flex;
        width: 100%;
        margin: 0 auto;
        gap: 1.5rem;
        min-height: calc(100vh - 120px);
        overflow: hidden;
    }

    /* Activities sidebar */
    .activities-sidebar {
        width: 300px;
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border-primary);
        height: fit-content;
        position: sticky;
        align-self: flex-start;
        transition: all 0.3s ease;
    }

    .activities-sidebar.collapsed {
        width: 60px;
        overflow: hidden;
    }

    .activities-sidebar.collapsed .activities-list {
        display: none;
    }

    .activities-sidebar.collapsed .sidebar-header {
        padding: 1rem;
    }

    .activities-sidebar.collapsed .sidebar-title-section h3 {
        display: none;
    }

    .activities-sidebar.collapsed .btn-outline {
        display: none;
    }

    .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .sidebar-title-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-collapse {
        background: transparent;
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        padding: 0.375rem;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-collapse:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .btn-collapse svg {
        transition: transform 0.3s ease;
    }

    .activities-sidebar.collapsed .btn-collapse svg {
        transform: rotate(180deg);
    }

    /* Monthly view styles */
    .monthly-view-container {
        padding: 1.5rem 2rem;
        background: var(--bg-secondary);
        min-height: calc(100vh - 200px);
        margin-top: 0;
    }

    .monthly-calendar {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border-primary);
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .month-nav-btn {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .month-nav-btn:hover {
        background: var(--bg-hover);
    }

    .month-nav-btn svg {
        width: 1.25rem;
        height: 1.25rem;
        color: var(--text-primary);
    }

    .current-month {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: var(--border-primary);
        border-radius: 8px;
        overflow: hidden;
    }

    .calendar-day-header {
        background: var(--bg-secondary);
        padding: 1rem;
        text-align: center;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .calendar-day {
        background: var(--bg-card);
        padding: 1rem;
        min-height: 120px;
        position: relative;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .calendar-day:hover {
        background: var(--bg-hover);
    }

    .calendar-day.other-month {
        background: var(--bg-tertiary);
        color: var(--text-muted);
    }

    .calendar-day.today {
        background: var(--accent-primary);
        color: white;
    }

    .calendar-day-number {
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .calendar-day-classes {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .calendar-class-indicator {
        width: 100%;
        height: 4px;
        border-radius: 2px;
        opacity: 0.8;
    }

    .calendar-class-count {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    /* Day tooltip styles */
    .day-tooltip {
        position: fixed;
        background: var(--bg-card, #ffffff);
        border: 1px solid var(--border-primary, #e5e7eb);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 1rem;
        z-index: 9999;
        max-width: 300px;
        min-width: 250px;
        pointer-events: none;
    }

    .tooltip-header {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-primary);
        padding-bottom: 0.5rem;
    }

    .tooltip-content {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .tooltip-class {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--bg-secondary);
        border-radius: 6px;
    }

    .tooltip-class-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .tooltip-class-info {
        flex: 1;
    }

    .tooltip-class-name {
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .tooltip-class-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .tooltip-class-meta {
        margin-top: 0.25rem;
    }

    .schedule-type-badge {
        font-size: 0.625rem;
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .schedule-type-badge.specific {
        background: var(--accent-primary, #3B82F6);
        color: white;
    }

    .schedule-type-badge.recurring {
        background: var(--success, #10B981);
        color: white;
    }

    /* Students tooltip styles */
    .students-tooltip {
        position: absolute;
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 1rem;
        z-index: 1000;
        min-width: 200px;
        max-width: 300px;
        top: 100%;
        left: 0;
        margin-top: 0.5rem;
    }

    .students-tooltip-header {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-primary);
        padding-bottom: 0.5rem;
    }

    .students-tooltip-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .student-tooltip-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background: var(--bg-secondary);
        border-radius: 6px;
    }

    .student-name {
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .student-role {
        font-size: 0.75rem;
        color: var(--text-secondary);
        background: var(--bg-tertiary);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }

    .students-indicator:hover .students-tooltip {
        display: block !important;
    }

    /* Schedule item capacity styles */
    .schedule-item-capacity {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.25rem;
        font-size: 0.75rem;
    }

    .capacity-text {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .spots-left {
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.625rem;
    }

    .spots-left.available {
        background: var(--success);
        color: white;
    }

    .spots-left.warning {
        background: var(--warning);
        color: white;
    }

    .spots-left.full {
        background: var(--danger);
        color: white;
    }

    .sidebar-header h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .activities-list {
        padding: 1rem;
        max-height: 600px;
        overflow-y: auto;
    }

    .activity-card {
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        cursor: grab;
        transition: all 0.2s ease;
        user-select: none;
    }

    .activity-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .activity-card:active {
        cursor: grabbing;
        transform: scale(0.98);
    }

    .activity-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .activity-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .activity-duration {
        font-size: 0.75rem;
        color: var(--text-muted);
        background: var(--bg-tertiary);
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
    }

    .activity-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .activity-type {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: capitalize;
    }

    .activity-capacity {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* Schedule main area */
    .schedule-main {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border-primary);
        overflow: auto;
        position: relative;
        height: min-content;
        flex-grow: 1;
    }

    .schedule-grid-container {
        overflow: auto;
        max-height: calc(100vh - 200px);
        width: 100%;
        /* Custom scrollbar styles */
        scrollbar-width: thin;
        scrollbar-color: var(--border-primary) var(--bg-secondary);
        /* Remove unnecessary padding */
        padding: 0;
        margin: 0;
        min-width: 0;
        /* Allow shrinking */
    }

    .schedule-grid-container::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .schedule-grid-container::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 4px;
    }

    .schedule-grid-container::-webkit-scrollbar-thumb {
        background: var(--border-primary);
        border-radius: 4px;
        transition: background-color 0.2s ease;
    }

    .schedule-grid-container::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
    }

    .schedule-grid-container::-webkit-scrollbar-corner {
        background: var(--bg-secondary);
    }

    /* Time slots header */
    .time-slots-header {
        display: grid;
        grid-template-columns: 120px repeat(var(--time-slots-count, 0), 140px);
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-primary);
        position: sticky;
        top: 0;
        z-index: 10;
        min-width: calc(120px + var(--time-slots-count, 0) * 140px);
        max-width: calc(120px + var(--time-slots-count, 0) * 140px);
        width: calc(120px + var(--time-slots-count, 0) * 140px);
    }

    .day-header-cell {
        padding: 1rem;
        border-right: 1px solid var(--border-primary);
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .time-slot-header {
        padding: 1rem;
        border-right: 1px solid var(--border-primary);
        text-align: center;
        position: relative;
        background: var(--bg-secondary);
    }

    .slot-time {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .slot-duration {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    .slot-delete-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: var(--error-bg);
        color: var(--error-color);
        border: none;
        border-radius: 4px;
        padding: 0.25rem;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .time-slot-header:hover .slot-delete-btn {
        opacity: 1;
    }

    /* Schedule grid */
    .schedule-grid {
        display: block;
        min-height: min-content;
        min-width: calc(120px + var(--time-slots-count, 0) * 140px);
        max-width: calc(120px + var(--time-slots-count, 0) * 140px);
        width: calc(120px + var(--time-slots-count, 0) * 140px);
    }

    .schedule-row {
        display: grid;
        grid-template-columns: 120px repeat(var(--time-slots-count, 0), 140px);
        border-bottom: 1px solid var(--border-primary);
        min-width: calc(120px + var(--time-slots-count, 0) * 140px);
        max-width: calc(120px + var(--time-slots-count, 0) * 140px);
        width: calc(120px + var(--time-slots-count, 0) * 140px);
    }

    .day-cell {
        padding: 1rem;
        border-right: 1px solid var(--border-primary);
        display: flex;
        flex-direction: column;
        justify-content: center;
        background: var(--bg-tertiary);
        transition: background-color 0.2s ease;
        min-height: 80px !important;
    }

    .day-cell.clickable-day {
        cursor: pointer;
    }

    .day-cell.clickable-day:hover {
        background: var(--bg-hover);
    }

    .day-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .day-hint {
        font-size: 0.6rem;
        color: var(--text-muted);
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .day-cell.clickable-day:hover .day-hint {
        opacity: 1;
    }

    /* Activity card actions */
    .activity-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .activity-edit-btn {
        background: var(--bg-secondary);
        color: var(--primary-color);
        border: none;
        border-radius: 4px;
        padding: 0.25rem;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s ease;
        margin-right: 0.25rem;
    }

    .activity-delete-btn {
        background: var(--error-bg);
        color: var(--error-color);
        border: none;
        border-radius: 4px;
        padding: 0.25rem;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .activity-card:hover .activity-edit-btn,
    .activity-card:hover .activity-delete-btn {
        opacity: 1;
    }

    .activity-edit-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    .activity-delete-btn:hover {
        background: var(--error-color);
        color: white;
    }

    /* Time slots preview */
    .time-slots-preview {
        margin: 1.5rem 0;
        padding: 1rem;
        background: var(--bg-tertiary);
        border-radius: 8px;
        border: 1px solid var(--border-primary);
    }

    .time-slots-preview h4 {
        margin: 0 0 1rem 0;
        color: var(--text-primary);
        font-size: 0.875rem;
        font-weight: 600;
    }

    .preview-slots {
        display: grid;
        gap: 0.5rem;
        max-height: 200px;
        overflow-y: auto;
    }

    .preview-slot {
        padding: 0.5rem;
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 4px;
        font-size: 0.75rem;
        color: var(--text-secondary);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .preview-slot.conflict {
        background: var(--error-bg);
        color: var(--error-color);
        border-color: var(--error-color);
    }

    .conflict-indicator {
        font-size: 0.625rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .schedule-cell {
        border-right: 1px solid var(--border-primary);
        min-height: 60px;
        position: relative;
        transition: all 0.2s ease;
        cursor: pointer;
        overflow: visible;
    }

    .schedule-cell:hover {
        background: var(--bg-hover);
    }

    .schedule-cell.drag-over {
        background: var(--accent-bg);
        border: 2px dashed var(--accent-primary);
        box-shadow: inset 0 0 0 2px var(--accent-primary);
        transform: scale(1.02);
    }

    .schedule-cell.drag-active {
        background: rgba(59, 130, 246, 0.1);
        border-color: var(--accent-primary);
    }

    .schedule-cell.occupied {
        background: var(--bg-tertiary);
    }

    .schedule-cell.occupied:hover {
        background: var(--bg-secondary);
    }

    /* Schedule items */
    .schedule-item {
        position: absolute;
        top: 4px;
        left: 4px;
        right: 4px;
        bottom: 4px;
        border-radius: 6px;
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 4px solid;
        box-shadow: var(--shadow-sm);
        overflow: visible;
    }

    .schedule-item:hover {
        transform: scale(1.02);
        box-shadow: var(--shadow-md);
    }

    .schedule-item-name {
        font-weight: 600;
        font-size: 0.75rem;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .schedule-item-coach {
        font-size: 0.625rem;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .schedule-item-notes {
        font-size: 0.6rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
        font-style: italic;
        max-height: 2rem;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Bootstrap popover styling for schedule items */
    .popover {
        max-width: 350px;
    }
    
    .popover-header {
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .popover-body {
        font-size: 0.875rem;
    }

    /* Bootstrap Modal Enhancements */
    /* Old modal styles removed - now using Bootstrap modals */

    .modal-header-modern {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--border-primary);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .modal-title-section {
        flex: 1;
    }

    .modal-title-modern {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 0.25rem 0;
    }

    .modal-subtitle-modern {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin: 0;
    }

    .modal-close-modern {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 6px;
    }

    .modal-close-modern:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .modal-close-modern svg {
        width: 18px;
        height: 18px;
    }

    .modal-body-modern {
        padding: 1.5rem 2rem;
    }

    .modal-footer-modern {
        padding: 1rem 2rem 1.5rem;
        border-top: 1px solid var(--border-primary);
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    /* Form styles */
    .form-grid-modern {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .form-field-modern {
        margin-bottom: 1rem;
    }

    .form-label-modern {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .label-text {
        font-size: 0.875rem;
    }

    .label-required {
        color: var(--error);
        margin-left: 0.25rem;
    }

    .form-input-modern,
    .form-select-modern {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        background: var(--bg-input);
        color: var(--text-primary);
        font-size: 0.875rem;
        transition: border-color 0.2s ease;
    }

    .form-input-modern:focus,
    .form-select-modern:focus {
        outline: none;
        border-color: var(--accent-primary);
    }

    /* Color picker */
    .color-picker-container {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .color-input {
        width: 50px !important;
        height: 40px;
        padding: 0 !important;
        border-radius: 6px;
        cursor: pointer;
    }

    .color-presets {
        display: flex;
        gap: 0.5rem;
    }

    .color-preset {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: 2px solid var(--border-primary);
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .color-preset:hover {
        transform: scale(1.1);
    }

    /* Buttons */
    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--border-primary);
        color: var(--text-primary);
    }

    .btn-outline:hover {
        background: var(--bg-hover);
    }

    .btn-danger {
        background: var(--error);
        color: white;
    }

    .btn-danger:hover {
        background: var(--error-hover);
    }

    /* Loading states */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    /* Responsive design */
    @media (max-width: 1200px) {
        .schedule-container {
            flex-direction: column;
        }

        .activities-sidebar {
            width: 100%;
            position: static;
            margin-bottom: 1rem;
        }

        .activities-list {
            max-height: 200px;
        }
    }

    @media (max-width: 768px) {
        .page-header-content {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .page-actions {
            width: 100%;
            justify-content: stretch;
        }

        .page-actions .btn-primary-modern,
        .page-actions .btn-secondary-modern {
            flex: 1;
            justify-content: center;
        }

        .schedule-container {
            padding: 1rem;
        }

        .time-slots-header,
        .schedule-row {
            grid-template-columns: 80px repeat(auto-fit, minmax(100px, 1fr));
        }

        .day-header-cell,
        .day-cell {
            padding: 0.5rem;
        }

        .time-slot-header {
            padding: 0.5rem;
            font-size: 0.75rem;
        }

        .modal-modern {
            margin: 0.5rem;
            max-width: calc(100vw - 1rem);
        }

        .form-grid-modern {
            grid-template-columns: 1fr;
        }
    }

    /* Activity Selection Modal */
    .activity-selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }

    .activity-option {
        background: var(--bg-card);
        border: 2px solid var(--border-primary);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        position: relative;
    }

    .activity-option:hover {
        border-color: var(--accent-primary);
        background: var(--bg-hover);
        transform: translateY(-2px);
    }

    .activity-option.selected {
        border-color: var(--accent-primary);
        background: var(--accent-bg);
    }

    .activity-option-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .activity-option-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .activity-option-duration {
        font-size: 0.75rem;
        color: var(--text-muted);
        background: var(--bg-tertiary);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        white-space: nowrap;
    }

    .activity-option-type {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .activity-option-color {
        width: 4px;
        height: 100%;
        border-radius: 2px;
        position: absolute;
        left: 0;
        top: 0;
    }

    /* Back button styles */
    .page-title-with-back {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .back-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .back-button:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
        border-color: var(--accent-primary);
    }

    .back-button svg {
        width: 20px;
        height: 20px;
    }

    .page-title-content {
        flex: 1;
    }

    /* Assignment type toggle styles */
    .assignment-type-section {
        margin-bottom: 1rem;
        padding: 1rem;
        background: var(--bg-tertiary);
        border-radius: 8px;
        border: 1px solid var(--border-secondary);
    }

    .assignment-type-toggle {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    .toggle-option {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .toggle-option input[type="radio"] {
        margin-right: 0.5rem;
        accent-color: var(--accent-primary);
    }

    .toggle-text {
        font-weight: 500;
        color: var(--text-primary);
    }

    .assignment-type-description {
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-style: italic;
        margin-top: 0.5rem;
    }

    /* Students assignment styles */
    .students-assignment-container {
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        padding: 1rem;
        background: var(--bg-tertiary);
    }

    .students-search-section {
        position: relative;
        margin-bottom: 1rem;
    }

    .students-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
    }

    .student-search-item {
        padding: 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid var(--border-primary);
        display: flex;
        justify-content: between;
        align-items: center;
    }

    .student-search-item:last-child {
        border-bottom: none;
    }

    .student-search-item:hover {
        background: var(--bg-hover);
    }

    .student-search-name {
        font-weight: 500;
        color: var(--text-primary);
    }

    .student-search-meta {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    .assigned-students-list {
        min-height: 60px;
        margin-bottom: 1rem;
    }

    .assigned-student-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }

    .assigned-student-name {
        font-weight: 500;
        color: var(--text-primary);
    }

    .remove-student-btn {
        background: var(--error);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .remove-student-btn:hover {
        background: var(--error-hover);
    }

    .students-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0.5rem;
        border-top: 1px solid var(--border-primary);
        font-size: 0.875rem;
    }

    .students-count {
        color: var(--text-secondary);
    }

    .capacity-indicator {
        color: var(--text-muted);
    }

    .capacity-indicator.warning {
        color: var(--warning);
    }

    .capacity-indicator.error {
        color: var(--error);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Schedule Management JavaScript
    let centerId = '{{ center._id if center else "" }}';
    let organizationId = '{{ session.organization_id }}';
    let currentScheduleData = [];
    let draggedActivity = null;
    let currentEditingItem = null;
    let selectedDay = null;
    let selectedDayName = '';
    let existingTimeSlots = [];
    
    // Touch drag state
    let touchDragState = {
        isDragging: false,
        activityCard: null,
        startX: 0,
        startY: 0,
        currentX: 0,
        currentY: 0,
        dragOffset: { x: 0, y: 0 },
        longPressTimer: null,
        longPressActivated: false
    };

    // Debug logging
    console.log('Schedule page initialized with:', {
        centerId: centerId,
        organizationId: organizationId,
        centerExists: {% if center %}true{% else %}false{% endif %}
});

    // Days mapping
    const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    document.addEventListener('DOMContentLoaded', function () {
        // Check if we have valid center data
        if (!centerId) {
            showScheduleError('Center ID is missing. Please check the URL and try again.');
            console.error('No center ID found. Cannot load schedule.');
            return;
        }

        initializeSchedule();
        setupEventListeners();
        // Populate initial slot header ranges from server-rendered data
        if (typeof updateSlotHeadersWithEndTime === 'function') {
            updateSlotHeadersWithEndTime();
        }
        loadScheduleData();
        loadExistingTimeSlots();
    });

    function initializeSchedule() {
        console.log('Initializing schedule...');

        // Set CSS custom property for time slots count
        const timeSlotsCount = existingTimeSlots.length || {{ time_slots| length
    }};
    document.documentElement.style.setProperty('--time-slots-count', timeSlotsCount);
    console.log('Set time slots count to:', timeSlotsCount);

    // Setup drag and drop for activity cards
    const activityCards = document.querySelectorAll('.activity-card');
    console.log('Found activity cards:', activityCards.length);

    activityCards.forEach((card, index) => {
        console.log(`Setting up card ${index}:`, card.dataset.activityName);

        // Ensure draggable attribute is set
        card.draggable = true;

        card.addEventListener('dragstart', handleActivityDragStart);
        card.addEventListener('dragend', handleActivityDragEnd);

        // Touch event handlers for drag and drop
        card.addEventListener('touchstart', handleActivityTouchStart, { passive: false });
        card.addEventListener('touchmove', handleActivityTouchMove, { passive: false });
        card.addEventListener('touchend', handleActivityTouchEnd, { passive: false });
        card.addEventListener('touchcancel', handleActivityTouchCancel, { passive: false });

        // Prevent edit button from interfering with drag
        const editBtn = card.querySelector('.activity-edit-btn');
        if (editBtn) {
            editBtn.addEventListener('mousedown', function (e) {
                e.stopPropagation();
                e.preventDefault();
            });
            editBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                e.preventDefault();
                // Call the edit function directly
                const activityId = card.dataset.activityId;
                openEditActivityModal(activityId);
            });
            editBtn.addEventListener('dragstart', function (e) {
                e.stopPropagation();
                e.preventDefault();
            });
            // Prevent touch events on edit button
            editBtn.addEventListener('touchstart', function (e) {
                e.stopPropagation();
            }, { passive: true });
        }

        // Prevent delete button from interfering with drag
        const deleteBtn = card.querySelector('.activity-delete-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('mousedown', function (e) {
                e.stopPropagation();
                e.preventDefault();
            });
            deleteBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                e.preventDefault();
                // Call the delete function directly
                const activityId = card.dataset.activityId;
                const activityName = card.dataset.activityName;
                deleteActivity(activityId, activityName);
            });
            deleteBtn.addEventListener('dragstart', function (e) {
                e.stopPropagation();
                e.preventDefault();
            });
            // Prevent touch events on delete button
            deleteBtn.addEventListener('touchstart', function (e) {
                e.stopPropagation();
            }, { passive: true });
        }
    });

    // Setup schedule cells
    const scheduleCells = document.querySelectorAll('.schedule-cell');
    console.log('Found schedule cells:', scheduleCells.length);

    scheduleCells.forEach(cell => {
        // Ensure the event handlers are properly attached
        cell.addEventListener('dragover', handleDragOver);
        cell.addEventListener('dragenter', handleDragEnter);
        cell.addEventListener('dragleave', handleDragLeave);
        cell.addEventListener('drop', handleDrop);
        cell.addEventListener('click', handleCellClick);

        // Touch event handlers for drag and drop
        cell.addEventListener('touchmove', handleCellTouchMove, { passive: false });
        cell.addEventListener('touchend', handleCellTouchEnd, { passive: false });

        // Add cursor pointer style for empty cells
        if (!cell.querySelector('.schedule-item')) {
            cell.style.cursor = 'pointer';
        }
    });

    // Setup color presets
    const colorPresets = document.querySelectorAll('.color-preset');
    colorPresets.forEach(preset => {
        preset.addEventListener('click', function () {
            document.getElementById('activity_color').value = this.dataset.color;
        });
    });
}

    function setupEventListeners() {
        // Day time slots form
        document.getElementById('dayTimeSlotsForm').addEventListener('submit', handleDayTimeSlotsSubmit);

        // Activity form
        document.getElementById('activityForm').addEventListener('submit', handleActivitySubmit);

        // Schedule item form
        document.getElementById('scheduleItemForm').addEventListener('submit', handleScheduleItemSubmit);

        // Auto-generate preview when form inputs change
        ['day_start_time', 'day_end_time', 'slot_duration_minutes', 'slot_break_minutes'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', generateTimeSlotPreview);
            }
        });

        // Feedback metric input - handle Enter key
        const feedbackMetricInput = document.getElementById('newFeedbackMetric');
        if (feedbackMetricInput) {
            feedbackMetricInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addFeedbackMetric();
                }
            });
        }

        // Color preset buttons
        document.querySelectorAll('.color-preset').forEach(button => {
            button.addEventListener('click', function () {
                const color = this.dataset.color;
                document.getElementById('activity_color').value = color;
            });
        });

        // Bootstrap modals handle click outside to close automatically
    }

    // Update time slot headers to display "hh:mm to hh:mm"
    function updateSlotHeadersWithEndTime() {
        const headers = document.querySelectorAll('.time-slot-header');
        headers.forEach(header => {
            const slotId = header.getAttribute('data-slot-id');
            const startEl = header.querySelector('.slot-time');
            const rangeEl = header.querySelector('.slot-duration');
            if (!startEl || !rangeEl) return;
            const start = startEl.textContent.trim();
            let duration = parseInt(header.getAttribute('data-slot-duration'));
            if (parseInt(duration) > 60) {
                rangeEl.textContent = `${parseInt(duration / 60)} hours ${duration % 60} minutes`;
            } else {
                rangeEl.textContent = `${duration} minutes`;
            }
        });
    }

    // Drag and Drop functionality
    function handleActivityDragStart(e) {
        draggedActivity = {
            id: this.dataset.activityId,
            name: this.dataset.activityName,
            type: this.dataset.activityType,
            color: this.dataset.activityColor
        };

        this.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'copy';
    }

    function handleActivityDragEnd(e) {
        this.style.opacity = '1';
        draggedActivity = null;

        // Clean up any remaining drag states
        document.querySelectorAll('.schedule-cell.drag-over, .schedule-cell.drag-active').forEach(cell => {
            cell.classList.remove('drag-over', 'drag-active');
        });
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
    }

    function handleDragEnter(e) {
        e.preventDefault();
        this.classList.add('drag-over');

        // Add active state to all cells during drag
        if (!this.querySelector('.schedule-item')) {
            this.classList.add('drag-active');
        }
    }

    function handleDragLeave(e) {
        // Only remove if we're actually leaving the cell (not entering a child)
        if (!this.contains(e.relatedTarget)) {
            this.classList.remove('drag-over', 'drag-active');
        }
    }

    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over', 'drag-active');

        // Remove drag-active class from all cells
        document.querySelectorAll('.schedule-cell.drag-active').forEach(cell => {
            cell.classList.remove('drag-active');
        });

        if (!draggedActivity) {
            console.log('No dragged activity found');
            return;
        }

        const dayIndex = parseInt(this.dataset.day);
        const slotId = this.dataset.slotId;

        console.log('Drop data:', { dayIndex, slotId, draggedActivity });

        // Check if slot is already occupied
        if (this.querySelector('.schedule-item')) {
            alert('This time slot is already occupied. Please choose another slot.');
            return;
        }

        // Add visual feedback for successful drop
        this.style.background = 'var(--success-bg)';
        setTimeout(() => {
            this.style.background = '';
        }, 1000);

        // Create schedule item
        createScheduleItem(dayIndex, slotId, draggedActivity);
    }

    // Touch drag and drop handlers
    function handleActivityTouchStart(e) {
        // Don't start drag if clicking on edit/delete buttons
        const target = e.target.closest('.activity-edit-btn, .activity-delete-btn');
        if (target) {
            return;
        }

        const touch = e.touches[0];
        const card = e.currentTarget;
        
        // Get the card's position relative to viewport
        const rect = card.getBoundingClientRect();
        
        // Reset state
        touchDragState.isDragging = false;
        touchDragState.longPressActivated = false;
        touchDragState.activityCard = card;
        touchDragState.startX = touch.clientX;
        touchDragState.startY = touch.clientY;
        touchDragState.currentX = touch.clientX;
        touchDragState.currentY = touch.clientY;
        touchDragState.dragOffset.x = touch.clientX - rect.left;
        touchDragState.dragOffset.y = touch.clientY - rect.top;

        // Set dragged activity data (will be used if drag starts)
        draggedActivity = {
            id: card.dataset.activityId,
            name: card.dataset.activityName,
            type: card.dataset.activityType,
            color: card.dataset.activityColor
        };

        // Start long press timer (400ms)
        touchDragState.longPressTimer = setTimeout(() => {
            touchDragState.longPressActivated = true;
            touchDragState.isDragging = true;
            
            // Visual feedback for long press activation
            card.style.opacity = '0.5';
            card.style.transition = 'opacity 0.2s';
            card.style.transform = 'scale(1.05)';
            card.style.zIndex = '1000';
            
            // Haptic feedback if available
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }, 400);
    }

    function handleActivityTouchMove(e) {
        if (!touchDragState.activityCard) return;

        const touch = e.touches[0];
        const deltaX = Math.abs(touch.clientX - touchDragState.startX);
        const deltaY = Math.abs(touch.clientY - touchDragState.startY);
        
        // If long press hasn't activated yet, check if movement is too much
        if (!touchDragState.longPressActivated) {
            // Cancel long press if user moves too much (15px threshold)
            if (deltaX > 15 || deltaY > 15) {
                if (touchDragState.longPressTimer) {
                    clearTimeout(touchDragState.longPressTimer);
                    touchDragState.longPressTimer = null;
                }
                touchDragState.activityCard = null;
                draggedActivity = null;
                return;
            }
            // Don't prevent default until long press activates
            return;
        }

        // Only allow dragging after long press is activated
        if (touchDragState.isDragging) {
            touchDragState.currentX = touch.clientX;
            touchDragState.currentY = touch.clientY;

            // Prevent scrolling
            e.preventDefault();

            // Find the schedule cell under the touch point
            const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
            const scheduleCell = elementUnderTouch?.closest('.schedule-cell');
            
            // Remove drag-over from all cells
            document.querySelectorAll('.schedule-cell.drag-over').forEach(cell => {
                cell.classList.remove('drag-over');
            });

            // Add drag-over to the cell under touch (if it's empty)
            if (scheduleCell && !scheduleCell.querySelector('.schedule-item')) {
                scheduleCell.classList.add('drag-over');
            }
        }
    }

    function handleActivityTouchEnd(e) {
        // Clear long press timer if it's still running
        if (touchDragState.longPressTimer) {
            clearTimeout(touchDragState.longPressTimer);
            touchDragState.longPressTimer = null;
        }

        // If we didn't drag (long press didn't activate), reset state
        if (!touchDragState.isDragging) {
            // Reset card styles if long press was cancelled
            if (touchDragState.activityCard) {
                touchDragState.activityCard.style.opacity = '';
                touchDragState.activityCard.style.transform = '';
                touchDragState.activityCard.style.zIndex = '';
            }
            touchDragState.activityCard = null;
            draggedActivity = null;
            touchDragState.longPressActivated = false;
            return;
        }
        
        // Let the document-level handler process the drop
        // Don't reset state here - let document handler do it
    }

    function handleCellTouchMove(e) {
        // This handler helps with touch drag over cells
        if (touchDragState.isDragging) {
            e.preventDefault();
        }
    }

    function handleCellTouchEnd(e) {
        // This is handled by handleActivityTouchEnd
        // But we prevent default to avoid cell click during drag
        if (touchDragState.isDragging) {
            e.preventDefault();
        }
    }

    function handleActivityTouchCancel(e) {
        // Clear long press timer if it's still running
        if (touchDragState.longPressTimer) {
            clearTimeout(touchDragState.longPressTimer);
            touchDragState.longPressTimer = null;
        }

        // Clean up touch drag state if touch is cancelled
        if (touchDragState.activityCard) {
            touchDragState.activityCard.style.opacity = '';
            touchDragState.activityCard.style.transform = '';
            touchDragState.activityCard.style.zIndex = '';
        }
        
        // Remove all drag-over classes
        document.querySelectorAll('.schedule-cell.drag-over, .schedule-cell.drag-active').forEach(cell => {
            cell.classList.remove('drag-over', 'drag-active');
        });

        touchDragState.isDragging = false;
        touchDragState.longPressActivated = false;
        touchDragState.activityCard = null;
        draggedActivity = null;
    }

    // Document-level touchmove handler to handle dragging anywhere
    document.addEventListener('touchmove', function(e) {
        // If we have an activity card but long press hasn't activated yet, check movement
        if (touchDragState.activityCard && !touchDragState.longPressActivated) {
            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - touchDragState.startX);
            const deltaY = Math.abs(touch.clientY - touchDragState.startY);
            
            // Cancel long press if user moves too much (15px threshold)
            if (deltaX > 15 || deltaY > 15) {
                if (touchDragState.longPressTimer) {
                    clearTimeout(touchDragState.longPressTimer);
                    touchDragState.longPressTimer = null;
                }
                touchDragState.activityCard = null;
                draggedActivity = null;
                return;
            }
        }

        // Only process dragging after long press is activated
        if (touchDragState.isDragging && touchDragState.activityCard && touchDragState.longPressActivated) {
            const touch = e.touches[0];
            touchDragState.currentX = touch.clientX;
            touchDragState.currentY = touch.clientY;

            // Find the schedule cell under the touch point
            const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
            const scheduleCell = elementUnderTouch?.closest('.schedule-cell');
            
            // Remove drag-over from all cells
            document.querySelectorAll('.schedule-cell.drag-over').forEach(cell => {
                cell.classList.remove('drag-over');
            });

            // Add drag-over to the cell under touch (if it's empty)
            if (scheduleCell && !scheduleCell.querySelector('.schedule-item')) {
                scheduleCell.classList.add('drag-over');
            }

            // Prevent scrolling while dragging
            e.preventDefault();
        }
    }, { passive: false });

    // Document-level touchend handler to handle drops anywhere
    document.addEventListener('touchend', function(e) {
        if (touchDragState.isDragging && touchDragState.activityCard) {
            const touch = e.changedTouches[0];
            
            // Clear long press timer if still running
            if (touchDragState.longPressTimer) {
                clearTimeout(touchDragState.longPressTimer);
                touchDragState.longPressTimer = null;
            }
            
            // Find the schedule cell under the touch point
            const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
            const scheduleCell = elementUnderTouch?.closest('.schedule-cell');

            // Reset card styles
            touchDragState.activityCard.style.opacity = '';
            touchDragState.activityCard.style.transform = '';
            touchDragState.activityCard.style.zIndex = '';

            // Remove all drag-over classes
            document.querySelectorAll('.schedule-cell.drag-over, .schedule-cell.drag-active').forEach(cell => {
                cell.classList.remove('drag-over', 'drag-active');
            });

            // If we dropped on a valid schedule cell
            if (scheduleCell && !scheduleCell.querySelector('.schedule-item') && draggedActivity) {
                const dayIndex = parseInt(scheduleCell.dataset.day);
                const slotId = scheduleCell.dataset.slotId;

                console.log('Touch drop data:', { dayIndex, slotId, draggedActivity });

                // Add visual feedback for successful drop
                scheduleCell.style.background = 'var(--success-bg)';
                setTimeout(() => {
                    scheduleCell.style.background = '';
                }, 1000);

                // Create schedule item
                createScheduleItem(dayIndex, slotId, draggedActivity);
            }

            // Reset touch drag state
            touchDragState.isDragging = false;
            touchDragState.longPressActivated = false;
            touchDragState.activityCard = null;
            draggedActivity = null;
        }
    }, { passive: false });

    function handleCellClick(e) {
        // Don't trigger if clicking on an existing schedule item
        if (this.querySelector('.schedule-item')) {
            return;
        }

        const dayIndex = parseInt(this.dataset.day);
        const slotId = this.dataset.slotId;

        console.log('Cell clicked:', { dayIndex, slotId });

        // Open activity selection modal
        openActivitySelectionModal(dayIndex, slotId);
    }

    // API Functions
    async function loadScheduleData() {
        try {
            console.log('Loading schedule data for center:', centerId);
            const response = await fetch(`/api/centers/${centerId}/schedule`);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Schedule API error:', response.status, errorText);
                showScheduleError(`Failed to load schedule (${response.status}): ${errorText}`);
                return;
            }

            const data = await response.json();
            console.log('Schedule data loaded:', data);

            if (data.schedule) {
                currentScheduleData = data.schedule;
                window.currentScheduleData = data.schedule;
                renderScheduleItems();
                hideScheduleError();
            } else {
                console.error('No schedule data in response:', data);
                showScheduleError('No schedule data received from server');
            }
        } catch (error) {
            console.error('Error loading schedule:', error);
            showScheduleError(`Network error: ${error.message}`);
        }
    }

    function showScheduleError(message) {
        // Create or update error display
        let errorDiv = document.getElementById('scheduleErrorDisplay');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'scheduleErrorDisplay';
            errorDiv.className = 'error-banner';
            errorDiv.style.cssText = `
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #dc2626;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            text-align: center;
        `;

            // Insert after the page header
            const pageHeader = document.querySelector('.page-header-modern');
            if (pageHeader) {
                pageHeader.insertAdjacentElement('afterend', errorDiv);
            }
        }
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    function hideScheduleError() {
        const errorDiv = document.getElementById('scheduleErrorDisplay');
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
    }

    function renderScheduleItems() {
        // Clear existing items and states
        document.querySelectorAll('.schedule-item').forEach(item => {
            // Dispose of Bootstrap popover if it exists
            const popoverInstance = bootstrap.Popover.getInstance(item);
            if (popoverInstance) {
                popoverInstance.dispose();
            }
            item.remove();
        });
        document.querySelectorAll('.schedule-cell.occupied').forEach(cell => {
            cell.classList.remove('occupied');
        });

        // Render each schedule item
        currentScheduleData.forEach(item => {
            const cell = document.querySelector(`[data-day="${item.day_of_week}"][data-slot-id="${item.time_slot_id}"]`);
            if (cell) {
                const scheduleElement = createScheduleElement(item);
                cell.appendChild(scheduleElement);
                cell.classList.add('occupied');
            }
        });
    }

    function createScheduleElement(scheduleItem) {
        console.log('scheduleItem', scheduleItem);
        const div = document.createElement('div');
        div.className = 'schedule-item';
        div.dataset.scheduleId = scheduleItem._id;

        // Get activity and coach names
        const activity = getActivityById(scheduleItem.activity_id);
        const coach = getCoachById(scheduleItem.coach_id);

        // Set color from activity data
        const activityColor = activity?.color || '#3B82F6';
        div.style.borderLeftColor = activityColor;

        div.dataset.activityId = scheduleItem.activity_id;
        div.dataset.scheduleItemId = scheduleItem._id;

        const maxParticipants = scheduleItem.max_participants || 0;
        const assignedStudents = scheduleItem.assigned_students || [];
        const studentsCount = assignedStudents.length;
        const spotsLeft = maxParticipants > 0 ? maxParticipants - studentsCount : null;

        // Simplified tile - only class name and coach name
        div.innerHTML = `
        <div class="schedule-item-header">
            <div class="schedule-item-name">${activity ? activity.name : 'Unknown Activity'}</div>
        </div>
        <div class="schedule-item-coach">${coach ? 'by ' + coach.name : 'Unassigned'}</div>
    `;

        div.addEventListener('click', () => openScheduleItemModal(scheduleItem));

        // Build popover content
        let popoverContent = '';
        if (maxParticipants > 0) {
            popoverContent += `
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Capacity:</span>
                    <span class="fw-semibold">${maxParticipants}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Enrolled:</span>
                    <span class="fw-semibold">${studentsCount}</span>
                </div>
            `;
            if (spotsLeft !== null) {
                const spotsClass = spotsLeft === 0 ? 'bg-danger' : spotsLeft <= 2 ? 'bg-warning' : 'bg-success';
                popoverContent += `
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Spots Left:</span>
                        <span class="badge ${spotsClass} text-white">${spotsLeft}</span>
                    </div>
                `;
            }
        }
        if (scheduleItem.notes) {
            popoverContent += `
                <div class="mb-2">
                    <span class="text-muted">Notes:</span>
                    <div class="fst-italic">${scheduleItem.notes}</div>
                </div>
            `;
        }
        if (studentsCount > 0) {
            popoverContent += `
                <hr class="my-2">
                <div class="fw-semibold mb-2">Assigned Students (${studentsCount})</div>
                ${assignedStudents.map(student => `
                    <div class="d-flex justify-content-between align-items-center mb-1 p-1 rounded">
                        <span>${student.name}</span>
                        <span class="badge bg-secondary">Student</span>
                    </div>
                `).join('')}
            `;
        }

        // Initialize Bootstrap popover
        const popoverTitle = activity ? activity.name : 'Unknown Activity';
        new bootstrap.Popover(div, {
            title: popoverTitle,
            content: popoverContent,
            html: true,
            placement: 'bottom',
            trigger: 'hover',
            container: 'body',
            sanitize: false
        });

        return div;
    }

    async function createScheduleItem(dayIndex, slotId, activity) {
        console.log(dayIndex, slotId, activity);
        try {
            const response = await fetch(`/api/centers/${centerId}/schedule`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    day_of_week: dayIndex,
                    time_slot_id: slotId,
                    activity_id: activity.id
                })
            });

            const data = await response.json();

            if (response.ok) {
                // Add to current data and re-render
                currentScheduleData.push(data.schedule_item);
                renderScheduleItems();
                showSuccessMessage('Activity scheduled successfully!');
            } else {
                alert(data.error || 'Error creating schedule item');
            }
        } catch (error) {
            console.error('Error creating schedule item:', error);
            alert('Error creating schedule item');
        }
    }

    // Load existing time slots data
    async function loadExistingTimeSlots() {
        try {
            console.log('Loading time slots for center:', centerId);
            const response = await fetch(`/api/centers/${centerId}/time-slots`);

            if (!response.ok) {
                console.error('Time slots API error:', response.status, await response.text());
                return;
            }

            const data = await response.json();
            console.log('Time slots loaded:', data);
            existingTimeSlots = data.time_slots || [];
            window.existingTimeSlots = existingTimeSlots;

            // Update CSS custom property for time slots count
            document.documentElement.style.setProperty('--time-slots-count', existingTimeSlots.length);

            // Refresh slot headers to show end times
            if (typeof updateSlotHeadersWithEndTime === 'function') {
                updateSlotHeadersWithEndTime();
            }
        } catch (error) {
            console.error('Error loading time slots:', error);
        }
    }

    // Modal functions
    function openDayTimeSlotsModal(dayIndex = null, dayName = '') {
        selectedDay = dayIndex;
        selectedDayName = dayName || DAYS[dayIndex] || 'Day';

        document.getElementById('dayTimeSlotsTitle').textContent = `Add Time Slots for ${selectedDayName}`;
        const modalElement = document.getElementById('dayTimeSlotsModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }

        // Reset form and preview
        document.getElementById('dayTimeSlotsForm').reset();
        document.getElementById('previewSlots').innerHTML = '';

        // Generate initial preview
        setTimeout(generateTimeSlotPreview, 100);
    }

    function closeDayTimeSlotsModal() {
        const modalElement = document.getElementById('dayTimeSlotsModal');
        if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        }
        document.getElementById('dayTimeSlotsForm').reset();
        selectedDay = null;
        selectedDayName = '';
    }

    let currentEditingActivityId = null;
    let feedbackMetrics = [];

    function openActivityModal() {
        currentEditingActivityId = null;
        feedbackMetrics = [];
        document.getElementById('activityModalTitle').textContent = 'Add Activity';
        document.getElementById('activityModalSubtitle').textContent = 'Create a new activity for scheduling';
        document.getElementById('activitySubmitBtnText').textContent = 'Add Activity';
        document.getElementById('activityForm').reset();
        renderFeedbackMetrics();

        const modalElement = document.getElementById('activityModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    }

    async function openEditActivityModal(activityId) {
        try {
            currentEditingActivityId = activityId;

            // Fetch activity details
            const response = await fetch(`/api/organizations/${organizationId}/activities`);
            const result = await response.json();

            if (!response.ok) {
                alert('Error fetching activity details');
                return;
            }

            const activity = result.activities.find(a => a._id === activityId);
            if (!activity) {
                alert('Activity not found');
                return;
            }

            // Populate form
            document.getElementById('activity_name').value = activity.name || '';
            document.getElementById('default_coach_id').value = activity.default_coach_id || '';
            document.getElementById('activity_price').value = activity.price || 0;
            document.getElementById('activity_description').value = activity.description || '';

            document.getElementById('activity_capacity').value = activity.max_participants || 20;
            document.getElementById('activity_level').value = activity.skill_level || 'beginner';
            document.getElementById('activity_color').value = activity.color || '#3B82F6';
            document.getElementById('activity_is_bookable').checked = activity.is_bookable !== undefined ? activity.is_bookable : true;

            // Load feedback metrics
            feedbackMetrics = activity.feedback_metrics || [];
            renderFeedbackMetrics();

            // Update modal title, subtitle and button
            document.getElementById('activityModalTitle').textContent = 'Edit Activity';
            document.getElementById('activityModalSubtitle').textContent = 'Update activity details and custom feedback metrics';
            document.getElementById('activitySubmitBtnText').textContent = 'Update Activity';

            // Show modal
            const modalElement = document.getElementById('activityModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            }
        } catch (error) {
            console.error('Error opening edit modal:', error);
            alert('Error loading activity details');
        }
    }

    function closeActivityModal() {
        const modalElement = document.getElementById('activityModal');
        if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        }
        document.getElementById('activityForm').reset();
        currentEditingActivityId = null;
        feedbackMetrics = [];
    }

    function addFeedbackMetric() {
        const input = document.getElementById('newFeedbackMetric');
        const metric = input.value.trim();

        if (!metric) {
            return;
        }

        if (feedbackMetrics.includes(metric)) {
            alert('This metric already exists');
            return;
        }

        if (feedbackMetrics.length >= 10) {
            alert('Maximum 10 metrics allowed');
            return;
        }

        feedbackMetrics.push(metric);
        input.value = '';
        renderFeedbackMetrics();
    }

    function removeFeedbackMetric(index) {
        feedbackMetrics.splice(index, 1);
        renderFeedbackMetrics();
    }

    function renderFeedbackMetrics() {
        const container = document.getElementById('feedbackMetricsList');

        if (feedbackMetrics.length === 0) {
            container.innerHTML = '<p class="text-muted small mb-2">No custom metrics added yet</p>';
            return;
        }

        let html = '<div class="d-flex flex-wrap gap-2">';
        feedbackMetrics.forEach((metric, index) => {
            html += `
            <div class="rounded px-4 bg-primary d-flex align-items-center gap-1" style="font-size: 1rem; padding: 0.5rem 0.75rem;">
                <span>${metric}</span>
                <button type="button" class="btn-close btn-close-white" style="font-size: 0.6rem;" onclick="removeFeedbackMetric(${index})" aria-label="Remove"></button>
            </div>
        `;
        });
        html += '</div>';

        container.innerHTML = html;
    }

    function openScheduleItemModal(scheduleItem) {
        if (isSelectionMode)
            return;
        currentEditingItem = scheduleItem;

        // Populate coaches dropdown
        populateCoachesDropdown();

        // Populate form
        document.getElementById('schedule_coach').value = scheduleItem.coach_id || '';
        document.getElementById('schedule_capacity').value = scheduleItem.max_participants || '';
        document.getElementById('schedule_notes').value = scheduleItem.notes || '';

        // Update title
        const activity = getActivityById(scheduleItem.activity_id);
        document.getElementById('scheduleItemTitle').textContent =
            `Edit ${activity ? activity.name : 'Activity'} - ${DAYS[scheduleItem.day_of_week]}`;

        const modalElement = document.getElementById('scheduleItemModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }

        console.log(scheduleItem.assigned_students);
        window.assignedStudents = [];
        scheduleItem.assigned_students.forEach(student => {
            window.assignedStudents.push(student);

        });
        updateAssignedStudentsList();
        updateStudentsCount();
    }

    function populateCoachesDropdown() {
        const select = document.getElementById('schedule_coach');

        // Clear existing options except the first one
        while (select.children.length > 1) {
            select.removeChild(select.lastChild);
        }

        // Add coaches from the available data
        if (window.availableCoaches && window.availableCoaches.length > 0) {
            window.availableCoaches.forEach(coach => {
                const option = document.createElement('option');
                option.value = coach._id;
                option.textContent = coach.name;
                select.appendChild(option);
            });
        } else {
            // If no coaches available, show a message
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No coaches available';
            option.disabled = true;
            select.appendChild(option);
        }
    }

    function closeScheduleItemModal() {
        const modalElement = document.getElementById('scheduleItemModal');
        if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        }
        document.getElementById('scheduleItemForm').reset();
        currentEditingItem = null;
    }

    // Time slot preview and conflict detection
    function generateTimeSlotPreview() {
        const startTime = document.getElementById('day_start_time').value;
        const endTime = document.getElementById('day_end_time').value;
        const duration = parseInt(document.getElementById('slot_duration_minutes').value);
        const breakTime = parseInt(document.getElementById('slot_break_minutes').value);

        if (!startTime || !endTime || !duration) {
            document.getElementById('previewSlots').innerHTML = '<p class="text-muted">Please fill in all required fields to preview time slots.</p>';
            return;
        }

        const slots = generateTimeSlots(startTime, endTime, duration, breakTime);
        const previewContainer = document.getElementById('previewSlots');

        if (slots.length === 0) {
            previewContainer.innerHTML = '<p class="text-muted">No time slots can be generated with the current settings.</p>';
            return;
        }

        let html = '';
        slots.forEach(slot => {
            const hasConflict = checkTimeSlotConflict(slot.start_time, slot.end_time);
            const conflictClass = hasConflict ? ' conflict' : '';

            html += `
            <div class="preview-slot${conflictClass}">
                <span>${slot.start_time} to ${slot.end_time}</span>
                ${hasConflict ? '<span class="conflict-indicator">Conflict</span>' : ''}
            </div>
        `;
        });

        previewContainer.innerHTML = html;
    }

    function generateTimeSlots(startTime, endTime, duration, breakTime) {
        const slots = [];
        const startMinutes = timeToMinutes(startTime);
        const endMinutes = timeToMinutes(endTime);

        let currentTime = startMinutes;

        while (currentTime + duration <= endMinutes) {
            const slotStart = minutesToTime(currentTime);
            const slotEnd = minutesToTime(currentTime + duration);

            slots.push({
                start_time: slotStart,
                end_time: slotEnd,
                duration_minutes: duration
            });

            currentTime += duration + breakTime;
        }

        return slots;
    }

    function checkTimeSlotConflict(startTime, endTime) {
        const newStart = timeToMinutes(startTime);
        const newEnd = timeToMinutes(endTime);

        return existingTimeSlots.some(slot => {
            const existingStart = timeToMinutes(slot.start_time);
            const existingEnd = existingStart + (slot.duration_minutes || 60);

            // Check for overlap
            return (newStart < existingEnd && newEnd > existingStart);
        });
    }

    function timeToMinutes(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    }

    function minutesToTime(minutes) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    }

    // Form handlers
    async function handleDayTimeSlotsSubmit(e) {
        e.preventDefault();

        const startTime = document.getElementById('day_start_time').value;
        const endTime = document.getElementById('day_end_time').value;
        const duration = parseInt(document.getElementById('slot_duration_minutes').value);
        const breakTime = parseInt(document.getElementById('slot_break_minutes').value);

        // Generate time slots
        const slots = generateTimeSlots(startTime, endTime, duration, breakTime);

        if (slots.length === 0) {
            alert('No time slots can be generated with the current settings.');
            return;
        }

        // Check for conflicts
        const conflictingSlots = slots.filter(slot =>
            checkTimeSlotConflict(slot.start_time, slot.end_time)
        );

        if (conflictingSlots.length > 0) {
            if (!confirm(`${conflictingSlots.length} time slot(s) will conflict with existing slots. Do you want to continue and create only non-conflicting slots?`)) {
                return;
            }
        }

        // Filter out conflicting slots
        const nonConflictingSlots = slots.filter(slot =>
            !checkTimeSlotConflict(slot.start_time, slot.end_time)
        );

        if (nonConflictingSlots.length === 0) {
            alert('All generated time slots conflict with existing slots. Please choose different times.');
            return;
        }

        // Create time slots
        const btn = document.getElementById('createTimeSlotsBtn');
        btn.disabled = true;
        btn.textContent = 'Creating...';

        try {
            let successCount = 0;
            for (const slot of nonConflictingSlots) {
                const response = await fetch(`/api/centers/${centerId}/time-slots`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        start_time: slot.start_time,
                        duration_minutes: slot.duration_minutes,
                        break_minutes: 0,
                        name: `${selectedDayName} ${slot.start_time}-${slot.end_time}`
                    })
                });

                if (response.ok) {
                    successCount++;
                }
            }

            if (successCount > 0) {
                closeDayTimeSlotsModal();
                showSuccessMessage(`Created ${successCount} time slots successfully!`);

                // Simple UI refresh - reload existing time slots data
                await loadExistingTimeSlots();

                // Update the page with a simple refresh after a short delay
                setTimeout(() => {
                    // Show a nice transition
                    document.body.style.opacity = '0.8';
                    setTimeout(() => {
                        location.reload();
                    }, 300);
                }, 1000);
            } else {
                alert('Failed to create any time slots. Please try again.');
            }

        } catch (error) {
            console.error('Error creating time slots:', error);
            alert('Error creating time slots');
        } finally {
            btn.disabled = false;
            btn.innerHTML = `
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Create Time Slots
        `;
        }
    }

    async function handleActivitySubmit(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = {
            name: formData.get('name'),
            type: formData.get('type'),
            description: formData.get('description'),
            max_participants: parseInt(formData.get('max_participants')),
            skill_level: formData.get('skill_level'),
            color: formData.get('color'),
            default_coach_id: formData.get('default_coach_id'),
            price: parseFloat(formData.get('price')),
            feedback_metrics: feedbackMetrics,
            is_bookable: document.getElementById('activity_is_bookable').checked

        };

        try {
            let response;
            if (currentEditingActivityId) {
                // Update existing activity
                response = await fetch(`/api/organizations/${organizationId}/activities/${currentEditingActivityId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
            } else {
                // Create new activity
                response = await fetch(`/api/organizations/${organizationId}/activities`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
            }

            const result = await response.json();

            if (response.ok) {
                closeActivityModal();
                location.reload(); // Reload to show updated/new activity
            } else {
                alert(result.error || `Error ${currentEditingActivityId ? 'updating' : 'creating'} activity`);
            }
        } catch (error) {
            console.error(`Error ${currentEditingActivityId ? 'updating' : 'creating'} activity:`, error);
            alert(`Error ${currentEditingActivityId ? 'updating' : 'creating'} activity`);
        }
    }

    async function handleScheduleItemSubmit(e) {
        e.preventDefault();

        if (!currentEditingItem) return;

        const formData = new FormData(this);
        const data = {
            coach_id: formData.get('coach_id') || null,
            max_participants: parseInt(formData.get('max_participants')) || null,
            notes: formData.get('notes'),
            assignment_type: formData.get('assignment_type'),
            assigned_students: Array.from(document.querySelectorAll('.assigned-student-name')).map(student => student.dataset.studentId) || []
        };

        try {
            const response = await fetch(`/api/centers/${centerId}/schedule/${currentEditingItem._id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                // Update current data
                const index = currentScheduleData.findIndex(item => item._id === currentEditingItem._id);
                if (index !== -1) {
                    Object.assign(currentScheduleData[index], data);
                    // Also update window reference
                    window.currentScheduleData = currentScheduleData;
                }

                // Re-render schedule items to show updated coach assignment
                loadScheduleData();
                renderScheduleItems();
                closeScheduleItemModal();
                showSuccessMessage('Schedule item updated successfully!');
            } else {
                alert(result.error || 'Error updating schedule item');
            }
        } catch (error) {
            console.error('Error updating schedule item:', error);
            alert('Error updating schedule item');
        }
    }

    async function removeScheduleItem() {
        if (!currentEditingItem) return;

        try {
            // First get affected classes
            const response = await fetch(`/api/centers/${centerId}/schedule/${currentEditingItem._id}/affected-classes`);
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'Failed to get affected classes');
            }

            const { classes, total_count } = result;

            // Get the modal body
            const modalBody = document.querySelector('#scheduleItemModal .modal-body');
            const modalFooter = document.querySelector('#scheduleItemModal .modal-footer');
            const modalTitle = document.querySelector('#scheduleItemModal .modal-title');

            // Store the original content to restore if user cancels
            const originalContent = modalBody.innerHTML;
            const originalFooter = modalFooter.innerHTML;
            const originalTitle = modalTitle.innerHTML;

            // Update modal title
            modalTitle.innerHTML = 'Confirm Schedule Deletion';

            // Create confirmation content
            let confirmationContent = `
            <p>Are you sure you want to delete this schedule item?</p>`;

            if (total_count > 0) {
                confirmationContent += `
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This schedule has ${total_count} future classes:
                </div>
                <div class="affected-classes" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Class</th>
                                <th>Coach</th>
                                <th>Students</th>
                            </tr>
                        </thead>
                        <tbody>`;

                classes.forEach(classInfo => {
                    confirmationContent += `
                    <tr>
                        <td>${classInfo.scheduled_at}</td>
                        <td>${classInfo.title}</td>
                        <td>${classInfo.coach_name}</td>
                        <td>${classInfo.student_count} students, ${classInfo.group_count} groups</td>
                    </tr>`;
                });

                confirmationContent += `
                        </tbody>
                    </table>
                </div>
                <div class="form-group mt-3">
                    <div class="alert alert-info">
                        Choose how to handle the future classes:
                    </div>
                    <div class="custom-control custom-radio mb-2">
                        <input type="radio" class="custom-control-input" id="deleteClasses" name="classAction" value="delete" checked>
                        <label class="custom-control-label" for="deleteClasses">
                            <strong>Delete all future classes</strong>
                            <div class="text-muted small">All future classes will be permanently deleted</div>
                        </label>
                    </div>
                    <div class="custom-control custom-radio">
                        <input type="radio" class="custom-control-input" id="keepClasses" name="classAction" value="keep">
                        <label class="custom-control-label" for="keepClasses">
                            <strong>Keep classes as independent sessions</strong>
                            <div class="text-muted small">Classes will remain but won't be linked to this schedule</div>
                        </label>
                    </div>
                </div>`;
            }

            // Update modal body
            modalBody.innerHTML = confirmationContent;

            // Update footer buttons
            modalFooter.innerHTML = `
            <button type="button" class="btn btn-secondary" onclick="restoreModalContent()">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="confirmRemoveScheduleItem()">
                Delete Schedule
            </button>
        `;

            // Add function to restore original content
            window.restoreModalContent = function () {
                modalBody.innerHTML = originalContent;
                modalFooter.innerHTML = originalFooter;
                modalTitle.innerHTML = originalTitle;
                delete window.restoreModalContent;
            };

        } catch (error) {
            console.error('Error preparing delete confirmation:', error);
            alert('Error preparing delete confirmation: ' + error.message);
        }
    }

    async function confirmRemoveScheduleItem() {
        try {
            const deleteClasses = document.querySelector('input[name="classAction"]:checked')?.value === 'delete';

            const response = await fetch(`/api/centers/${centerId}/schedule/${currentEditingItem._id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ delete_classes: deleteClasses })
            });

            const result = await response.json();

            if (response.ok) {
                // Remove from current data
                currentScheduleData = currentScheduleData.filter(item => item._id !== currentEditingItem._id);
                window.currentScheduleData = currentScheduleData;

                // Close modal and update UI
                closeScheduleItemModal();
                renderScheduleItems();
                showSuccessMessage(result.message);

                // Refresh the page to show updated classes
                if (deleteClasses) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            } else {
                throw new Error(result.error || 'Failed to delete schedule');
            }
        } catch (error) {
            console.error('Error removing schedule item:', error);
            alert('Error removing schedule item: ' + error.message);
        }
    }

    async function deleteTimeSlot(slotId) {
        if (!confirm('Are you sure you want to delete this time slot? All scheduled activities in this slot will be removed.')) return;

        try {
            const response = await fetch(`/api/centers/${centerId}/time-slots/${slotId}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (response.ok) {
                location.reload(); // Reload to reflect changes
            } else {
                alert(result.error || 'Error deleting time slot');
            }
        } catch (error) {
            console.error('Error deleting time slot:', error);
            alert('Error deleting time slot');
        }
    }

    async function deleteActivity(activityId, activityName) {
        if (!confirm(`Are you sure you want to delete "${activityName}"? This will remove it from all schedules.`)) return;

        try {
            const response = await fetch(`/api/organizations/${organizationId}/activities/${activityId}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (response.ok) {
                // Remove activity card from DOM
                const activityCard = document.querySelector(`[data-activity-id="${activityId}"]`);
                if (activityCard) {
                    activityCard.remove();
                }

                // Reload schedule data to remove any scheduled instances
                loadScheduleData();
                showSuccessMessage('Activity deleted successfully!');
            } else {
                alert(result.error || 'Error deleting activity');
            }
        } catch (error) {
            console.error('Error deleting activity:', error);
            alert('Error deleting activity');
        }
    }

    // Helper functions
    function getActivityById(activityId) {
        if (!window.availableActivities || !activityId) return null;
        return window.availableActivities.find(activity => activity._id === activityId);
    }

    function getCoachById(coachId) {
        if (!window.availableCoaches || !coachId) return null;
        return window.availableCoaches.find(coach => coach._id === coachId);
    }

    function showSuccessMessage(message) {
        // Create a simple success notification
        const notification = document.createElement('div');
        notification.className = 'success-notification';
        notification.textContent = message;
        notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: var(--shadow-lg);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    function saveSchedule() {
        showSuccessMessage('Schedule saved successfully!');
    }

    // CSS animations
    const scheduleStyle = document.createElement('style');
    scheduleStyle.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
    document.head.appendChild(scheduleStyle);

    // Activity Selection Modal Functions
    let selectedDayIndex = null;
    let selectedSlotId = null;

    function openActivitySelectionModal(dayIndex, slotId) {
        selectedDayIndex = dayIndex;
        selectedSlotId = slotId;

        const dayName = DAYS[dayIndex] || 'Day';
        const slot = existingTimeSlots.find(s => s._id === slotId);
        let slotName = 'Time Slot';
        if (slot) {
            const startMin = timeToMinutes(slot.start_time);
            const endMin = startMin + (slot.duration_minutes || 60);
            slotName = `${slot.start_time} to ${minutesToTime(endMin)}`;
        }

        document.getElementById('activitySelectionTitle').textContent = 'Select Activity';
        document.getElementById('activitySelectionSubtitle').textContent = `For ${dayName} at ${slotName}`;

        populateActivityOptions();
        const modalElement = document.getElementById('activitySelectionModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    }

    function closeActivitySelectionModal() {
        const modalElement = document.getElementById('activitySelectionModal');
        if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        }
        selectedDayIndex = null;
        selectedSlotId = null;
    }

    function populateActivityOptions() {
        const grid = document.getElementById('activitySelectionGrid');
        grid.innerHTML = '';

        if (!window.availableActivities || window.availableActivities.length === 0) {
            grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-muted); padding: 2rem;">No activities available. Create activities first.</p>';
            return;
        }

        window.availableActivities.forEach(activity => {
            const option = document.createElement('div');
            option.className = 'activity-option';
            option.onclick = () => selectActivity(activity);

            option.innerHTML = `
            <div class="activity-option-color" style="background-color: ${activity.color}"></div>
            <div class="activity-option-header">
                <span class="activity-option-name">${activity.name}</span>
            </div>
            <span class="activity-option-type">${activity.type}</span>
        `;

            grid.appendChild(option);
        });
    }

    function selectActivity(activity) {
        const activityData = {
            id: activity._id,
            name: activity.name,
            type: activity.type,
            color: activity.color
        };

        closeActivitySelectionModal();
        createScheduleItem(selectedDayIndex, selectedSlotId, activityData);
    }

    // Load activities and coaches from the template data
    window.availableActivities = {{ activities | tojson }};
    window.availableCoaches = {{ coaches | tojson }};
    window.availableStudents = {{ students | tojson }};
    // Load students data (this should come from the backend)
    // window.availableStudents = []; // Will be populated via API
    window.assignedStudents = []; // Currently assigned students

    // Initialize schedule data for monthly view
    window.scheduleData = {};

    // Debug logging
    console.log('Available coaches loaded:', window.availableCoaches);
    console.log('Available activities loaded:', window.availableActivities);

    // Initialize schedule data from current schedule
    function initializeScheduleData() {
        // Reset schedule data
        window.scheduleData = {};

        // Convert schedule array to organized data by day
        if (window.currentScheduleData && window.currentScheduleData.length > 0) {
            window.currentScheduleData.forEach(item => {
                const dayOfWeek = item.day_of_week;
                if (!window.scheduleData[dayOfWeek]) {
                    window.scheduleData[dayOfWeek] = [];
                }
                window.scheduleData[dayOfWeek].push(item);
            });
        } else {
            // Add some test data if no real schedule data exists
            console.log('No schedule data found, adding test data');

            // Ensure we have test activities if no real ones exist
            if (!window.availableActivities || window.availableActivities.length === 0) {
                window.availableActivities = [
                    { _id: '1', name: 'Test Yoga', color: '#10B981' },
                    { _id: '2', name: 'Test HIIT', color: '#EF4444' }
                ];
            }

            // Ensure we have test coaches if no real ones exist
            if (!window.availableCoaches || window.availableCoaches.length === 0) {
                window.availableCoaches = [
                    { _id: '1', name: 'Test Coach A' },
                    { _id: '2', name: 'Test Coach B' }
                ];
            }

            // Ensure we have test time slots if no real ones exist
            if (!window.existingTimeSlots || window.existingTimeSlots.length === 0) {
                window.existingTimeSlots = [
                    { _id: '1', start_time: '09:00' },
                    { _id: '2', start_time: '10:30' }
                ];
            }

            // Add some test recurring schedule data
            window.scheduleData[0] = [{ // Monday
                _id: 'test1',
                activity_id: '1',
                time_slot_id: '1',
                coach_id: '1',
                day_of_week: 0
            }];
            window.scheduleData[2] = [{ // Wednesday
                _id: 'test2',
                activity_id: '2',
                time_slot_id: '2',
                coach_id: '2',
                day_of_week: 2
            }];

            // Also ensure currentScheduleData has test data
            if (!window.currentScheduleData || window.currentScheduleData.length === 0) {
                const today = new Date();
                const nextWeek = new Date(today);
                nextWeek.setDate(today.getDate() + 7);

                window.currentScheduleData = [
                    // Recurring Monday class
                    {
                        _id: 'test-recurring-1',
                        activity_id: '1',
                        time_slot_id: '1',
                        coach_id: '1',
                        day_of_week: 0 // Monday
                    },
                    // Specific date class for today
                    {
                        _id: 'test-specific-1',
                        activity_id: '2',
                        time_slot_id: '2',
                        coach_id: '2',
                        specific_date: today.toISOString(),
                        day_of_week: today.getDay() === 0 ? 6 : (today.getDay() - 1) // Convert to Monday=0 format
                    },
                    // Specific date class for next week
                    {
                        _id: 'test-specific-2',
                        activity_id: '1',
                        time_slot_id: '1',
                        coach_id: '1',
                        specific_date: nextWeek.toISOString(),
                        day_of_week: nextWeek.getDay() === 0 ? 6 : (nextWeek.getDay() - 1)
                    }
                ];
            }
        }
        console.log('Schedule data initialized:', window.scheduleData);
    }

    // Initialize student search functionality
    document.addEventListener('DOMContentLoaded', function () {
        const studentSearchInput = document.getElementById('student_search');
        if (!window.timeSinceLastKeyboardInput || new Date().getTime() - window.timeSinceLastKeyboardInput.getTime() > 400) {
            window.timeSinceLastKeyboardInput = new Date();
        } else {
            return;
        }
        if (studentSearchInput) {
            studentSearchInput.addEventListener('input', handleStudentSearch);
            studentSearchInput.addEventListener('focus', showStudentDropdown);
            studentSearchInput.addEventListener('blur', hideStudentDropdownDelayed);
        }

        // Initialize time slots count
        const timeSlotsCount = {{ time_slots| length
    }};
    document.documentElement.style.setProperty('--time-slots-count', timeSlotsCount);
    console.log('Initialized time slots count:', timeSlotsCount);

    // Initialize assignment type toggle
    initializeAssignmentTypeToggle();

    // Initialize schedule data for monthly view
    initializeScheduleData();
});

    // Student search and assignment functions
    async function loadAvailableStudents() {
        try {
            // For now, we'll create mock data. In a real app, this would be an API call
            // const response = await fetch(`/api/organizations/${organizationId}/students`);
            // const data = await response.json();
            // window.availableStudents = data.students || [];

            // Mock data for demonstration
            window.availableStudents = [
                { _id: '1', name: 'John Doe', phone: '1234567890', email: 'john@example.com' },
                { _id: '2', name: 'Jane Smith', phone: '0987654321', email: 'jane@example.com' },
                { _id: '3', name: 'Bob Johnson', phone: '5555555555', email: 'bob@example.com' },
                { _id: '4', name: 'Alice Brown', phone: '4444444444', email: 'alice@example.com' },
                { _id: '5', name: 'Charlie Wilson', phone: '3333333333', email: 'charlie@example.com' }
            ];
        } catch (error) {
            console.error('Error loading students:', error);
            window.availableStudents = [];
        }
    }

    function handleStudentSearch(e) {
        window.timeSinceLastKeyboardInput = new Date();
        const searchTerm = e.target.value.toLowerCase().trim();

        if (searchTerm.length === 0) {
            hideStudentDropdown();
            return;
        }

        const filteredStudents = window.availableStudents.filter(student =>
            student.name.toLowerCase().includes(searchTerm) ||
            student.phone_number.toLowerCase().includes(searchTerm) ||
            (student.email && student.email.toLowerCase().includes(searchTerm))
        ).filter(student =>
            !window.assignedStudents.find(assigned => assigned._id === student._id)
        );

        populateStudentDropdown(filteredStudents);
        showStudentDropdown();
    }

    function populateStudentDropdown(students) {
        const dropdown = document.getElementById('studentsDropdown');
        dropdown.innerHTML = '';

        if (students.length === 0) {
            dropdown.innerHTML = '<div class="student-search-item"><div class="student-search-name">No students found</div></div>';
            return;
        }

        students.forEach(student => {
            const item = document.createElement('div');
            item.className = 'student-search-item';
            item.innerHTML = `
            <div>
                <div class="student-search-name">${student.name}</div>
                <div class="student-search-meta">${student.phone_number} ${student.email ? ' ' + student.email : ''}</div>
            </div>
        `;
            item.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Prevent blur event
                addStudentToAssignment(student);
            });
            dropdown.appendChild(item);
        });
    }

    function showStudentDropdown() {
        document.getElementById('studentsDropdown').style.display = 'block';
    }

    function hideStudentDropdown() {
        document.getElementById('studentsDropdown').style.display = 'none';
    }

    function hideStudentDropdownDelayed() {
        setTimeout(hideStudentDropdown, 150); // Delay to allow click events
    }

    function addStudentToAssignment(student) {
        // Check if already assigned
        if (window.assignedStudents.find(assigned => assigned._id === student._id)) {
            return;
        }

        window.assignedStudents.push(student);
        updateAssignedStudentsList();
        updateStudentsCount();

        // Clear search
        document.getElementById('student_search').value = '';
        hideStudentDropdown();
    }

    function removeStudentFromAssignment(studentId) {
        window.assignedStudents = window.assignedStudents.filter(student => student._id !== studentId);
        updateAssignedStudentsList();
        updateStudentsCount();
    }

    function updateAssignedStudentsList() {
        const container = document.getElementById('assignedStudentsList');
        container.innerHTML = '';

        if (window.assignedStudents.length === 0) {
            container.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-muted); font-style: italic;">No students assigned</div>';
            return;
        }

        window.assignedStudents.forEach(student => {
            const item = document.createElement('div');
            item.className = 'assigned-student-item';
            item.innerHTML = `
            <div class="assigned-student-name" data-student-id="${student._id}">${student.name}</div>
            <button class="remove-student-btn" onclick="removeStudentFromAssignment('${student._id}')">Remove</button>
        `;
            container.appendChild(item);
        });
    }

    function updateStudentsCount() {
        const countElement = document.getElementById('studentsCount');
        const capacityElement = document.getElementById('capacityIndicator');

        const count = window.assignedStudents.length;
        const capacity = parseInt(document.getElementById('schedule_capacity').value) || 0;

        countElement.textContent = `${count} student${count !== 1 ? 's' : ''} assigned`;

        if (capacity > 0) {
            const remaining = capacity - count;
            capacityElement.textContent = `${remaining} spots remaining`;

            if (remaining < 0) {
                capacityElement.className = 'capacity-indicator error';
            } else if (remaining <= 2) {
                capacityElement.className = 'capacity-indicator warning';
            } else {
                capacityElement.className = 'capacity-indicator';
            }
        } else {
            capacityElement.textContent = '';
            capacityElement.className = 'capacity-indicator';
        }
    }

    // Toggle activities sidebar
    function toggleActivitiesSidebar() {
        const sidebar = document.getElementById('activitiesSidebar');
        const collapseBtn = document.getElementById('collapseBtn');

        sidebar.classList.toggle('collapsed');

        if (sidebar.classList.contains('collapsed')) {
            collapseBtn.title = 'Expand sidebar';
        } else {
            collapseBtn.title = 'Collapse sidebar';
        }
    }

    // Assignment type toggle functionality
    function initializeAssignmentTypeToggle() {
        const assignmentTypeRadios = document.querySelectorAll('input[name="assignment_type"]');
        const descriptionElement = document.getElementById('assignmentTypeDesc');

        assignmentTypeRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.value === 'one_time') {
                    descriptionElement.textContent = 'Student will be assigned to this specific session only';
                } else if (this.value === 'recurring') {
                    descriptionElement.textContent = 'Student will be assigned to all recurring sessions of this activity and time slot';
                }
            });
        });
    }

    function getSelectedAssignmentType() {
        const selectedRadio = document.querySelector('input[name="assignment_type"]:checked');
        return selectedRadio ? selectedRadio.value : 'one_time';
    }

    // View switching functionality
    let currentView = 'weekly';
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    function switchToWeeklyView() {
        currentView = 'weekly';
        document.getElementById('weeklyViewBtn').classList.add('active');
        document.getElementById('monthlyViewBtn').classList.remove('active');
        document.querySelector('.schedule-container').style.display = 'flex';
        document.getElementById('monthlyViewContainer').style.display = 'none';
        document.querySelector('.schedule-page').style.minHeight = '100vh';
    }

    async function switchToMonthlyView() {
        currentView = 'monthly';
        document.getElementById('monthlyViewBtn').classList.add('active');
        document.getElementById('weeklyViewBtn').classList.remove('active');
        document.querySelector('.schedule-container').style.display = 'none';
        document.getElementById('monthlyViewContainer').style.display = 'block';
        document.querySelector('.schedule-page').style.minHeight = 'auto';

        // Make sure we have the latest schedule data
        await loadScheduleData();
        await loadExistingTimeSlots();
        await loadMonthlyScheduleData();
        initializeScheduleData();
        generateMonthlyCalendar();
    }

    // Load schedule data specifically for monthly view (including specific dates)
    async function loadMonthlyScheduleData() {
        try {
            // Calculate date range for current month view
            const startDate = new Date(currentYear, currentMonth, 1);
            const endDate = new Date(currentYear, currentMonth + 1, 0);

            console.log('Loading monthly schedule data for:', startDate.toISOString().split('T')[0], 'to', endDate.toISOString().split('T')[0]);

            // Load schedule data for the specific date range
            const response = await fetch(`/api/centers/${centerId}/schedule?start_date=${startDate.toISOString().split('T')[0]}&end_date=${endDate.toISOString().split('T')[0]}`);

            if (response.ok) {
                const data = await response.json();
                console.log('Monthly schedule API response:', data);

                // Merge with existing schedule data
                if (data.schedule && data.schedule.length > 0) {
                    // Add specific date schedules to currentScheduleData
                    window.currentScheduleData = window.currentScheduleData || [];

                    // Remove any existing data for this date range to avoid duplicates
                    window.currentScheduleData = window.currentScheduleData.filter(item => {
                        if (!item.specific_date) return true; // Keep recurring schedules
                        const itemDate = new Date(item.specific_date);
                        return itemDate < startDate || itemDate > endDate;
                    });

                    // Add new date-specific schedules
                    window.currentScheduleData.push(...data.schedule);

                    console.log('Monthly schedule data loaded:', data.schedule);
                    console.log('Total window.currentScheduleData after merge:', window.currentScheduleData);
                }
            } else {
                console.log('Monthly schedule API failed with status:', response.status);
                console.log('Using existing schedule data for monthly view');
            }
        } catch (error) {
            console.error('Error loading monthly schedule data:', error);
            console.log('Falling back to existing data');
        }
    }

    // Monthly view functions
    async function navigateMonth(direction) {
        currentMonth += direction;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        } else if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }

        // Reload data for new month
        await loadMonthlyScheduleData();
        generateMonthlyCalendar();
    }

    function generateMonthlyCalendar() {
        console.log('Generating monthly calendar for:', currentMonth, currentYear);
        console.log('Current schedule data:', window.scheduleData);

        const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];

        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        document.getElementById('currentMonthLabel').textContent = `${monthNames[currentMonth]} ${currentYear}`;

        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        const calendarGrid = document.getElementById('calendarGrid');
        calendarGrid.innerHTML = '';

        // Add day headers
        dayNames.forEach(dayName => {
            const header = document.createElement('div');
            header.className = 'calendar-day-header';
            header.textContent = dayName;
            calendarGrid.appendChild(header);
        });

        // Add calendar days
        const currentDate = new Date(startDate);
        for (let i = 0; i < 42; i++) { // 6 weeks
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';

            const isCurrentMonth = currentDate.getMonth() === currentMonth;
            const isToday = currentDate.toDateString() === new Date().toDateString();

            if (!isCurrentMonth) {
                dayElement.classList.add('other-month');
            }
            if (isToday) {
                dayElement.classList.add('today');
            }

            const dayNumber = document.createElement('div');
            dayNumber.className = 'calendar-day-number';
            dayNumber.textContent = currentDate.getDate();
            dayElement.appendChild(dayNumber);

            // Add classes for this day
            const dayClasses = getClassesForDate(currentDate);
            if (dayClasses.length > 0) {
                const classesContainer = document.createElement('div');
                classesContainer.className = 'calendar-day-classes';

                dayClasses.slice(0, 3).forEach(classItem => {
                    const indicator = document.createElement('div');
                    indicator.className = 'calendar-class-indicator';
                    indicator.style.backgroundColor = classItem.color || '#3B82F6';
                    classesContainer.appendChild(indicator);
                });

                if (dayClasses.length > 3) {
                    const countElement = document.createElement('div');
                    countElement.className = 'calendar-class-count';
                    countElement.textContent = `+${dayClasses.length - 3} more`;
                    classesContainer.appendChild(countElement);
                }

                dayElement.appendChild(classesContainer);
            }

            // Add hover event for tooltip
            dayElement.addEventListener('mouseenter', (e) => {
                console.log('Hovering over date:', currentDate, 'Classes:', dayClasses);
                showDayTooltip(e, new Date(currentDate), dayClasses);
            });
            dayElement.addEventListener('mouseleave', hideDayTooltip);
            dayElement.addEventListener('mousemove', (e) => {
                // Update tooltip position as mouse moves
                const tooltip = document.getElementById('dayTooltip');
                if (tooltip && tooltip.style.display === 'block') {
                    tooltip.style.left = (e.clientX + 10) + 'px';
                    tooltip.style.top = (e.clientY + 10) + 'px';
                }
            });

            calendarGrid.appendChild(dayElement);
            currentDate.setDate(currentDate.getDate() + 1);
        }
    }

    function getClassesForDate(date) {
        const dayClasses = [];
        const dateString = date.toISOString().split('T')[0]; // Get YYYY-MM-DD format
        const dayOfWeek = (date.getDay() + 6) % 7; // Convert to Monday = 0 format (0 = Monday, 6 = Sunday)

        console.log('Getting classes for date:', dateString, 'Day of week:', dayOfWeek);
        console.log('window.currentScheduleData:', window.currentScheduleData);
        console.log('window.existingTimeSlots:', window.existingTimeSlots);
        console.log('window.availableActivities:', window.availableActivities);

        // Track schedule IDs to prevent duplicates
        const seenScheduleIds = new Set();

        // First, check for specific date-based schedules (these take priority)
        if (window.currentScheduleData && window.currentScheduleData.length > 0) {
            window.currentScheduleData.forEach(scheduleItem => {
                let shouldInclude = false;

                // Check if this schedule item is for a specific date
                if (scheduleItem.specific_date) {
                    const scheduleDate = new Date(scheduleItem.specific_date).toISOString().split('T')[0];
                    shouldInclude = (scheduleDate === dateString);
                }

                if (shouldInclude && !seenScheduleIds.has(scheduleItem._id)) {
                    const activity = getActivityById(scheduleItem.activity_id);
                    const timeSlot = window.existingTimeSlots?.find(slot => slot._id === scheduleItem.time_slot_id);

                    if (activity && timeSlot) {
                        // Format time properly
                        const formattedTime = formatTimeSlot(timeSlot);

                        dayClasses.push({
                            name: activity.name,
                            time: formattedTime,
                            color: activity.color || '#3B82F6',
                            coach: getCoachById(scheduleItem.coach_id)?.name || 'Unassigned',
                            isSpecificDate: true,
                            scheduleId: scheduleItem._id,
                            duration: timeSlot.duration_minutes || 60
                        });

                        seenScheduleIds.add(scheduleItem._id);
                    }
                }
            });

            // Then, add recurring weekly schedules only if no specific date schedule exists for that time slot
            window.currentScheduleData.forEach(scheduleItem => {
                if (!scheduleItem.specific_date &&
                    scheduleItem.day_of_week === dayOfWeek &&
                    !seenScheduleIds.has(scheduleItem._id)) {

                    const activity = getActivityById(scheduleItem.activity_id);
                    const timeSlot = window.existingTimeSlots?.find(slot => slot._id === scheduleItem.time_slot_id);

                    // Check if there's already a specific date schedule for this time slot
                    const hasSpecificScheduleForSlot = Array.from(seenScheduleIds).some(id => {
                        const existingItem = window.currentScheduleData.find(item => item._id === id);
                        return existingItem && existingItem.time_slot_id === scheduleItem.time_slot_id;
                    });

                    if (activity && timeSlot && !hasSpecificScheduleForSlot) {
                        // Format time properly
                        const formattedTime = formatTimeSlot(timeSlot);

                        dayClasses.push({
                            name: activity.name,
                            time: formattedTime,
                            color: activity.color || '#3B82F6',
                            coach: getCoachById(scheduleItem.coach_id)?.name || 'Unassigned',
                            isSpecificDate: false,
                            scheduleId: scheduleItem._id,
                            duration: timeSlot.duration_minutes || 60
                        });

                        seenScheduleIds.add(scheduleItem._id);
                    }
                }
            });
        }

        // Fallback: check the organized schedule data by day of week (for backward compatibility)
        if (dayClasses.length === 0 && window.scheduleData && window.scheduleData[dayOfWeek]) {
            window.scheduleData[dayOfWeek].forEach(scheduleItem => {
                if (!seenScheduleIds.has(scheduleItem._id)) {
                    const activity = getActivityById(scheduleItem.activity_id);
                    const timeSlot = window.existingTimeSlots?.find(slot => slot._id === scheduleItem.time_slot_id);

                    if (activity && timeSlot) {
                        // Format time properly
                        const formattedTime = formatTimeSlot(timeSlot);

                        dayClasses.push({
                            name: activity.name,
                            time: formattedTime,
                            color: activity.color || '#3B82F6',
                            coach: getCoachById(scheduleItem.coach_id)?.name || 'Unassigned',
                            isSpecificDate: false,
                            scheduleId: scheduleItem._id,
                            duration: timeSlot.duration_minutes || 60
                        });

                        seenScheduleIds.add(scheduleItem._id);
                    }
                }
            });
        }

        // Sort classes by time
        dayClasses.sort((a, b) => {
            const timeA = a.time.split(' - ')[0];
            const timeB = b.time.split(' - ')[0];
            return timeA.localeCompare(timeB);
        });

        console.log('Classes found for', dateString, ':', dayClasses);
        return dayClasses;
    }

    // Helper function to format time slot display
    function formatTimeSlot(timeSlot) {
        if (!timeSlot || !timeSlot.start_time) {
            return 'Time not specified';
        }

        // Calculate end time
        const startTime = timeSlot.start_time;
        const duration = timeSlot.duration_minutes || 60;

        try {
            const [hours, minutes] = startTime.split(':').map(Number);
            const startDate = new Date();
            startDate.setHours(hours, minutes, 0, 0);

            const endDate = new Date(startDate.getTime() + duration * 60 * 1000);

            const endTime = endDate.toTimeString().substr(0, 5);

            return `${startTime} - ${endTime}`;
        } catch (error) {
            console.error('Error formatting time slot:', error);
            return `${startTime} (${duration}min)`;
        }
    }

    function showDayTooltip(event, date, classes) {
        console.log('showDayTooltip called with:', date, classes);
        if (classes.length === 0) {
            console.log('No classes for this date, not showing tooltip');
            return;
        }

        let tooltip = document.getElementById('dayTooltip');
        if (!tooltip) {
            console.warn('Tooltip element not found, creating one');
            // Create tooltip element if it doesn't exist
            tooltip = document.createElement('div');
            tooltip.id = 'dayTooltip';
            tooltip.className = 'day-tooltip';
            tooltip.style.display = 'none';
            tooltip.innerHTML = `
            <div class="tooltip-header"></div>
            <div class="tooltip-content"></div>
        `;
            document.body.appendChild(tooltip);
        }

        console.log('Tooltip element found:', tooltip);

        const header = tooltip.querySelector('.tooltip-header');
        const content = tooltip.querySelector('.tooltip-content');

        header.textContent = date.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        content.innerHTML = '';
        classes.forEach(classItem => {
            const classElement = document.createElement('div');
            classElement.className = 'tooltip-class';

            // Add a badge to distinguish specific date vs recurring schedules
            const scheduleType = classItem.isSpecificDate ?
                '<span class="schedule-type-badge specific">Specific Date</span>' :
                '<span class="schedule-type-badge recurring">Recurring</span>';

            classElement.innerHTML = `
            <div class="tooltip-class-color" style="background-color: ${classItem.color}"></div>
            <div class="tooltip-class-info">
                <div class="tooltip-class-name">${classItem.name}</div>
                <div class="tooltip-class-time">${classItem.time}  ${classItem.coach}</div>
                <div class="tooltip-class-meta">${scheduleType}</div>
            </div>
        `;
            content.appendChild(classElement);
        });

        tooltip.style.display = 'block';

        // Position tooltip with bounds checking (using fixed positioning)
        const tooltipWidth = 300; // Max width as set in CSS
        const tooltipHeight = 200; // Estimated height

        let left = event.clientX + 10;
        let top = event.clientY + 10;

        // Check right boundary
        if (left + tooltipWidth > window.innerWidth) {
            left = event.clientX - tooltipWidth - 10;
        }

        // Check bottom boundary
        if (top + tooltipHeight > window.innerHeight) {
            top = event.clientY - tooltipHeight - 10;
        }

        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';

        console.log('Tooltip displayed at:', left, top);
    }

    function hideDayTooltip() {
        document.getElementById('dayTooltip').style.display = 'none';
    }

    // Add this function to handle schedule deletion
    async function handleScheduleDelete(scheduleId) {
        try {
            // First get affected classes
            const response = await fetch(`/api/centers/${centerId}/schedule/${scheduleId}/affected-classes`);
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'Failed to get affected classes');
            }

            const { classes, total_count } = result;

            // Create confirmation dialog content
            let dialogContent = `
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Schedule Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this schedule item?</p>`;

            if (total_count > 0) {
                dialogContent += `
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This will affect ${total_count} future classes:
                </div>
                <div class="affected-classes" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Class</th>
                                <th>Coach</th>
                                <th>Students</th>
                            </tr>
                        </thead>
                        <tbody>`;

                classes.forEach(classInfo => {
                    dialogContent += `
                    <tr>
                        <td>${classInfo.scheduled_at}</td>
                        <td>${classInfo.title}</td>
                        <td>${classInfo.coach_name}</td>
                        <td>${classInfo.student_count} students, ${classInfo.group_count} groups</td>
                    </tr>`;
                });

                dialogContent += `
                        </tbody>
                    </table>
                </div>
                <div class="form-group mt-3">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="deleteClasses" checked>
                        <label class="custom-control-label" for="deleteClasses">
                            Also cancel affected classes
                        </label>
                    </div>
                </div>`;
            }

            dialogContent += `
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmScheduleDelete('${scheduleId}')">
                        Delete Schedule
                    </button>
                </div>
            </div>`;

            // Show the modal
            const modalDiv = document.createElement('div');
            modalDiv.className = 'modal fade';
            modalDiv.id = 'deleteConfirmationModal';
            modalDiv.innerHTML = dialogContent;
            document.body.appendChild(modalDiv);

            $('#deleteConfirmationModal').modal('show');

            // Clean up modal when closed
            $('#deleteConfirmationModal').on('hidden.bs.modal', function () {
                document.body.removeChild(modalDiv);
            });

        } catch (error) {
            console.error('Error preparing delete confirmation:', error);
            alert('Error preparing delete confirmation');
        }
    }

    async function confirmScheduleDelete(scheduleId) {
        try {
            const deleteClasses = document.getElementById('deleteClasses')?.checked ?? false;

            const response = await fetch(`/api/centers/${centerId}/schedule/${scheduleId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',  // This header was missing
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ delete_classes: deleteClasses })  // Need to properly stringify the data
            });

            const result = await response.json();

            if (response.ok) {
                // Close the modal
                $('#deleteConfirmationModal').modal('hide');

                // Remove the schedule item from the UI
                const scheduleElement = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
                if (scheduleElement) {
                    scheduleElement.remove();
                }

                // Show success message
                showSuccessMessage(result.message);

                // Refresh the schedule display
                loadScheduleData();
            } else {
                throw new Error(result.error || 'Failed to delete schedule');
            }
        } catch (error) {
            console.error('Error deleting schedule:', error);
            alert('Error deleting schedule: ' + error.message);
        }
    }

    // Update your existing delete button click handler to use the new function
    function setupDeleteButtons() {
        document.querySelectorAll('.delete-schedule-btn').forEach(button => {
            button.onclick = (e) => {
                e.preventDefault();
                const scheduleId = button.dataset.scheduleId;
                handleScheduleDelete(scheduleId);
            };
        });
    }

    let isSelectionMode = false;
    let selectedClasses = new Set();

    async function confirmScheduleSelection() {
        if (selectedClasses.size === 0) {
            alert('Please select at least one class');
            return;
        }

        // If already in selection mode, confirm selections and show modal
        const btn = document.getElementById('signupLinkBtn');
        btn.innerHTML = '<i class="bi bi-link-45deg"></i> Create Sign Up Link';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-accent-modern');

        const scheduleItemIds = Array.from(selectedClasses)

        try {
            const response = await fetch('/generate-activity-link', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    schedule_item_ids: scheduleItemIds
                })
            });

            if (!response.ok) {
                throw new Error('Failed to generate link');
            }

            const data = await response.json();
            document.getElementById('signupLink').value = data.link;
            if (data.access_code) {
                const accessCodeSection = document.getElementById('accessCodeSection');
                const accessCodeInput = document.getElementById('accessCode');
                const shareTextSection = document.getElementById('shareTextSection');
                const shareTextArea = document.getElementById('shareText');
                if (accessCodeSection && accessCodeInput) {
                    accessCodeInput.value = data.access_code;
                    accessCodeSection.style.di
                    splay = 'block';
                }
                if (shareTextSection && shareTextArea) {
                    if (data.organization_name && data.organization_name !== '') {
                        shareTextArea.value = `Hi, please use the below link to enroll to ${data.organization_name} on the botle app. Your access code to sign up is ${data.access_code}`;
                    } else {
                        shareTextArea.value = `Hi, please use the below link to enroll to classes on the botle app. Your access code to sign up is ${data.access_code}`;
                    }
                    shareTextSection.style.display = 'block';
                }
            }
            new bootstrap.Modal(document.getElementById('selectionModeModal')).show();
        } catch (error) {
            console.error('Error generating link:', error);
            alert('Failed to generate signup link. Please try again.');
        }
        exitSelectionMode();
    }

    async function startScheduleSelection() {
        document.getElementsByClassName('sign-up-link-instruction')[0].classList.add('show');
        if (isSelectionMode) {
            // If already in selection mode, confirm selections and show modal
            const btn = document.getElementById('signupLinkBtn');
            btn.innerHTML = '<i class="bi bi-link-45deg"></i> Create Sign Up Link';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-accent-modern');
            exitSelectionMode();
        } else {
            // Enter selection mode
            isSelectionMode = true;
            selectedClasses.clear();
            document.querySelectorAll('.schedule-item').forEach(item => {
                item.classList.add('selectable');
                item.addEventListener('click', toggleClassSelection);
            });
            const btn = document.getElementById('signupLinkBtn');
            btn.innerHTML = '<i class="bi bi-x-lg"></i> Cancel selection';
            btn.classList.remove('btn-accent-modern');
            btn.classList.add('btn-danger');
        }
        updateSelectedCount();
    }

    function exitSelectionMode() {
        document.getElementsByClassName('sign-up-link-instruction')[0].classList.remove('show');
        isSelectionMode = false;
        selectedClasses.clear();
        document.querySelectorAll('.schedule-item').forEach(item => {
            item.classList.remove('selectable', 'selected');
            item.removeEventListener('click', toggleClassSelection);
        });
        const btn = document.getElementById('signupLinkBtn');
        btn.innerHTML = '<i class="bi bi-link-45deg"></i> Create Sign Up Link';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-accent-modern');
    }

    function toggleClassSelection(event) {

        const item = event.currentTarget;
        const scheduleItemId = item.getAttribute('data-schedule-item-id');

        if (selectedClasses.has(scheduleItemId)) {
            selectedClasses.delete(scheduleItemId);
            item.classList.remove('selected');
        } else {
            selectedClasses.add(scheduleItemId);
            item.classList.add('selected');
        }

        updateSelectedCount();
    }

    function updateSelectedCount() {
        document.getElementById('selectedClassCount').textContent = selectedClasses.size;
    }

    // Replace the existing link generation code with:
    async function generateSignupLink() {
        const selectedClasses = document.querySelectorAll('input[name="selected_classes"]:checked');
        if (selectedClasses.length === 0) {
            alert('Please select at least one class');
            return;
        }

        const scheduleItemIds = Array.from(selectedClasses);

        try {
            const response = await fetch('/generate-activity-link', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    schedule_item_ids: scheduleItemIds
                })
            });

            if (!response.ok) {
                throw new Error('Failed to generate link');
            }

            const data = await response.json();
            document.getElementById('signupLink').value = data.link;
            if (data.access_code) {
                const accessCodeSection = document.getElementById('accessCodeSection');
                const accessCodeInput = document.getElementById('accessCode');
                const shareTextSection = document.getElementById('shareTextSection');
                const shareTextArea = document.getElementById('shareText');
                if (accessCodeSection && accessCodeInput) {
                    accessCodeInput.value = data.access_code;
                    accessCodeSection.style.display = 'block';
                }
                if (shareTextSection && shareTextArea) {
                    shareTextArea.value = `Hi, please use the below link to enroll to classes. Your access code to sign up is ${data.access_code}`;
                    shareTextSection.style.display = 'block';
                }
            }
        } catch (error) {
            console.error('Error generating link:', error);
            alert('Failed to generate signup link. Please try again.');
        }
    }

    function copySignupLink() {
        const linkInput = document.getElementById('signupLink');
        linkInput.select();
        document.execCommand('copy');

        const copyButton = document.querySelector('#signupLink + button');
        const originalHtml = copyButton.innerHTML;
        copyButton.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
            copyButton.innerHTML = originalHtml;
        }, 2000);
    }

    function copyAccessCode() {
        const codeInput = document.getElementById('accessCode');
        codeInput.select();
        document.execCommand('copy');

        const copyButton = document.querySelector('#accessCode + button');
        const originalHtml = copyButton.innerHTML;
        copyButton.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
            copyButton.innerHTML = originalHtml;
        }, 2000);
    }

    function copyShareText() {
        const shareTextArea = document.getElementById('shareText');
        shareTextArea.select();
        document.execCommand('copy');

        const copyButton = document.querySelector('#shareText + button');
        const originalHtml = copyButton.innerHTML;
        copyButton.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
            copyButton.innerHTML = originalHtml;
        }, 2000);
    }
</script>

<style>
    .schedule-item.selectable {
        opacity: 0.5;
        cursor: pointer;
        transition: opacity 0.3s;
    }

    .schedule-item.selected {
        opacity: 1;
        border: 2px solid #198754;
    }

    .schedule-item.selected::after {
        content: '';
        position: absolute;
        top: 5px;
        right: 5px;
        color: #198754;
        font-size: 1.2em;
        font-weight: bold;
    }

    /* Fix button alignment for textarea in input-group */
    #shareTextSection .input-group {
        align-items: start;
    }
    
    #shareTextSection .input-group button {
        height: fit-content;
    }
</style>

<!-- Selection Mode Modal -->
<div class="modal fade" id="selectionModeModal" tabindex="-1" aria-labelledby="selectionModeModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectionModeModalLabel">Class Sign Up Link</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <small class="text-muted mt-2">Share this link with the students to sign up for the selected classes</small>
                    <div class="input-group mt-3">
                        <input type="text" class="form-control" id="signupLink" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copySignupLink()">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    <div class="mt-3" id="accessCodeSection" style="display: none;">
                        <label class="form-label fw-semibold">Access Code:</label>
                        <div class="input-group">
                            <input type="text" class="form-control text-center fw-bold fs-5" id="accessCode" readonly style="letter-spacing: 0.5rem; font-family: 'Courier New', monospace;">
                            <button class="btn btn-outline-secondary" type="button" onclick="copyAccessCode()">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                        <small class="text-muted">Students will need this 6-digit code to complete registration</small>
                    </div>
                    <div class="mt-3" id="shareTextSection" style="display: none;">
                        <label class="form-label fw-semibold">Shareable Text:</label>
                        <div class="input-group">
                            <textarea class="form-control" id="shareText" readonly rows="3"></textarea>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyShareText()">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                        <small class="text-muted">Copy and share this message with students</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}