{% extends "base.html" %}

{% block title %}Dashboard - botle Sports Coaching{% endblock %}


{% block head %}
<style>
    .logo img {
        width: 100px !important;
    }
    /* Dashboard specific styles for dark theme */
    .dashboard-main {
        min-height: 100vh;
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        padding: var(--spacing-xl);
    }
    .kpi-card {
        background-color: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        transition: all 0.3s ease;
    }
    .kpi-card:hover {
        background-color: var(--bg-hover);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    .kpi-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .schedule-card, .attendance-card, .next-class-card, .quick-actions-card, .updates-card {
        background-color: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
    }
    .class-badge {
        background-color: var(--bg-tertiary);
        border-radius: var(--radius-md);
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        display: inline-block;
        margin: 0.25rem;
    }
    .schedule-table {
        width: 100%;
    }
    .schedule-table th {
        padding: var(--spacing-md);
        text-align: left;
        border-bottom: 1px solid var(--border-primary);
        width: 128px;
    }
    .schedule-table td {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--border-primary);
    }
    .today-row {
        background-color: var(--accent-primary);
        color: var(--text-inverse);
    }
    .today-row th, .today-row td {
        border-bottom-color: var(--accent-primary);
    }
    .quick-action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: var(--spacing-md);
        background-color: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
        text-decoration: none;
        color: var(--text-primary);
        transition: all 0.3s ease;
    }
    .quick-action-btn:hover {
        background-color: var(--bg-hover);
        transform: scale(1.05);
        color: var(--text-primary);
    }
    .update-item {
        background-color: var(--bg-tertiary);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }
    .attendance-item {
        background-color: var(--bg-tertiary);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }
    .text-accent {
        color: var(--accent-primary) !important;
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}
{% block content %} 
<!-- Main Content -->
<main class="dashboard-main">
    <div class="container">
        <!-- KPI Summary Cards -->
        <div class="row mb-4">
            <!-- Today's Classes -->
            <div class="col-12 col-md-6 col-lg-3 mb-3">
                <div class="kpi-card">
                    <div class="d-flex align-items-start justify-content-between">
                        <div>
                            <p class="text-muted mb-1 small">Today's Classes</p>
                            <h3 class="display-4 font-weight-bold" id="todayClassesCount">{{ stats.today_classes if stats and stats.today_classes is defined else 0 }}</h3>
                        </div>
                        <div class="kpi-icon" style="background-color: var(--accent-primary);">
                            <i class="fas fa-calendar" style="color: var(--text-inverse);"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Attendance Rate -->
            <div class="col-12 col-md-6 col-lg-3 mb-3">
                <div class="kpi-card">
                    <div class="d-flex align-items-start justify-content-between">
                        <div>
                            <p class="text-muted mb-1 small">Attendance Rate</p>
                            <h3 class="display-4 font-weight-bold" id="attendanceRate">{{ stats.attendance_rate if stats and stats.attendance_rate is defined else '0' }}%</h3>
                        </div>
                        <div class="kpi-icon" style="background-color: rgba(16, 185, 129, 0.1);">
                            <i class="fas fa-chart-line text-success"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No-Shows -->
            <div class="col-12 col-md-6 col-lg-3 mb-3">
                <div class="kpi-card">
                    <div class="d-flex align-items-start justify-content-between">
                        <div>
                            <p class="text-muted mb-1 small">No-Shows</p>
                            <h3 class="display-4 font-weight-bold" id="noShowsCount">{{ stats.no_shows if stats and stats.no_shows is defined else 0 }}</h3>
                        </div>
                        <div class="kpi-icon" style="background-color: rgba(239, 68, 68, 0.1);">
                            <i class="fas fa-user-xmark text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Revenue -->
            <div class="col-12 col-md-6 col-lg-3 mb-3">
                <div class="kpi-card">
                    <div class="d-flex align-items-start justify-content-between">
                        <div>
                            <p class="text-muted mb-1 small">Revenue This Month</p>
                            <h3 class="display-4 font-weight-bold" id="monthlyRevenue">â‚¹{{ stats.monthly_revenue if stats and stats.monthly_revenue is defined else '0' }}</h3>
                        </div>
                        <div class="kpi-icon" style="background-color: rgba(16, 185, 129, 0.2);">
                            <i class="fas fa-indian-rupee-sign text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="row">
            <!-- Left Column (Calendar + Attendance) -->
            <div class="col-12 col-lg-8 mb-4">
                <div class="schedule-card">
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <h2 class="h4 font-weight-bold d-flex align-items-center mb-0">
                            <i class="fas fa-calendar-week text-accent mr-3"></i>
                            Weekly Schedule
                        </h2>
                    </div>
                    <div class="calendar-container table-responsive" id="weeklyCalendar">
                         <table class="schedule-table">
                             <tbody>
                                 {% for day in weekly_schedule.days %}
                                 <tr class="{% if day.is_today %}today-row{% endif %}">
                                     <th class="{% if day.is_today %}text-dark{% endif %}">
                                         <div class="font-weight-bold">{{ day.name }}</div>
                                         <div class="small {% if day.is_today %}text-dark{% else %}text-muted{% endif %}">{{ day.date }}</div>
                                     </th>
                                     <td>
                                         <div class="d-flex flex-wrap">
                                             {% if day.classes %}
                                                 {% for class in day.classes %}
                                                 <div class="class-badge text-center">
                                                     <div class="font-weight-medium">{{ class.title }}</div>
                                                     <div class="text-muted small">{{ class.time }}</div>
                                                 </div>
                                                 {% endfor %}
                                             {% else %}
                                                 <div class="small {% if day.is_today %}text-dark{% else %}text-muted{% endif %}">No classes</div>
                                             {% endif %}
                                         </div>
                                     </td>
                                 </tr>
                                 {% endfor %}
                             </tbody>
                         </table>
                        
                        {% if not weekly_schedule.days %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-calendar-xmark fa-3x mb-3"></i>
                            <p>No classes scheduled for this week</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Insights/Charts -->
                <div class="schedule-card d-none">
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <h2 class="h4 font-weight-bold d-flex align-items-center mb-0">
                            <i class="fas fa-chart-bar text-accent mr-3"></i>
                            Insights
                        </h2>
                    </div>
                    <div class="row">
                        <div class="col-12 col-md-6 mb-3">
                            <div style="background-color: var(--bg-tertiary); border-radius: var(--radius-md); padding: var(--spacing-md);">
                                <!-- Chart will be rendered by JavaScript -->
                                <div id="attendanceChart"></div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 mb-3">
                            <div style="background-color: var(--bg-tertiary); border-radius: var(--radius-md); padding: var(--spacing-md);">
                                <!-- Chart will be rendered by JavaScript -->
                                <div id="revenueChart"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-12 col-lg-4">
                <!-- Next Upcoming Class -->
                <div class="next-class-card mb-4">
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <h2 class="h4 font-weight-bold d-flex align-items-center mb-0">
                            <i class="fas fa-hourglass-start text-accent mr-3"></i>
                            Next Class
                        </h2>
                    </div>
                    {% if next_class %}
                    <div style="background-color: var(--bg-tertiary); border-radius: var(--radius-md); padding: var(--spacing-lg);">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <h3 class="h5 font-weight-bold mb-0">{{ next_class.title }}</h3>
                            <span class="text-accent font-weight-medium">{{ next_class.time }}</span>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6 mb-2">
                                <div style="background-color: var(--bg-card); border-radius: var(--radius-md); padding: var(--spacing-sm);">
                                    <span class="small text-muted">Students</span>
                                    <div class="d-flex align-items-baseline mt-1">
                                        <span class="h4 font-weight-bold">{{ next_class.total_students }}</span>
                                        <span class="small text-muted ml-1">enrolled</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 mb-2">
                                <div style="background-color: var(--bg-card); border-radius: var(--radius-md); padding: var(--spacing-sm);">
                                    <span class="small text-muted">RSVP Status</span>
                                    <div class="d-flex align-items-baseline mt-1">
                                        <span class="h4 font-weight-bold text-accent">{{ next_class.rsvp_count }}</span>
                                        <span class="small text-muted ml-1">confirmed</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-user-tie text-muted" style="width: 20px;"></i>
                                <span class="ml-2">{{ next_class.coach_name }}</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-location-dot text-muted" style="width: 20px;"></i>
                                <span class="ml-2">{{ next_class.center }}</span>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-calendar-xmark fa-3x mb-3"></i>
                        <p>No upcoming classes scheduled</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Attendance List -->
                <div class="attendance-card mb-4">
                   <div class="d-flex align-items-center justify-content-between mb-4">
                       <h2 class="h4 font-weight-bold d-flex align-items-center mb-0">
                           <i class="fas fa-clipboard-list text-accent mr-3"></i>
                           Today's Attendance
                       </h2>
                   </div>
                   <div id="attendanceList">
                       {% if todays_classes %}
                           {% for class in todays_classes %}
                           <div class="attendance-item d-flex align-items-center justify-content-between">
                               <div class="flex-grow-1">
                                   <h4 class="font-weight-bold mb-1">{{ class.name if class.name is defined else 'Untitled Class' }}</h4>
                                   <p class="small text-muted mb-0">{{ class.time if class.time is defined else 'Time not set' }}</p>
                               </div>
                               <div class="d-flex align-items-center ml-3">
                                   <div class="text-right mr-3">
                                       <span class="small text-muted">Checked-in</span>
                                       <p class="font-weight-bold mb-0">{{ class.checked_in if class.checked_in is defined else 0 }}/{{ class.total if class.total is defined else 0 }}</p>
                                   </div>
                                   <a href="/class/{{ class.id if class.id is defined else '#' }}/attendance" 
                                   class="btn btn-secondary btn-sm">
                                       <i class="fas fa-qrcode"></i>
                                   </a>
                               </div>
                           </div>
                           {% endfor %}
                       {% else %}
                           <div class="text-center text-muted py-5">
                               <i class="fas fa-clipboard-xmark fa-3x mb-3"></i>
                               <p>No classes scheduled for today</p>
                           </div>
                       {% endif %}
                   </div>
               </div>

                <!-- Quick Actions -->
                <div class="quick-actions-card mb-4">
                    <h2 class="h4 font-weight-bold mb-4">Quick Actions</h2>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <a href="/class/new" class="quick-action-btn">
                                <i class="fas fa-plus-circle text-accent fa-2x mb-2"></i>
                                <span class="small">Add Class</span>
                            </a>
                        </div>
                        <div class="col-6 mb-3">
                            <a href="/announcement/new" class="quick-action-btn">
                                <i class="fas fa-bullhorn text-accent fa-2x mb-2"></i>
                                <span class="small">Announcement</span>
                            </a>
                        </div>
                        <div class="col-6 mb-3">
                            <a href="/coaches" class="quick-action-btn">
                                <i class="fas fa-users text-accent fa-2x mb-2"></i>
                                <span class="small">Coaches</span>
                            </a>
                        </div>
                        <div class="col-6 mb-3">
                            <a href="/payments" class="quick-action-btn">
                                <i class="fas fa-wallet text-accent fa-2x mb-2"></i>
                                <span class="small">Payments</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Announcements & Leaves -->
                <div class="updates-card">
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <h2 class="h4 font-weight-bold d-flex align-items-center mb-0">
                            <i class="fas fa-bullhorn text-accent mr-3"></i>
                            Updates
                        </h2>
                    </div>
                    <div style="max-height: 500px; overflow-y: auto;" id="updatesContainer">
                        {% if updates %}
                            {% for update in updates %}
                            <div class="update-item">
                                <div class="d-flex align-items-start">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background-color: var(--bg-secondary); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="fas {{ 'fa-bullhorn text-accent' if update.type is defined and update.type == 'announcement' else 'fa-calendar-xmark text-accent' }}"></i>
                                    </div>
                                    <div class="flex-grow-1 ml-3">
                                        <p class="mb-1">{{ update.message if update.message is defined else 'No message content' }}</p>
                                        <p class="small text-muted mb-0">{{ update.time if update.time is defined else 'Time not available' }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-bell-slash fa-3x mb-3"></i>
                                <p>No updates available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Initialize charts when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Set Chart.js defaults for dark theme
        if (window.Chart) {
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.borderColor = '#374151';
        }
        

        // Attendance Trend Chart
        const attendanceCtx = document.getElementById('attendanceChart');
        if (attendanceCtx && window.Chart) {
            const attendanceLabels = {{ attendance_labels | tojson if attendance_labels is defined else '[]' | safe }};
            const attendanceData = {{ attendance_data | tojson if attendance_data is defined else '[]' | safe }};
            
            if (attendanceLabels.length > 0 && attendanceData.length > 0) {
                new Chart(attendanceCtx, {
                    type: 'line',
                    data: {
                        labels: attendanceLabels,
                        datasets: [{
                            label: 'Attendance Rate',
                            data: attendanceData,
                            borderColor: '#a1de56',
                            backgroundColor: 'rgba(161, 222, 86, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    color: '#374151'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } else {
                attendanceCtx.parentElement.innerHTML = '<div class="text-center text-muted py-5"><i class="fas fa-chart-line fa-3x mb-3"></i><p>No attendance data available</p></div>';
            }
        }

        // Revenue Chart
        const revenueCtx = document.getElementById('revenueChart');
        if (revenueCtx && window.Chart) {
            const revenueLabels = {{ revenue_labels | tojson if revenue_labels is defined else '[]' | safe }};
            const revenueData = {{ revenue_data | tojson if revenue_data is defined else '[]' | safe }};
            
            if (revenueLabels.length > 0 && revenueData.length > 0) {
                new Chart(revenueCtx, {
                    type: 'bar',
                    data: {
                        labels: revenueLabels,
                        datasets: [{
                            label: 'Revenue',
                            data: revenueData,
                            backgroundColor: '#4caf50',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#374151'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } else {
                revenueCtx.parentElement.innerHTML = '<div class="text-center text-muted py-5"><i class="fas fa-chart-bar fa-3x mb-3"></i><p>No revenue data available</p></div>';
            }
        }
    });
</script>
{% endblock %}