{% extends "base.html" %}

{% block title %}Create Post - {{ organization.name }}{% endblock %}

{% block content %}
<div class="create-post-page">
    <div class="page-header-modern">
        <div class="page-header-content">
            <div class="page-title-section">
                <h1 class="page-title-modern">
                    <svg class="page-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Create New Post
                </h1>
                <p class="page-subtitle-modern">Share updates, tips, and announcements with your organization</p>
            </div>
            <div class="page-actions">
                <a href="{{ url_for('feed.feed_page') }}" class="btn btn-secondary">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Feed
                </a>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="create-post-content">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="content-card-modern">
                    <form method="POST" id="createPostForm" enctype="multipart/form-data">
                        <div class="card-body-modern">
                            <!-- Post Type -->
                            <div class="mb-4">
                                <label for="post_type" class="form-label">Post Type *</label>
                                <select class="form-select select2" id="post_type" name="post_type" required data-placeholder="Select post type">
                                    <option value="announcement" {% if request.args.get('type') == 'announcement' %}selected{% endif %}>Announcement</option>
                                    <option value="tip" {% if request.args.get('type') == 'tip' %}selected{% endif %}>Training Tip</option>
                                    <option value="event" {% if request.args.get('type') == 'event' %}selected{% endif %}>Event</option>
                                    <option value="achievement" {% if request.args.get('type') == 'achievement' %}selected{% endif %}>Achievement</option>
                                    <option value="general" {% if request.args.get('type') == 'general' %}selected{% endif %}>General</option>
                                </select>
                                <div class="form-text">Choose the type that best describes your post</div>
                            </div>

                            <!-- Title -->
                            <div class="mb-4">
                                <label for="title" class="form-label">Title *</label>
                                <input type="text" class="form-control" id="title" name="title" required 
                                       placeholder="Enter a clear, descriptive title..." maxlength="200">
                                <div class="form-text">5-200 characters</div>
                            </div>

                            <!-- Content -->
                            <div class="mb-4">
                                <label for="content" class="form-label">Content *</label>
                                <textarea class="form-control" id="content" name="content" rows="8" required 
                                          placeholder="Share your message, tips, or announcement..."></textarea>
                                <div class="form-text">10-5000 characters</div>
                            </div>


                            <!-- Tags -->
                            <div class="mb-4">
                                <label for="tags" class="form-label">Tags</label>
                                <input type="text" class="form-control" id="tags" name="tags" 
                                       placeholder="Enter tags separated by commas...">
                                <div class="form-text">Optional: Use hashtags to make your post discoverable (e.g., training, beginner, advanced)</div>
                            </div>

                            <!-- Visibility -->
                            <div class="mb-4">
                                <label for="visibility" class="form-label">Visibility</label>
                                <select class="form-select select2" id="visibility" name="visibility" data-placeholder="Select visibility">
                                    <option value="public" selected>Public - All organization members</option>
                                    <option value="students_only">Students Only</option>
                                    <option value="coaches_only">Coaches Only</option>
                                </select>
                                <div class="form-text">Choose who can see this post</div>
                            </div>
                            
                            <!-- Featured images -->
                            <div class="mb-4">
                                <label for="featured_images" class="form-label">Featured Images</label>
                                <input type="file" class="form-control" id="featured_images" name="featured_images" multiple accept="image/*">
                            </div>

                            <!-- Preview Section -->
                            <div class="post-preview-section" style="display: none;">
                                <hr class="my-4">
                                <h6 class="mb-3">
                                    <svg class="me-1" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                    Preview
                                </h6>
                                <div id="postPreview" class="post-preview-card">
                                    <!-- Preview content will be generated here -->
                                </div>
                            </div>

                            <!-- Class assciated -->
                            <div class="mb-4">
                                <label for="associated_class" class="form-label">Associated Class</label>
                                <select class="form-select select2" id="associated_class" name="associated_class" data-placeholder="Select associated class">
                                    <option value="">Select a class</option>
                                    {% for class in classes %}
                                        <option value="{{ class._id }}">{{ class.title }} {{class.scheduled_at.strftime('%b %d, %Y at %I:%M %p')}}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Optional: Select a class to associate with this post. Viewers will see a option to book the class.</div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="card-footer-modern">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="form-actions-left">
                                    <button type="button" class="btn btn-outline-secondary" id="previewBtn">
                                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        Preview
                                    </button>
                                </div>
                                <div class="form-actions-right">
                                    <a href="{{ url_for('feed.feed_page') }}" class="btn btn-secondary me-2">Cancel</a>
                                    <button type="submit" class="btn btn-primary">
                                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                        </svg>
                                        Publish Post
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar Tips -->
            <div class="col-lg-4">
                <div class="content-card-modern">
                    <div class="card-header-modern">
                        <h5 class="card-title-modern">
                            <svg class="card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            Writing Tips
                        </h5>
                    </div>
                    <div class="card-body-modern">
                        <div class="tips-list">
                            <div class="tip-item">
                                <div class="tip-title">Be Clear & Concise</div>
                                <div class="tip-description">Use simple language and get straight to the point</div>
                            </div>
                            <div class="tip-item">
                                <div class="tip-title">Use Engaging Titles</div>
                                <div class="tip-description">Make your title descriptive and attention-grabbing</div>
                            </div>
                            <div class="tip-item">
                                <div class="tip-title">Add Relevant Tags</div>
                                <div class="tip-description">Help others find your content with appropriate tags</div>
                            </div>
                            <div class="tip-item">
                                <div class="tip-title">Choose the Right Type</div>
                                <div class="tip-description">Select the post type that best matches your content</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Create Post Page Styles */
.create-post-page {
    background: var(--bg-primary);
    min-height: 100vh;
    padding: 0;
}

.page-header-modern {
    background: var(--card-bg);
    border-bottom: 1px solid var(--border-primary);
    padding: 2rem 0;
    margin-bottom: 2rem;
}

.page-header-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 2rem;
}

.page-title-section {
    flex: 1;
}

.page-title-modern {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.page-icon {
    width: 2rem;
    height: 2rem;
    color: var(--accent-primary);
}

.page-subtitle-modern {
    font-size: 1rem;
    color: var(--text-secondary);
    margin: 0;
}

.page-actions {
    display: flex;
    gap: 0.75rem;
    flex-shrink: 0;
}

.create-post-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

.content-card-modern {
    background: var(--card-bg);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
}

.card-body-modern {
    padding: 2rem;
}

.card-footer-modern {
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-primary);
    padding: 1.5rem 2rem;
}

.form-actions-left {
    flex: 1;
}

.form-actions-right {
    display: flex;
    gap: 0.75rem;
}

/* Post Preview */
.post-preview-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: 1.5rem;
}

.preview-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.preview-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--accent-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1rem;
}

.preview-author-info h6 {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
}

.preview-author-info small {
    color: var(--text-secondary);
    font-size: 0.8rem;
}

.preview-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
}

.preview-content {
    color: var(--text-primary);
    line-height: 1.6;
    margin-bottom: 1rem;
    white-space: pre-wrap;
}

.preview-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.preview-tag {
    background: var(--accent-primary);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.8rem;
    font-weight: 500;
}

.preview-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-md);
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: capitalize;
}

.preview-badge.announcement { background: var(--primary); color: white; }
.preview-badge.tip { background: var(--success); color: white; }
.preview-badge.event { background: var(--warning); color: var(--text-primary); }
.preview-badge.achievement { background: var(--info); color: white; }
.preview-badge.general { background: var(--secondary); color: white; }

/* Tips Sidebar */
.card-header-modern {
    padding: 1.5rem 1.5rem 0;
    border-bottom: none;
}

.card-title-modern {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.card-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--accent-primary);
}

.tips-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.tip-item {
    border-left: 3px solid var(--accent-primary);
    padding-left: 1rem;
}

.tip-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
}

.tip-description {
    color: var(--text-secondary);
    font-size: 0.85rem;
    line-height: 1.4;
}

/* Responsive Design */
@media (max-width: 992px) {
    .page-header-content {
        flex-direction: column;
        align-items: stretch;
        gap: 1.5rem;
    }
    
    .page-actions {
        justify-content: flex-start;
    }
}

@media (max-width: 768px) {
    .page-header-modern {
        padding: 1.5rem 0;
    }
    
    .page-title-modern {
        font-size: 1.5rem;
    }
    
    .card-body-modern {
        padding: 1.5rem;
    }
    
    .card-footer-modern {
        padding: 1rem 1.5rem;
        flex-direction: column;
        gap: 1rem;
    }
    
    .form-actions-left {
        flex: none;
    }
    
    .form-actions-right {
        justify-content: stretch;
    }
    
    .form-actions-right .btn {
        flex: 1;
    }
}

@media (max-width: 576px) {
    .create-post-content {
        padding: 0 0.75rem;
    }
    
    .page-header-content {
        padding: 0 0.75rem;
    }
    
    .page-actions {
        flex-direction: column;
        gap: 0.5rem;
    }
}

/* Dark Mode Support */
@media (prefers-color-scheme: dark) {
    .create-post-page {
        background: var(--bg-primary, #1a1a1a);
    }
    
    .content-card-modern {
        background: var(--bg-card, #2d2d2d);
        border-color: var(--border-primary, #404040);
    }
    
    .page-header-modern {
        background: var(--bg-card, #2d2d2d);
        border-color: var(--border-primary, #404040);
    }
    
    .card-footer-modern {
        background: var(--bg-secondary, #3a3a3a);
        border-color: var(--border-primary, #404040);
    }
    
    .post-preview-card {
        background: var(--bg-secondary, #3a3a3a);
        border-color: var(--border-primary, #404040);
    }
}

/* Explicit Dark Mode Support */
[data-theme="dark"] .create-post-page {
    background: var(--bg-primary);
}

[data-theme="dark"] .content-card-modern,
[data-theme="dark"] .page-header-modern {
    background: var(--bg-card);
    border-color: var(--border-primary);
}

[data-theme="dark"] .card-footer-modern {
    background: var(--bg-secondary);
    border-color: var(--border-primary);
}

[data-theme="dark"] .post-preview-card {
    background: var(--bg-secondary);
    border-color: var(--border-primary);
}

[data-theme="dark"] .tip-item {
    border-left-color: var(--accent-primary);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const previewBtn = document.getElementById('previewBtn');
    const previewSection = document.querySelector('.post-preview-section');
    const previewContainer = document.getElementById('postPreview');
    const form = document.getElementById('createPostForm');
    
    let isPreviewMode = false;
    
    // Preview functionality
    previewBtn.addEventListener('click', function() {
        if (!isPreviewMode) {
            showPreview();
        } else {
            hidePreview();
        }
    });
    
    function showPreview() {
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();
        const postType = document.getElementById('post_type').value;
        const category = document.getElementById('category').value.trim();
        const tags = document.getElementById('tags').value.trim();
        
        if (!title || !content) {
            showNotification('Please fill in the title and content to preview your post.', 'warning');
            return;
        }
        
        // Generate preview HTML
        const authorName = '{{ session.name }}';
        const authorInitials = authorName.split(' ').map(n => n[0]).join('').toUpperCase();
        const now = new Date().toLocaleString();
        
        const tagsArray = tags ? tags.split(',').map(tag => tag.trim().replace(/^#?/, '#')) : [];
        const tagsHtml = tagsArray.map(tag => `<span class="preview-tag">${tag}</span>`).join('');
        
        previewContainer.innerHTML = `
            <div class="preview-header">
                <div class="preview-avatar">${authorInitials}</div>
                <div class="preview-author-info">
                    <h6>${authorName}</h6>
                    <small>{{ session.role.replace('_', ' ').title() }} • ${now}</small>
                </div>
                <div class="ms-auto">
                    <span class="preview-badge ${postType}">${postType.charAt(0).toUpperCase() + postType.slice(1)}</span>
                </div>
            </div>
            <div class="preview-title">${escapeHtml(title)}</div>
            <div class="preview-content">${escapeHtml(content)}</div>
            ${tagsHtml ? `<div class="preview-tags">${tagsHtml}</div>` : ''}
            ${category ? `<small class="text-muted"><strong>Category:</strong> ${escapeHtml(category)}</small>` : ''}
        `;
        
        previewSection.style.display = 'block';
        previewBtn.innerHTML = `
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L12 12m-3.122-3.122l-3-3m6.122 6.122L15 15"></path>
            </svg>
            Hide Preview
        `;
        isPreviewMode = true;
        
        // Scroll to preview
        previewSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    function hidePreview() {
        previewSection.style.display = 'none';
        previewBtn.innerHTML = `
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            Preview
        `;
        isPreviewMode = false;
    }
    
    // Form submission
    form.addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Publishing...';
        
        // Re-enable button after a delay if form doesn't submit
        setTimeout(() => {
            if (submitBtn.disabled) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        }, 5000);
    });
    
    // Character counters
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');
    
    function updateCharCounter(input, min, max) {
        const length = input.value.length;
        const counter = input.nextElementSibling;
        if (counter && counter.classList.contains('form-text')) {
            let status = '';
            if (length < min) {
                status = ` (${min - length} more needed)`;
                counter.style.color = 'var(--danger)';
            } else if (length > max) {
                status = ` (${length - max} over limit)`;
                counter.style.color = 'var(--danger)';
            } else {
                status = ` (${length}/${max})`;
                counter.style.color = 'var(--text-secondary)';
            }
            counter.textContent = counter.textContent.replace(/\s*\([^)]*\)$/, '') + status;
        }
    }
    
    titleInput.addEventListener('input', function() {
        updateCharCounter(this, 5, 200);
    });
    
    contentInput.addEventListener('input', function() {
        updateCharCounter(this, 10, 5000);
    });
    
    // Utility functions
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    function showNotification(message, type = 'info') {
        const toast = document.createElement('div');
        const alertClass = type === 'warning' ? 'alert-warning' : 'alert-info';
        toast.className = `toast-notification alert ${alertClass} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <div>${message}</div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}
