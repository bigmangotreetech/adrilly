{% extends "base.html" %}

{% block title %}Login - botle Sports Coaching{% endblock %}

{% block head %}
<style>
    /* Minimal login page styles - clean and balanced */
    .login-container {
        margin: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-primary);
        padding: var(--spacing-lg);
        width: fit-content;
        border-radius: 10px;
        margin-top: 20vh;
        min-width: 450px;
        box-shadow: 0px -17px 50px 5px #232323;
    }

    .login-card {
        background: transparent;
        border: none;
        box-shadow: none;
        padding: var(--spacing-xl);
        width: 100%;
        max-width: 450px;
        font-weight: 400 !important;
    }

    .login-card * {
        font-weight: 400 !important;
    }

    .login-header {
        text-align: left;
        margin-bottom: var(--spacing-xl);
        border-radius: 10px;
    }

    .login-title {
        margin-bottom: var(--spacing-md);
        font-size: 2.25rem;
        font-weight: 400 !important;
    }

    .login-subtitle {
        margin-bottom: var(--spacing-lg);
        font-size: 1rem;
        opacity: 0.7;
    }

    /* Minimal steps */
    .auth-steps {
        display: flex;
        justify-content: center;
        margin-bottom: var(--spacing-lg);
        gap: var(--spacing-lg);
    }

    .step {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-sm);
        background: transparent;
        border: none;
        font-size: 0.9rem;
        color: var(--text-muted);
        opacity: 0.6;
        transition: all 0.3s ease;
    }

    .step.active {
        opacity: 1;
        color: var(--text-primary);
        background: var(--bg-secondary);
    }

    /* Form spacing */
    .form-group {
        padding: 0;
        margin: 0 0 var(--spacing-lg) 0;
    }

    .form-label {
        margin-bottom: var(--spacing-sm);
        font-size: 0.9rem;
        font-weight: 400 !important;
    }

    .form-control {
        border: none;
        border-bottom: 1px solid var(--border-primary);
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        background: transparent;
        padding: var(--spacing-sm);
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }

    .form-control:focus {
        border-bottom-color: var(--accent-primary);
        box-shadow: none;
        background: transparent;
    }

    .form-control:hover {
        border-bottom-color: var(--text-secondary);
    }

    /* Alerts and verification info */
    .login-card .alert {
        border: none;
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }

    .verification-info {
        background: transparent;
        border: none;
        padding: var(--spacing-md) 0;
        margin-bottom: var(--spacing-lg);
        font-size: 0.95rem;
        color: var(--text-secondary);
        text-align: center;
    }

    .verification-button {
        margin-top: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
        border: none;
        border-radius: var(--radius-sm);
        background: var(--accent-primary);
        padding: var(--spacing-md) var(--spacing-xl);
        font-size: 0.95rem;
        font-weight: 400 !important;
        transition: all 0.3s ease;
        position: relative;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .verification-button:hover {
        background: var(--accent-hover);
        transform: none;
        box-shadow: none;
    }

    .verification-button:disabled {
        opacity: 0.8;
        cursor: not-allowed;
    }

    .verification-button .btn-text {
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .verification-button.loading .btn-text {
        opacity: 0;
        transform: scale(0.8);
    }

    .verification-button .loading {
        position: absolute;
        opacity: 0;
        transition: opacity 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .verification-button.loading .loading {
        opacity: 1;
    }

    /* Spinner animation */
    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .auth-footer {
        text-align: center;
        margin-top: var(--spacing-lg);
        padding-top: var(--spacing-md);
    }

    .auth-footer p {
        font-size: 0.9rem;
        margin: 0;
    }

    .auth-footer a {
        color: var(--accent-primary);
        text-decoration: none;
        font-weight: 400 !important;
    }

    .auth-footer a:hover {
        text-decoration: underline;
    }

    /* Resend button */
    .btn-outline {
        background: transparent;
        border: 1px solid var(--text-muted);
        color: var(--text-secondary);
        border-radius: var(--radius-sm);
        padding: var(--spacing-xs) var(--spacing-md);
        font-weight: 400 !important;
        font-size: 0.85rem;
    }

    .btn-outline:hover {
        background: transparent;
        border-color: var(--text-primary);
        color: var(--text-primary);
        transform: none;
        box-shadow: none;
    }

    /* Remove step numbers - keep it minimal */
    .step-number {
        display: none;
    }

    /* Login mode toggle */
    .login-mode-toggle {
        display: flex;
        justify-content: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
        padding: var(--spacing-xs);
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
    }

    .mode-button {
        flex: 1;
        padding: var(--spacing-sm) var(--spacing-md);
        border: none;
        background: transparent;
        color: var(--text-muted);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 400 !important;
        transition: all 0.3s ease;
    }

    .mode-button.active {
        background: var(--accent-primary);
        color: white;
    }

    .mode-button:hover {
        color: var(--text-primary);
    }

    .mode-button.active:hover {
        color: white;
    }

    /* Hidden class */
    .hidden {
        display: none !important;
    }

    /* Micro animations for form fields */
    .form-group {
        opacity: 0;
        transform: translateY(-20px);
        animation: slideDown 0.5s ease-out forwards;
    }

    .form-group:nth-child(1) {
        animation-delay: 0.1s;
    }

    .form-group:nth-child(2) {
        animation-delay: 0.2s;
    }

    .form-group:nth-child(3) {
        animation-delay: 0.3s;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Animate form container */
    .login-card {
        animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    /* Login header animation */
    .login-header {
        animation: scaleIn 0.5s ease-out;
    }

    @keyframes scaleIn {
        from {
            opacity: 0;
            transform: scale(0.5);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
</style>
{% endblock %}

{% block login_content %}
<div class="login-container">
    <div class="login-card">
        <div class="login-header text-center">
            <img width="100" src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" class="logo">
        </div>
        
        <!-- Login Mode Toggle -->
        <div>Login with</div>
        <div class="login-mode-toggle">
            <button type="button" class="mode-button" id="otpModeBtn" onclick="switchMode('otp')">
                OTP
            </button>
            <button type="button" class="mode-button active" id="passwordModeBtn" onclick="switchMode('password')">
                Password
            </button>
        </div>
        
        <div class="auth-steps" style="display: none;">
            <div class="step active">
                <span>Phone Number</span>
            </div>
            <div class="step" id="step2">
                <span>Verification</span>
            </div>
        </div>
        
        <!-- Password Login Form -->
        <div id="passwordLoginForm">
            <form id="passwordForm" method="POST" action="{{ url_for('web.login_password') }}">
                <div class="form-group">
                    <label for="username" class="form-label">Email or Phone Number</label>
                    <input type="text" class="form-control" id="username" name="username" 
                            placeholder="" required>
                </div>
                
                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" name="password" 
                            placeholder="" required>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block verification-button">
                        <span class="btn-text">Login</span>
                        <span class="loading">
                            <span class="spinner"></span>
                        </span>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- OTP Login Forms -->
        <div id="otpLoginForm" class="hidden">
            <!-- Step 1: Phone Number Entry -->
            <div id="phoneStep">
                <form id="phoneForm" method="POST" action="{{ url_for('web.send_verification') }}">
                    <div class="form-group">
                        <label for="phone_number" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                                required>
                    </div>
                    
                    <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block verification-button">
                        <span class="btn-text">Send Verification Code</span>
                        <span class="loading">
                            <span class="spinner"></span>
                        </span>
                    </button>
                    </div>
                </form>
            </div>
            
            <!-- Step 2: Verification Code Entry -->
            <div id="verificationStep" class="hidden">
                <form id="verificationForm" method="POST" action="{{ url_for('web.verify_code') }}">
                    <input type="hidden" id="hidden_phone" name="phone_number">
                    
                    <div class="form-group">
                        <label for="verification_code" class="form-label">Enter 6-digit Verification Code</label>
                        <input type="text" class="form-control" id="verification_code" name="verification_code" 
                                maxlength="6" required>
                    </div>
                    
                    <div class="form-group">
                    <button type="submit" class="btn btn-primary verification-button btn-block">
                        <span class="btn-text">Verify & Login</span>
                        <span class="loading">
                            <span class="spinner"></span>
                        </span>
                    </button>
                    </div>
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-outline btn-sm" onclick="resendCode()">
                            Resend Code
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="auth-footer d-none">
            <p>Don't have an account? <a href="{{ url_for('web.register') }}">Register here</a></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Login mode toggle functionality
function switchMode(mode) {
    const otpBtn = document.getElementById('otpModeBtn');
    const passwordBtn = document.getElementById('passwordModeBtn');
    const otpForm = document.getElementById('otpLoginForm');
    const passwordForm = document.getElementById('passwordLoginForm');
    
    if (mode === 'otp') {
        otpBtn.classList.add('active');
        passwordBtn.classList.remove('active');
        otpForm.classList.remove('hidden');
        passwordForm.classList.add('hidden');
        
        // Reset OTP form to phone step
        document.getElementById('phoneStep').classList.remove('hidden');
        document.getElementById('verificationStep').classList.add('hidden');
        document.getElementById('step2').classList.remove('active');
    } else {
        passwordBtn.classList.add('active');
        otpBtn.classList.remove('active');
        passwordForm.classList.remove('hidden');
        otpForm.classList.add('hidden');
    }
}

// Password form submission
document.getElementById('passwordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Show loading state with smooth animation
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    
    try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Redirect to dashboard
            window.location.href = result.redirect || '/dashboard';
        } else {
            // Reset button state on error
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
            showMessage(result.error || 'Invalid username or password', 'error');
        }
    } catch (error) {
        // Reset button state on error
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
        showMessage('Network error. Please try again.', 'error');
    }
});

// Phone number formatting (only when OTP mode is active)
function setupPhoneNumberFormatting() {
    const phoneInput = document.getElementById('phone_number');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            // Split phone number into two parts of 5 digits each
            if (value.length > 5) {
                value = value.slice(0, 5) + ' ' + value.slice(5, 10);
            }
            e.target.value = value;
        });
    }
}

// Setup phone formatting when page loads (if OTP form is available)
setupPhoneNumberFormatting();

// Phone form submission
document.getElementById('phoneForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Show loading state with smooth animation
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    
    try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Move to verification step
            document.getElementById('phoneStep').classList.add('hidden');
            document.getElementById('verificationStep').classList.remove('hidden');
            document.getElementById('step2').classList.add('active');
            document.getElementById('hidden_phone').value = formData.get('phone_number');
            
            // Reset button state after navigation
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
            
            // Show success message
            if (result.message) {
                showMessage(result.message, 'success');
            }
        } else {
            // Reset button state on error
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
            showMessage(result.error || 'Failed to send verification code', 'error');
        }
    } catch (error) {
        // Reset button state on error
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
        showMessage('Network error. Please try again.', 'error');
    }
});

// Verification form submission
document.getElementById('verificationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Show loading state with smooth animation
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    
    try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Redirect to dashboard
            window.location.href = result.redirect || '/dashboard';
        } else {
            // Reset button state on error
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
            showMessage(result.error || 'Invalid verification code', 'error');
        }
    } catch (error) {
        // Reset button state on error
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
        showMessage('Network error. Please try again.', 'error');
    }
});

// Resend code function
async function resendCode() {
    const phoneNumber = document.getElementById('hidden_phone').value;
    
    try {
        const response = await fetch('{{ url_for("web.send_verification") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'phone_number=' + encodeURIComponent(phoneNumber)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showMessage('Verification code sent again', 'success');
        } else {
            showMessage(result.error || 'Failed to resend code', 'error');
        }
    } catch (error) {
        showMessage('Network error. Please try again.', 'error');
    }
}

// Show message function
function showMessage(message, type) {
    // Remove existing messages
    const existingMessages = document.querySelectorAll('.alert');
    existingMessages.forEach(msg => msg.remove());
    
    // Create new message
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type}`;
    alertDiv.textContent = message;
    
    // Insert message
    const loginCard = document.querySelector('.login-card');
    const firstChild = loginCard.querySelector('.login-header').nextElementSibling;
    loginCard.insertBefore(alertDiv, firstChild);
    
    // Auto-remove after 5 seconds
    // setTimeout(() => {
    //     if (alertDiv.parentNode) {
    //         alertDiv.remove();
    //     }
    // }, 5000);
}

// Auto-format verification code and auto-submit when 6 digits are entered
document.getElementById('verification_code').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
    
    // Auto-submit when 6 digits are entered
    if (e.target.value.length === 6) {
        document.getElementById('verificationForm').dispatchEvent(new Event('submit'));
    }
});
</script>
{% endblock %} 